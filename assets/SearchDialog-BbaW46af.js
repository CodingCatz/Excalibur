import{aE as K,aF as U,aG as z,aB as B,aH as Y,r as u,j as r,aI as G,aJ as H,S as Q,aK as V,aL as R,aM as A,aN as P,aO as J,aP as W}from"./index-BO31ZqPg.js";const M=30,k=3;function v(s){if(!s||typeof s!="object")return"";const t=s;return t.type==="text"&&typeof t.text=="string"?t.text:Array.isArray(t.content)?t.content.map(v).join(""):""}function X(s){if(!s.content)return[];const t=s.content;return t.content?t.content.map(e=>v(e)).filter(Boolean):[v(s.content)]}function Z(s){const t=[];for(const e of s.nodes){if(e.data.label&&t.push(e.data.label),e.data.description&&t.push(e.data.description),Array.isArray(e.data.subNodes))for(const n of e.data.subNodes)n.data?.label&&t.push(n.data.label);if(Array.isArray(e.data.subEdges))for(const n of e.data.subEdges)n.label&&t.push(n.label)}for(const e of s.edges)e.label&&t.push(e.label);return t}function q(s){const t=[];for(const e of s.nodes)switch(e.type){case"text":e.data.textPreview&&t.push(e.data.textPreview),e.data.character&&t.push(e.data.character);break;case"choice":e.data.prompt&&t.push(e.data.prompt);for(const n of e.data.options)n.textPreview&&t.push(n.textPreview);break;case"condition":e.data.description&&t.push(e.data.description);break;case"entry":e.data.label&&t.push(e.data.label);break;case"exit":e.data.label&&t.push(e.data.label);break}return t}function ee(s){const t=[],e=s.schema.columns.filter(n=>n.type==="text"||n.type==="select"||n.type==="i18n-key").map(n=>n.id);for(const n of s.rows)for(const c of e){const i=n.cells[c];typeof i=="string"&&i&&t.push(i)}return t}function te(s){const t=[];for(const e of s.assets){t.push(e.name),e.notes&&t.push(e.notes);for(const n of e.tags)t.push(n)}return t}function se(s){const t=[];for(const e of s.entries)if(t.push(e.key),e.value&&t.push(e.value),e.translations)for(const n of Object.values(e.translations))n&&t.push(n);return t}function ae(s){const t=[];for(const e of s.nodes)if(e.data.label&&t.push(e.data.label),e.data.text&&t.push(e.data.text),e.data.placeholder&&t.push(e.data.placeholder),e.data.clickAction&&t.push(e.data.clickAction),e.data.items)for(const n of e.data.items)n&&t.push(n);return t}function ne(s){switch(s.type){case"gdd":return X(s);case"flowchart":case"statemachine":return Z(s);case"dialogue":return q(s);case"datatable":return ee(s);case"asset-registry":return te(s);case"i18n":return se(s);case"wireframe":return ae(s);default:return[]}}function re(s,t,e,n,c){const i=[],f=s.toLowerCase();let g=0;for(;g<f.length&&i.length<k;){const d=f.indexOf(t,g);if(d===-1)break;const x=Math.max(0,d-M),y=Math.min(s.length,d+t.length+M),m=(x>0?"...":"")+s.slice(x,y)+(y<s.length?"...":""),h=x>0?3:0;i.push({docId:e,docTitle:n,docType:c,snippet:m,matchStart:d-x+h,matchEnd:d-x+h+t.length}),g=d+t.length}return i}function oe(s,t){const e=t.toLowerCase(),n=ne(s),c=[];s.title.toLowerCase().includes(e)&&c.push({docId:s.id,docTitle:s.title,docType:s.type,snippet:s.title,matchStart:s.title.toLowerCase().indexOf(e),matchEnd:s.title.toLowerCase().indexOf(e)+e.length});for(const i of n){if(c.length>=k)break;const f=re(i,e,s.id,s.title,s.type);c.push(...f)}return c.slice(0,k)}async function ce(s,t){if(!t.trim())return[];const e=await K.documents.where("projectId").equals(s).toArray(),n=[];for(const c of e)if(n.push(...oe(c,t)),n.length>=30)break;return n.slice(0,30)}const ie=["gdd","flowchart","statemachine","dialogue","datatable","asset-registry","i18n"];function ue({open:s,onOpenChange:t}){const{id:e}=U(),n=z(),c=B(),{documents:i}=Y(),[f,g]=u.useState(""),[d,x]=u.useState([]),[y,m]=u.useState(!1),[h,b]=u.useState(0),I=u.useRef(null),S=u.useRef(null),E=u.useRef(void 0);u.useEffect(()=>{s&&(g(""),x([]),b(0),setTimeout(()=>I.current?.focus(),0))},[s]);const O=u.useCallback(a=>{if(!e||!a.trim()){x([]),m(!1);return}m(!0),ce(e,a).then(o=>{x(o),m(!1),b(0)})},[e]);function _(a){if(g(a),clearTimeout(E.current),!a.trim()){x([]),m(!1);return}m(!0),E.current=setTimeout(()=>O(a),300)}const T=u.useMemo(()=>[...i].sort((a,o)=>o.updatedAt-a.updatedAt).slice(0,8),[i]),L=u.useMemo(()=>{const a=[],o=new Set;for(const p of ie){const l=d.filter(j=>j.docType===p);l.length>0&&!o.has(p)&&(o.add(p),a.push({type:p,items:l}))}return a},[d]),w=u.useMemo(()=>f.trim()?d.map(a=>({docId:a.docId,docType:a.docType,docTitle:a.docTitle})):T.map(a=>({docId:a.id,docType:a.type,docTitle:a.title})),[f,d,T]);function N(a,o){if(!e)return;const p=W[o]??"gdd";n(`/project/${e}/${p}/${a}`),t(!1)}function $(a){if(a.key==="ArrowDown")a.preventDefault(),b(o=>Math.min(o+1,w.length-1)),D(h+1);else if(a.key==="ArrowUp")a.preventDefault(),b(o=>Math.max(o-1,0)),D(h-1);else if(a.key==="Enter"){a.preventDefault();const o=w[h];o&&N(o.docId,o.docType)}}function D(a){S.current?.querySelector(`[data-index="${a}"]`)?.scrollIntoView({block:"nearest"})}const F=!f.trim()&&T.length>0;return r.jsx(G,{open:s,onOpenChange:t,children:r.jsxs(H,{showCloseButton:!1,className:"gap-0 p-0 sm:max-w-lg overflow-hidden",onKeyDown:$,children:[r.jsxs("div",{className:"flex items-center gap-2 border-b px-3",children:[r.jsx(Q,{className:"size-4 shrink-0 text-muted-foreground"}),r.jsx("input",{ref:I,className:"flex-1 bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground",placeholder:c("search.placeholder"),value:f,onChange:a=>_(a.target.value)}),y&&r.jsx(V,{className:"size-4 shrink-0 animate-spin text-muted-foreground"}),r.jsx("kbd",{className:"hidden rounded bg-muted px-1.5 py-0.5 text-[10px] font-medium text-muted-foreground sm:inline",children:"ESC"})]}),r.jsxs("div",{ref:S,className:"max-h-80 overflow-y-auto p-1",children:[F&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"px-2 py-1.5 text-xs font-medium text-muted-foreground",children:c("search.recentDocs")}),T.map((a,o)=>{const p=R[a.type]??A;return r.jsxs("button",{"data-index":o,className:P("flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-left text-sm",h===o?"bg-accent text-accent-foreground":"hover:bg-accent/50"),onClick:()=>N(a.id,a.type),onMouseEnter:()=>b(o),children:[r.jsx(p,{className:"size-4 shrink-0 text-muted-foreground"}),r.jsx("span",{className:"truncate",children:a.title})]},a.id)})]}),f.trim()&&!y&&d.length>0&&r.jsx(r.Fragment,{children:L.map(a=>{const o=R[a.type]??A,p=J[a.type];return r.jsxs("div",{children:[r.jsx("div",{className:"px-2 py-1.5 text-xs font-medium text-muted-foreground",children:p?c(p):a.type}),a.items.map(l=>{const j=w.findIndex(C=>C.docId===l.docId&&C.docType===l.docType);return r.jsxs("button",{"data-index":j,className:P("flex w-full flex-col gap-0.5 rounded-md px-2 py-1.5 text-left",h===j?"bg-accent text-accent-foreground":"hover:bg-accent/50"),onClick:()=>N(l.docId,l.docType),onMouseEnter:()=>b(j),children:[r.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[r.jsx(o,{className:"size-3.5 shrink-0 text-muted-foreground"}),r.jsx("span",{className:"truncate font-medium",children:l.docTitle})]}),r.jsx(le,{snippet:l.snippet,matchStart:l.matchStart,matchEnd:l.matchEnd})]},`${l.docId}-${l.matchStart}-${l.snippet.slice(0,20)}`)})]},a.type)})}),f.trim()&&!y&&d.length===0&&r.jsx("div",{className:"px-2 py-6 text-center text-sm text-muted-foreground",children:c("search.noResults")})]}),r.jsxs("div",{className:"flex items-center justify-between border-t px-3 py-1.5 text-[10px] text-muted-foreground",children:[r.jsx("span",{children:c("search.hint")}),r.jsxs("span",{className:"flex gap-1",children:[r.jsx("kbd",{className:"rounded bg-muted px-1 py-0.5",children:"↑↓"}),r.jsx("kbd",{className:"rounded bg-muted px-1 py-0.5",children:"↵"})]})]})]})})}function le({snippet:s,matchStart:t,matchEnd:e}){const n=s.slice(0,t),c=s.slice(t,e),i=s.slice(e);return r.jsxs("span",{className:"truncate text-xs text-muted-foreground",children:[n,r.jsx("mark",{className:"rounded bg-yellow-200/70 px-0.5 text-foreground dark:bg-yellow-500/30",children:c}),i]})}export{ue as SearchDialog};
