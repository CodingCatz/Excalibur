const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/SimulatorOverlay-BJ108Cti.js","assets/index-BO31ZqPg.js","assets/index-DKWk5wku.css","assets/MermaidPreview-D18Aw_Pg.js","assets/useUndoRedoKeys-CBEPday8.js","assets/value-kwUSg1GE.js","assets/useDocumentSwitch-B2mv6tdu.js","assets/useUndoRedoKeys-BZV40eAE.css","assets/createHistorySlice-BPQGD6VD.js","assets/waypoints-Bd-eVwOl.js","assets/copy-Nwklh3jE.js","assets/zap-CBg9d_PT.js","assets/chart-column-DBcOFAjW.js","assets/useAutoSave-CfhZAdWB.js","assets/useReadmeHelp-Dp5zdwnQ.js","assets/tag-D7WN3Vb4.js","assets/minus-Dwx08JAk.js","assets/i18n-BculLh7l.js","assets/message-circle-oZ-ClJn5.js","assets/code-CKSfqU-M.js"])))=>i.map(i=>d[i]);
import{c as G,aZ as We,a_ as V,j as e,r as x,aB as A,bN as me,b3 as Oe,X as J,B as _,cZ as Ze,S as ae,I as C,cv as Z,ar as ee,bc as q,aF as Ke,b2 as Xe,cO as Ye,bL as Le,aH as Qe,cF as et,dz as tt,c4 as De,c_ as Me,c$ as st,d0 as at,dA as nt,dB as ot,bV as Ee,d1 as $e,bW as Ie,c1 as rt,c8 as lt,aM as it,c0 as ct,bX as dt,a$ as R,b0 as F,b1 as B,bQ as de,b6 as ut,b7 as xt,b8 as mt,ba as pt,b5 as gt}from"./index-BO31ZqPg.js";import{a as ht,b as ft,c as bt,H as $,P as I,i as jt,B as vt,f as yt,u as Nt,e as kt,R as Ct}from"./useUndoRedoKeys-CBEPday8.js";import{u as wt,I as St,T as zt}from"./useAutoSave-CfhZAdWB.js";import{u as _t,U as Dt,R as Mt,D as Et,S as $t}from"./useDocumentSwitch-B2mv6tdu.js";import{c as It,Z as Tt,M as Pt,a as Ot,S as Kt}from"./createHistorySlice-BPQGD6VD.js";import{T as Lt}from"./tag-D7WN3Vb4.js";import{W as At,S as qt,C as Vt,L as Rt}from"./waypoints-Bd-eVwOl.js";import{M as Ft}from"./minus-Dwx08JAk.js";import{M as Bt}from"./MermaidPreview-D18Aw_Pg.js";import{P as X,a as Y,b as ne,C as Ht}from"./useReadmeHelp-Dp5zdwnQ.js";import{I as Gt}from"./i18n-BculLh7l.js";import{U as Ae,Z as qe}from"./zap-CBg9d_PT.js";import{L as Jt,M as Ve}from"./message-circle-oZ-ClJn5.js";import{C as Ut}from"./code-CKSfqU-M.js";const Wt=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Zt=G("arrow-left",Wt);const Xt=[["path",{d:"M9 9.003a1 1 0 0 1 1.517-.859l4.997 2.997a1 1 0 0 1 0 1.718l-4.997 2.997A1 1 0 0 1 9 14.996z",key:"kmsa83"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],Yt=G("circle-play",Xt);const Qt=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["path",{d:"M16 8h.01",key:"cr5u4v"}],["path",{d:"M12 12h.01",key:"1mp3jc"}],["path",{d:"M8 16h.01",key:"18s6g9"}]],es=G("dice-3",Qt);const ts=[["circle",{cx:"12",cy:"18",r:"3",key:"1mpf1b"}],["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["circle",{cx:"18",cy:"6",r:"3",key:"1h7g24"}],["path",{d:"M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9",key:"1uq4wg"}],["path",{d:"M12 12v3",key:"158kv8"}]],ss=G("git-fork",ts);const as=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],Re=G("play",as);const ns=[["path",{d:"m18.84 12.25 1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71",key:"yqzxt4"}],["path",{d:"m5.17 11.75-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71",key:"4qinb0"}],["line",{x1:"8",x2:"8",y1:"2",y2:"5",key:"1041cp"}],["line",{x1:"2",x2:"5",y1:"8",y2:"8",key:"14m1p5"}],["line",{x1:"16",x2:"16",y1:"19",y2:"22",key:"rzdirn"}],["line",{x1:"19",x2:"22",y1:"16",y2:"16",key:"ox905f"}]],Fe=G("unlink",ns);const os=[["path",{d:"M8 21s-4-3-4-9 4-9 4-9",key:"uto9ud"}],["path",{d:"M16 3s4 3 4 9-4 9-4 9",key:"4w2vsq"}],["line",{x1:"15",x2:"9",y1:"9",y2:"15",key:"f7djnv"}],["line",{x1:"9",x2:"15",y1:"9",y2:"15",key:"1shsy8"}]],pe=G("variable",os);function rs(t){const a=t.split(/\r?\n/).map(d=>d.trim()).filter(Boolean),s=new Map,c=[];let o=0;function n(d,r){const u=s.get(d);if(u)return r&&u.label===d&&(u.label=r),u;const m={id:d,label:r||d};return s.set(d,m),m}function l(d){const r=d.match(/^(\w+)[\[\(\{]+(.+?)[\]\)\}]+$/);return r?{id:r[1],label:r[2]}:{id:d,label:d}}for(const d of a){if(/^(graph|flowchart)\s/i.test(d)||/^(subgraph|end|style|classDef|class|click|linkStyle)\b/i.test(d)||d.startsWith("%%"))continue;const r=d.match(/^(.+?)\s*(--+>|==+>|--+\||-.+-\>)\s*(?:\|(.+?)\|\s*)?(.+)$/)||d.match(/^(.+?)\s*--\s*(.+?)\s*--+>\s*(.+)$/);if(r){let m,j,b;r.length===4&&!r[0].includes("|")?(m=r[1].trim(),b=r[2].trim(),j=r[3].trim()):(m=r[1].trim(),b=r[3]?.trim(),j=r[4]?.trim()??r[3]?.trim());const h=l(m),g=l(j);n(h.id,h.label),n(g.id,g.label),c.push({id:`e-${o++}`,source:h.id,target:g.id,data:b?{condition:b}:void 0});continue}const u=l(d.replace(/;$/,"").trim());u.id&&n(u.id,u.label)}const i=[];let p=0;for(const d of s.values())i.push({id:d.id,type:"text",position:{x:200,y:80+p*120},data:{character:"",textKey:"",textPreview:d.label}}),p++;return{nodes:i,edges:c}}function ls(t){return t.map(({measured:a,...s})=>s)}function is(t){switch(t){case"entry":return{dialogueType:"entry",entryId:V(),label:"Start"};case"exit":return{dialogueType:"exit",exitId:V(),label:"End"};case"text":return{dialogueType:"text",character:"",textKey:"",textPreview:""};case"choice":return{dialogueType:"choice",options:[{id:V(),textKey:"",textPreview:"Option 1"},{id:V(),textKey:"",textPreview:"Option 2"}]};case"condition":return{dialogueType:"condition",expression:"",description:""};case"action":return{dialogueType:"action",actions:[]};case"random":return{dialogueType:"random",mode:"weighted"}}}const w=We()((...t)=>{const[a,s]=t;return{...It(o=>({nodes:ls(o.nodes),edges:o.edges,variables:o.variables,characters:o.characters}),o=>({nodes:o.nodes,edges:o.edges,variables:o.variables,characters:o.characters}))(...t),nodes:[],edges:[],viewport:{x:0,y:0,zoom:1},variables:[],characters:[],onNodesChange(o){const n=s();for(const l of o){if(l.type==="position"&&l.dragging&&!n._isDragging){n.pushSnapshot(),a({_isDragging:!0});break}if(l.type==="position"&&!l.dragging&&n._isDragging){a({_isDragging:!1});break}}o.some(l=>l.type==="remove")&&n.pushSnapshot(),a({nodes:bt(o,n.nodes)})},onEdgesChange(o){const n=s();o.some(l=>l.type==="remove")&&n.pushSnapshot(),a({edges:ft(o,n.edges)})},onConnect(o){s().pushSnapshot(),a({edges:ht({...o,id:V(),type:"smoothstep"},s().edges)})},setViewport(o){a({viewport:o})},addNode(o,n){s().pushSnapshot();const l={id:V(),type:`dialogue-${o}`,position:n,data:is(o)};a(i=>({nodes:[...i.nodes,l]}))},updateNodeData(o,n){s().pushSnapshot(),a(l=>({nodes:l.nodes.map(i=>i.id===o?{...i,data:{...i.data,...n}}:i)}))},removeNode(o){s().pushSnapshot(),a(n=>({nodes:n.nodes.filter(l=>l.id!==o),edges:n.edges.filter(l=>l.source!==o&&l.target!==o)}))},removeEdge(o){s().pushSnapshot(),a(n=>({edges:n.edges.filter(l=>l.id!==o)}))},removeSelected(){s().pushSnapshot(),a(o=>({nodes:o.nodes.filter(n=>!n.selected),edges:o.edges.filter(n=>!n.selected)}))},addVariable(o){s().pushSnapshot(),a(n=>({variables:[...n.variables,o]}))},updateVariable(o,n){s().pushSnapshot(),a(l=>({variables:l.variables.map(i=>i.id===o?{...i,...n}:i)}))},removeVariable(o){s().pushSnapshot(),a(n=>({variables:n.variables.filter(l=>l.id!==o)}))},addCharacter(o){a(n=>n.characters.includes(o)?n:(s().pushSnapshot(),{characters:[...n.characters,o]}))},removeCharacter(o){s().pushSnapshot(),a(n=>({characters:n.characters.filter(l=>l!==o)}))},renameCharacter(o,n){s().pushSnapshot(),a(l=>({characters:l.characters.map(i=>i===o?n:i),nodes:l.nodes.map(i=>i.data.character===o?{...i,data:{...i.data,character:n}}:i)}))},loadDialogue(o,n,l,i,p){a({nodes:o.map(d=>d.selected?{...d,selected:!1}:d),edges:n.map(d=>d.selected?{...d,selected:!1}:d),viewport:l,variables:i,characters:p}),s().clearHistory()},reset(){a({nodes:[],edges:[],viewport:{x:0,y:0,zoom:1},variables:[],characters:[]}),s().clearHistory()}}});function cs({data:t,selected:a}){const s=t;return e.jsxs("div",{className:`flex items-center gap-2 rounded-full border-2 px-4 py-2 shadow-sm ${a?"border-green-500 ring-2 ring-green-500/30":"border-green-400"} bg-green-50 dark:bg-green-900/30`,children:[e.jsx("span",{className:"text-lg",children:"ðŸŸ¢"}),e.jsx("span",{className:"text-sm font-medium text-green-700 dark:text-green-300",children:String(s.label??"Entry")}),e.jsx($,{type:"source",position:I.Bottom,className:"!bg-green-500"})]})}function ds({data:t,selected:a}){const s=t;return e.jsxs("div",{className:`flex items-center gap-2 rounded-full border-2 px-4 py-2 shadow-sm ${a?"border-red-500 ring-2 ring-red-500/30":"border-red-400"} bg-red-50 dark:bg-red-900/30`,children:[e.jsx($,{type:"target",position:I.Top,className:"!bg-red-500"}),e.jsx("span",{className:"text-lg",children:"ðŸ”´"}),e.jsx("span",{className:"text-sm font-medium text-red-700 dark:text-red-300",children:String(s.label??"Exit")})]})}function us({data:t,selected:a}){const s=t,c=String(s.character??"???"),o=s.emotion?String(s.emotion):"",n=String(s.textPreview??"(empty)");return e.jsxs("div",{className:`min-w-[180px] max-w-[260px] rounded-lg border-2 shadow-sm ${a?"border-blue-500 ring-2 ring-blue-500/30":"border-blue-300"} bg-blue-50 dark:bg-blue-900/20`,children:[e.jsx($,{type:"target",position:I.Top,className:"!bg-blue-500"}),e.jsxs("div",{className:"px-3 py-2",children:[e.jsxs("div",{className:"mb-1 flex items-center gap-1.5",children:[e.jsx("span",{className:"text-sm",children:"ðŸ’¬"}),e.jsx("span",{className:"text-xs font-semibold text-blue-600 dark:text-blue-400",children:c}),o&&e.jsx("span",{className:"rounded bg-blue-200/50 px-1 text-[10px] dark:bg-blue-700/30",children:o})]}),e.jsx("p",{className:"line-clamp-3 text-xs text-foreground/80",children:n})]}),e.jsx($,{type:"source",position:I.Bottom,className:"!bg-blue-500"})]})}function xs({data:t,selected:a}){const c=t.options??[];return e.jsxs("div",{className:`min-w-[180px] max-w-[260px] rounded-lg border-2 shadow-sm ${a?"border-amber-500 ring-2 ring-amber-500/30":"border-amber-300"} bg-amber-50 dark:bg-amber-900/20`,children:[e.jsx($,{type:"target",position:I.Top,className:"!bg-amber-500"}),e.jsxs("div",{className:"px-3 py-2",children:[e.jsxs("div",{className:"mb-1.5 flex items-center gap-1.5",children:[e.jsx("span",{className:"text-sm",children:"ðŸ”€"}),e.jsx("span",{className:"text-xs font-semibold text-amber-600 dark:text-amber-400",children:"é¸é …"})]}),e.jsx("div",{className:"space-y-1",children:c.map((o,n)=>e.jsxs("div",{className:"rounded bg-amber-100/80 px-2 py-0.5 text-xs dark:bg-amber-800/30",children:[n+1,". ",o.textPreview||"(empty)",o.condition&&e.jsxs("span",{className:"ml-1 text-[10px] text-amber-500",children:["[",o.condition,"]"]})]},o.id))})]}),c.map((o,n)=>e.jsx($,{type:"source",position:I.Bottom,id:o.id,className:"!bg-amber-500",style:{left:`${(n+1)/(c.length+1)*100}%`}},o.id))]})}function ms({data:t,selected:a}){const s=t,c=String(s.expression??"(no condition)"),o=s.description?String(s.description):"";return e.jsxs("div",{className:`rounded-lg border-2 shadow-sm ${a?"border-purple-500 ring-2 ring-purple-500/30":"border-purple-300"} bg-purple-50 dark:bg-purple-900/20`,children:[e.jsx($,{type:"target",position:I.Top,className:"!bg-purple-500"}),e.jsxs("div",{className:"min-w-[160px] px-3 py-2",children:[e.jsxs("div",{className:"mb-1 flex items-center gap-1.5",children:[e.jsx("span",{className:"text-sm",children:"â“"}),e.jsx("span",{className:"text-xs font-semibold text-purple-600 dark:text-purple-400",children:"æ¢ä»¶"})]}),e.jsx("p",{className:"text-xs font-mono text-foreground/70",children:c}),o&&e.jsx("p",{className:"mt-0.5 text-[10px] text-muted-foreground",children:o})]}),e.jsx($,{type:"source",position:I.Bottom,id:"true",className:"!bg-green-500",style:{left:"30%"}}),e.jsx($,{type:"source",position:I.Bottom,id:"false",className:"!bg-red-500",style:{left:"70%"}})]})}function ps(t){switch(t.type){case"set_variable":return`${t.variable} = ${t.expression}`;case"add_item":return`+${t.quantity} item:${t.itemId}`;case"remove_item":return`-${t.quantity} item:${t.itemId}`;case"start_quest":return`â–¶ quest:${t.questId}`;case"complete_quest":return`âœ“ quest:${t.questId}`;case"play_sound":return`â™ª ${t.assetId}`;case"play_animation":return`â–· ${t.target}.${t.animation}`;case"change_scene":return`â†’ scene:${t.sceneId}`;case"custom":return`âš™ ${t.key}`}}function gs({data:t,selected:a}){const c=t.actions??[];return e.jsxs("div",{className:`min-w-[160px] max-w-[240px] rounded-lg border-2 shadow-sm ${a?"border-orange-500 ring-2 ring-orange-500/30":"border-orange-300"} bg-orange-50 dark:bg-orange-900/20`,children:[e.jsx($,{type:"target",position:I.Top,className:"!bg-orange-500"}),e.jsxs("div",{className:"px-3 py-2",children:[e.jsxs("div",{className:"mb-1 flex items-center gap-1.5",children:[e.jsx("span",{className:"text-sm",children:"âš¡"}),e.jsx("span",{className:"text-xs font-semibold text-orange-600 dark:text-orange-400",children:"å‹•ä½œ"})]}),c.length===0?e.jsx("p",{className:"text-xs text-muted-foreground",children:"(no actions)"}):e.jsx("div",{className:"space-y-0.5",children:c.map((o,n)=>e.jsx("div",{className:"rounded bg-orange-100/80 px-1.5 py-0.5 text-[11px] font-mono dark:bg-orange-800/30",children:ps(o)},n))})]}),e.jsx($,{type:"source",position:I.Bottom,className:"!bg-orange-500"})]})}function hs({data:t,selected:a}){const c=String(t.mode??"weighted"),o=c==="weighted"?"åŠ æ¬Šéš¨æ©Ÿ":c==="sequential"?"å¾ªåº":"ä¸é‡è¤‡";return e.jsxs("div",{className:`min-w-[140px] rounded-lg border-2 shadow-sm ${a?"border-pink-500 ring-2 ring-pink-500/30":"border-pink-300"} bg-pink-50 dark:bg-pink-900/20`,children:[e.jsx($,{type:"target",position:I.Top,className:"!bg-pink-500"}),e.jsxs("div",{className:"px-3 py-2 text-center",children:[e.jsx("span",{className:"text-lg",children:"ðŸŽ²"}),e.jsx("p",{className:"text-xs font-medium text-pink-600 dark:text-pink-400",children:o})]}),e.jsx($,{type:"source",position:I.Bottom,className:"!bg-pink-500"})]})}const ue={type:null,id:null,position:{x:0,y:0}},fs=[{value:"smoothstep",labelKey:"flow.edge.smoothstep",icon:At},{value:"default",labelKey:"flow.edge.bezier",icon:qt},{value:"straight",labelKey:"flow.edge.straight",icon:Ft},{value:"step",labelKey:"flow.edge.step",icon:Vt}];function bs({menu:t,onClose:a}){const s=x.useRef(null);return x.useEffect(()=>{if(!t.type)return;function c(n){s.current&&!s.current.contains(n.target)&&a()}function o(n){n.key==="Escape"&&a()}return document.addEventListener("mousedown",c),document.addEventListener("keydown",o),()=>{document.removeEventListener("mousedown",c),document.removeEventListener("keydown",o)}},[t.type,a]),t.type?e.jsxs("div",{ref:s,className:"fixed z-50 min-w-[160px] rounded-md border bg-popover p-1 shadow-md animate-in fade-in-0 zoom-in-95",style:{left:t.position.x,top:t.position.y},children:[t.type==="edge"&&e.jsx(js,{edgeId:t.id,onClose:a}),t.type==="node"&&e.jsx(vs,{nodeId:t.id,onClose:a})]}):null}function js({edgeId:t,onClose:a}){const s=A(),c=w(r=>r.edges.find(u=>u.id===t)),o=w(r=>r.removeEdge),n=c?.type??"smoothstep",[l,i]=x.useState(String(c?.label??"")),p=x.useCallback(()=>{w.setState(r=>({edges:r.edges.map(u=>u.id===t?{...u,label:l.trim()||void 0}:u)}))},[t,l]),d=x.useCallback(r=>{w.setState(u=>({edges:u.edges.map(m=>m.id===t?{...m,type:r}:m)}))},[t]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-2 py-1",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Lt,{className:"size-3.5 shrink-0 text-muted-foreground"}),e.jsx("input",{className:"h-6 w-full rounded border bg-background px-1.5 text-xs outline-none focus:border-ring",placeholder:s("dialogue.edgeLabel"),value:l,onChange:r=>i(r.target.value),onBlur:p,onKeyDown:r=>{r.key==="Enter"&&(p(),a()),r.stopPropagation()},onClick:r=>r.stopPropagation()})]})}),e.jsx("div",{className:"my-1 border-t"}),e.jsx("div",{className:"px-2 py-1 text-[11px] font-medium text-muted-foreground",children:s("flow.edge.type")}),fs.map(r=>e.jsx(xe,{icon:r.icon,label:s(r.labelKey),active:n===r.value,onClick:()=>{d(r.value),a()}},r.value)),e.jsx("div",{className:"my-1 border-t"}),e.jsx(xe,{icon:me,label:s("dialogue.deleteEdge"),onClick:()=>{o(t),a()},destructive:!0})]})}function vs({nodeId:t,onClose:a}){const s=A(),c=w(o=>o.removeNode);return e.jsx(xe,{icon:me,label:s("dialogue.deleteNode"),onClick:()=>{c(t),a()},destructive:!0})}function xe({icon:t,label:a,active:s,destructive:c,onClick:o}){return e.jsxs("button",{className:`flex w-full items-center gap-2 rounded-sm px-2 py-1.5 text-sm hover:bg-accent ${s?"bg-accent/50":""} ${c?"text-destructive hover:text-destructive":""}`,onClick:o,children:[e.jsx(t,{className:"size-3.5"}),e.jsx("span",{className:"flex-1 text-left",children:a}),s&&e.jsx(Oe,{className:"size-3 text-muted-foreground"})]})}const ys={"dialogue-entry":cs,"dialogue-exit":ds,"dialogue-text":us,"dialogue-choice":xs,"dialogue-condition":ms,"dialogue-action":gs,"dialogue-random":hs};function Ns(){const{nodes:t,edges:a,viewport:s,onNodesChange:c,onEdgesChange:o,onConnect:n,setViewport:l}=w(),[i,p]=x.useState(!1),[d,r]=x.useState(ue),u=x.useCallback((N,y)=>l({x:y.x,y:y.y,zoom:y.zoom}),[l]),m=x.useCallback(()=>r(ue),[]),j=x.useCallback((N,y,K)=>{K.preventDefault(),r({type:N,id:y,position:{x:K.clientX,y:K.clientY}})},[]),b=x.useCallback((N,y)=>j("edge",y.id,N),[j]),h=x.useCallback((N,y)=>j("edge",y.id,N),[j]),g=x.useCallback((N,y)=>j("node",y.id,N),[j]),k=x.useCallback(()=>r(ue),[]);return e.jsxs("div",{className:"absolute inset-0",children:[e.jsxs(jt,{nodes:t,edges:a,onNodesChange:c,onEdgesChange:o,onConnect:n,onMoveEnd:u,onEdgeContextMenu:b,onEdgeClick:h,onNodeContextMenu:g,onPaneClick:k,nodeTypes:ys,defaultViewport:s,fitView:!0,defaultEdgeOptions:{type:"smoothstep"},snapToGrid:!0,snapGrid:[16,16],deleteKeyCode:["Backspace","Delete"],proOptions:{hideAttribution:!0},className:"bg-background",children:[e.jsx(vt,{gap:16,size:1}),i&&e.jsx(yt,{nodeStrokeWidth:2,pannable:!0,zoomable:!0,className:"!bg-muted !border-border"})]}),e.jsx(ks,{}),e.jsx(bs,{menu:d,onClose:m}),i?e.jsx("button",{className:"absolute bottom-4 right-4 z-10 flex size-5 items-center justify-center rounded-full bg-background/80 shadow backdrop-blur hover:bg-accent",onClick:()=>p(!1),children:e.jsx(J,{className:"size-3 text-muted-foreground"})}):e.jsx("div",{className:"absolute bottom-3 right-3 z-10",children:e.jsx(_,{variant:"ghost",size:"icon",className:"size-7 border bg-background/80 shadow-md backdrop-blur",onClick:()=>p(!0),children:e.jsx(Ze,{className:"size-3.5"})})})]})}function ks(){const{zoomIn:t,zoomOut:a,fitView:s}=Nt();return e.jsxs("div",{className:"absolute bottom-3 left-1/2 z-10 flex -translate-x-1/2 items-center gap-1 rounded-lg border bg-background/80 p-1 shadow-md backdrop-blur",children:[e.jsx(_,{variant:"ghost",size:"icon",className:"size-7",onClick:()=>a(),children:e.jsx(Tt,{className:"size-3.5"})}),e.jsx(_,{variant:"ghost",size:"icon",className:"size-7",onClick:()=>s({padding:.2}),children:e.jsx(Pt,{className:"size-3.5"})}),e.jsx(_,{variant:"ghost",size:"icon",className:"size-7",onClick:()=>t(),children:e.jsx(Ot,{className:"size-3.5"})})]})}function Q(t){const a=A(),s=w(r=>r.variables),[c,o]=x.useState(!1),[n,l]=x.useState(""),i=x.useMemo(()=>{const r=n.trim().toLowerCase();return r?s.filter(u=>u.name.toLowerCase().includes(r)||u.type.includes(r)):s},[s,n]),p=r=>{t.mode==="select"?t.onChange(r):t.onInsert(r),o(!1),l("")},d={number:"text-blue-500",string:"text-green-500",boolean:"text-amber-500"};return t.mode==="select"?e.jsxs(X,{open:c,onOpenChange:r=>{o(r),r||l("")},children:[e.jsx(Y,{asChild:!0,children:e.jsx("button",{className:"w-full truncate rounded-md border bg-background px-2 py-1 text-left text-xs outline-none hover:bg-accent",children:t.value?e.jsx("span",{className:"font-mono",children:t.value}):e.jsx("span",{className:"text-muted-foreground",children:a("dialogue.selectVariable")})})}),e.jsx(Te,{variables:i,search:n,onSearchChange:l,onSelect:p,typeColor:d,t:a})]}):e.jsxs(X,{open:c,onOpenChange:r=>{o(r),r||l("")},children:[e.jsx(Y,{asChild:!0,children:e.jsx("button",{className:"shrink-0 rounded p-1 text-muted-foreground hover:bg-accent hover:text-foreground",title:a("dialogue.insertVariable"),children:e.jsx(pe,{className:"size-3.5"})})}),e.jsx(Te,{variables:i,search:n,onSearchChange:l,onSelect:p,typeColor:d,t:a})]})}function Te({variables:t,search:a,onSearchChange:s,onSelect:c,typeColor:o,t:n}){return e.jsxs(ne,{side:"bottom",align:"start",className:"w-56 p-0",children:[e.jsxs("div",{className:"flex items-center gap-1 border-b px-2 py-1.5",children:[e.jsx(ae,{className:"size-3 shrink-0 text-muted-foreground"}),e.jsx("input",{className:"flex-1 bg-transparent text-xs outline-none placeholder:text-muted-foreground/60",value:a,onChange:l=>s(l.target.value),placeholder:n("common.search"),autoFocus:!0})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto p-1",children:t.length===0?e.jsx("div",{className:"px-2 py-3 text-center text-xs text-muted-foreground",children:n("dialogue.noVariablesHint")}):t.map(l=>e.jsxs("button",{className:"flex w-full items-center justify-between rounded px-2 py-1 text-xs hover:bg-accent",onClick:()=>c(l.name),children:[e.jsx("span",{className:"truncate font-mono",children:l.name}),e.jsx("span",{className:`ml-2 shrink-0 text-[10px] ${o[l.type]??"text-muted-foreground"}`,children:l.type})]},l.id))})]})}const Be=["==","!=",">=","<=",">","<"];function Cs(t){const a=t.trim();for(const s of Be){const c=a.indexOf(` ${s} `);if(c>=0)return{left:a.slice(0,c).trim(),op:s,right:a.slice(c+s.length+2).trim()}}return{left:a,op:"==",right:""}}function ws(t){return!t.left&&!t.right?"":`${t.left} ${t.op} ${t.right}`.trim()}const Ss="h-7 rounded border bg-background text-foreground px-1 text-xs font-mono outline-none focus:ring-1 focus:ring-ring";function He({value:t,onChange:a,placeholder:s}){const c=x.useMemo(()=>Cs(t),[t]),o=x.useCallback(n=>{const l={...c,...n};a(ws(l))},[c,a]);return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"min-w-0 flex-1",children:e.jsx(Q,{mode:"select",value:c.left,onChange:n=>o({left:n})})}),e.jsx("select",{className:Ss,value:c.op,onChange:n=>o({op:n.target.value}),children:Be.map(n=>e.jsx("option",{value:n,className:"bg-popover text-popover-foreground",children:n},n))}),e.jsxs("div",{className:"flex min-w-0 flex-1 items-center gap-0.5",children:[e.jsx(C,{className:"h-7 flex-1 text-xs font-mono",value:c.right,onChange:n=>o({right:n.target.value}),placeholder:s??"0"}),e.jsx(Q,{mode:"insert",onInsert:n=>o({right:n})})]})]})}const zs=["","neutral","happy","sad","angry","surprised","scared","disgusted","confused","shy","serious","excited","tired","smirk","cry"];function _s({node:t,onClose:a}){const s=A(),{updateNodeData:c}=w(),o=Z(i=>i.currentProject?.characters??[]),n=t.data,l=x.useCallback(i=>c(t.id,i),[t.id,c]);switch(n.dialogueType){case"entry":return e.jsx(H,{title:`ðŸŸ¢ ${s("dialogue.entry")}`,onClose:a,children:e.jsx(O,{label:"Label",children:e.jsx(C,{value:String(n.label??""),onChange:i=>l({label:i.target.value})})})});case"exit":return e.jsx(H,{title:`ðŸ”´ ${s("dialogue.exit")}`,onClose:a,children:e.jsx(O,{label:"Label",children:e.jsx(C,{value:String(n.label??""),onChange:i=>l({label:i.target.value})})})});case"text":return e.jsxs(H,{title:`ðŸ’¬ ${s("dialogue.text")}`,onClose:a,children:[e.jsx(O,{label:s("dialogue.character"),children:e.jsxs("select",{className:"w-full rounded-md border bg-background px-2 py-1.5 text-sm text-foreground outline-none",value:String(n.character??""),onChange:i=>l({character:i.target.value}),children:[e.jsx("option",{value:"",className:"bg-popover text-popover-foreground",children:"â€”"}),o.map(i=>e.jsx("option",{value:i.name,className:"bg-popover text-popover-foreground",children:i.name},i.id))]})}),e.jsx(O,{label:s("dialogue.textPreview"),children:e.jsx("textarea",{className:"w-full rounded-md border bg-background px-2 py-1.5 text-sm outline-none",rows:3,value:String(n.textPreview??""),onChange:i=>l({textPreview:i.target.value}),placeholder:"å°è©±æ–‡å­—..."})}),e.jsx(O,{label:"i18n Key",children:e.jsx(se,{value:String(n.textKey??""),onChange:(i,p)=>l({textKey:i,...p!=null?{textPreview:p}:{}}),defaultValue:String(n.textPreview??"")})}),e.jsx(O,{label:s("dialogue.emotion"),children:e.jsx("select",{className:"w-full rounded-md border bg-background px-2 py-1.5 text-sm text-foreground outline-none",value:String(n.emotion??""),onChange:i=>l({emotion:i.target.value}),children:zs.map(i=>e.jsx("option",{value:i,className:"bg-popover text-popover-foreground",children:i?s(`dialogue.emotions.${i}`):"â€”"},i))})})]});case"choice":return e.jsx(Ds,{node:t,onClose:a});case"condition":return e.jsxs(H,{title:`â“ ${s("dialogue.condition")}`,onClose:a,children:[e.jsx(O,{label:s("dialogue.expression"),children:e.jsx(He,{value:String(n.expression??""),onChange:i=>l({expression:i})})}),e.jsx(O,{label:s("dialogue.description"),children:e.jsx(C,{value:String(n.description??""),onChange:i=>l({description:i.target.value})})}),e.jsx(O,{label:`${s("dialogue.description")} i18n Key`,children:e.jsx(se,{value:String(n.descriptionKey??""),onChange:(i,p)=>l({descriptionKey:i,...p!=null?{description:p}:{}}),defaultValue:String(n.description??"")})})]});case"action":return e.jsx(Ms,{node:t,onClose:a});case"random":return e.jsx(H,{title:`ðŸŽ² ${s("dialogue.random")}`,onClose:a,children:e.jsx(O,{label:s("dialogue.mode"),children:e.jsxs("select",{className:"w-full rounded-md border bg-background px-2 py-1.5 text-sm text-foreground outline-none",value:String(n.mode??"weighted"),onChange:i=>l({mode:i.target.value}),children:[e.jsx("option",{value:"weighted",className:"bg-popover text-popover-foreground",children:"åŠ æ¬Šéš¨æ©Ÿ"}),e.jsx("option",{value:"sequential",className:"bg-popover text-popover-foreground",children:"å¾ªåº"}),e.jsx("option",{value:"no-repeat",className:"bg-popover text-popover-foreground",children:"ä¸é‡è¤‡"})]})})});default:return null}}function Ds({node:t,onClose:a}){const s=A(),{updateNodeData:c}=w(),o=t.data,n=o.options??[],l=x.useCallback(r=>c(t.id,r),[t.id,c]);function i(r,u){const m=n.map((j,b)=>b===r?{...j,...u}:j);c(t.id,{options:m})}function p(){const r=[...n,{id:V(),textKey:"",textPreview:""}];c(t.id,{options:r})}function d(r){c(t.id,{options:n.filter((u,m)=>m!==r)})}return e.jsxs(H,{title:`ðŸ”€ ${s("dialogue.choice")}`,onClose:a,children:[e.jsx(O,{label:s("dialogue.prompt"),children:e.jsx("textarea",{className:"w-full rounded-md border bg-background px-2 py-1.5 text-sm outline-none",rows:2,value:String(o.prompt??""),onChange:r=>l({prompt:r.target.value}),placeholder:s("dialogue.promptPlaceholder")})}),e.jsx(O,{label:`${s("dialogue.prompt")} i18n Key`,children:e.jsx(se,{value:String(o.promptKey??""),onChange:(r,u)=>l({promptKey:r,...u!=null?{prompt:u}:{}}),defaultValue:String(o.prompt??"")})}),n.map((r,u)=>e.jsxs("div",{className:"rounded border p-2 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-xs font-medium",children:["#",u+1]}),e.jsx("button",{className:"text-muted-foreground hover:text-destructive",onClick:()=>d(u),children:e.jsx(J,{className:"size-3"})})]}),e.jsx(C,{className:"text-xs",value:r.textPreview,onChange:m=>i(u,{textPreview:m.target.value}),placeholder:s("dialogue.optionText")}),e.jsx(se,{value:r.textKey,onChange:(m,j)=>i(u,{textKey:m,...j!=null?{textPreview:j}:{}}),defaultValue:r.textPreview}),e.jsx(He,{value:r.condition??"",onChange:m=>i(u,{condition:m})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"shrink-0 text-[10px] text-muted-foreground",children:s("dialogue.cost")}),e.jsx("div",{className:"flex-1",children:e.jsx(Q,{mode:"select",value:r.cost?.variable??"",onChange:m=>i(u,{cost:{variable:m,amount:r.cost?.amount??1}})})}),e.jsx(C,{className:"w-16 text-xs",type:"number",value:r.cost?.amount??"",onChange:m=>{const j=Number(m.target.value);r.cost?i(u,{cost:{...r.cost,amount:j||0}}):i(u,{cost:{variable:"",amount:j||0}})},placeholder:s("dialogue.amount")})]})]},r.id)),e.jsxs(_,{variant:"ghost",size:"sm",className:"mt-1 h-7 text-xs",onClick:p,children:[e.jsx(ee,{className:"mr-1 size-3"})," ",s("dialogue.addOption")]})]})}function Ms({node:t,onClose:a}){const s=A(),{updateNodeData:c}=w(),n=t.data.actions??[];function l(){const d=[...n,{type:"set_variable",variable:"",expression:""}];c(t.id,{actions:d})}function i(d){c(t.id,{actions:n.filter((r,u)=>u!==d)})}function p(d,r){const u=n.map((m,j)=>j===d?{...m,...r}:m);c(t.id,{actions:u})}return e.jsxs(H,{title:`âš¡ ${s("dialogue.action")}`,onClose:a,children:[e.jsx("div",{className:"space-y-2 sm:col-span-2 lg:col-span-3 xl:col-span-4",children:n.map((d,r)=>e.jsxs("div",{className:"rounded border p-2",children:[e.jsxs("div",{className:"mb-1 flex items-center justify-between",children:[e.jsxs("select",{className:"rounded border bg-background px-1 py-0.5 text-xs text-foreground outline-none",value:d.type,onChange:u=>{const m=u.target.value;m==="set_variable"?p(r,{type:m,variable:"",expression:""}):m==="add_item"||m==="remove_item"?p(r,{type:m,itemId:"",quantity:1}):m==="start_quest"||m==="complete_quest"?p(r,{type:m,questId:""}):m==="play_sound"?p(r,{type:m,assetId:""}):m==="play_animation"?p(r,{type:m,target:"",animation:""}):m==="change_scene"?p(r,{type:m,sceneId:""}):p(r,{type:"custom",key:"",params:{}})},children:[e.jsx("option",{value:"set_variable",className:"bg-popover text-popover-foreground",children:"set_variable"}),e.jsx("option",{value:"add_item",className:"bg-popover text-popover-foreground",children:"add_item"}),e.jsx("option",{value:"remove_item",className:"bg-popover text-popover-foreground",children:"remove_item"}),e.jsx("option",{value:"start_quest",className:"bg-popover text-popover-foreground",children:"start_quest"}),e.jsx("option",{value:"complete_quest",className:"bg-popover text-popover-foreground",children:"complete_quest"}),e.jsx("option",{value:"play_sound",className:"bg-popover text-popover-foreground",children:"play_sound"}),e.jsx("option",{value:"play_animation",className:"bg-popover text-popover-foreground",children:"play_animation"}),e.jsx("option",{value:"change_scene",className:"bg-popover text-popover-foreground",children:"change_scene"}),e.jsx("option",{value:"custom",className:"bg-popover text-popover-foreground",children:"custom"})]}),e.jsx("button",{className:"text-muted-foreground hover:text-destructive",onClick:()=>i(r),children:e.jsx(J,{className:"size-3"})})]}),e.jsx(Es,{action:d,onChange:u=>p(r,u)})]},r))}),e.jsxs(_,{variant:"ghost",size:"sm",className:"mt-1 h-7 text-xs",onClick:l,children:[e.jsx(ee,{className:"mr-1 size-3"})," ",s("dialogue.addAction")]})]})}function se({value:t,onChange:a,defaultValue:s}){const c=A(),o=Z(f=>f.currentProject?.id),[n,l]=x.useState(!1),[i,p]=x.useState(""),[d,r]=x.useState([]),[u,m]=x.useState(null),[j,b]=x.useState([]),[h,g]=x.useState("dialogue"),k=x.useMemo(()=>[...new Set([...Gt,...j])],[j]);x.useEffect(()=>{if(!n||!o)return;let f=!1;return(async()=>{const P=(await q.listDocuments(o)).find(S=>S.type==="i18n");if(f)return;if(!P){const S={id:V(),projectId:o,type:"i18n",title:"Localization",parentId:null,sortOrder:0,locale:"zh-TW",locales:["zh-TW"],entries:[],createdAt:Date.now(),updatedAt:Date.now()};await q.saveDocument(S),m(S.id),r([]);return}const z=await q.loadDocument(P.id);z&&!f&&(r(z.entries??[]),m(z.id),b(z.customCategories??[]))})(),()=>{f=!0}},[n,o]);const N=x.useMemo(()=>{let f=d;if(h){const E=`${h}.`;f=f.filter(P=>P.key.startsWith(E))}if(i.trim()){const E=i.trim().toLowerCase();f=f.filter(P=>P.key.toLowerCase().includes(E)||P.value.toLowerCase().includes(E))}return f},[d,i,h]),y=i.trim(),K=h||"dialogue",T=y.includes(".")?y:`${K}.${y}`,oe=!y||d.some(f=>f.key===T),L=(f,E)=>{a(f,E),l(!1),p("")},re=async()=>{if(!T||!u)return;const f=await q.loadDocument(u);if(!f)return;const E=T.indexOf("."),P=E>0?T.slice(0,E):K,z={key:T,value:s??"",category:P,status:"draft",updatedAt:Date.now()};f.entries=[...f.entries??[],z],f.updatedAt=Date.now(),await q.saveDocument(f),r(f.entries),a(T,s),l(!1),p("")};return e.jsxs(X,{open:n,onOpenChange:f=>{l(f),f||p("")},children:[e.jsx(Y,{asChild:!0,children:e.jsx("button",{className:"w-full truncate rounded-md border bg-background px-2 py-1.5 text-left text-xs font-mono outline-none hover:bg-accent",children:t||e.jsx("span",{className:"font-sans text-muted-foreground",children:c("dialogue.selectKey")})})}),e.jsxs(ne,{side:"bottom",align:"start",className:"w-72 p-0",children:[e.jsxs("div",{className:"flex items-center gap-1 border-b px-2 py-1.5",children:[e.jsx(ae,{className:"size-3 shrink-0 text-muted-foreground"}),e.jsxs("select",{className:"shrink-0 rounded border bg-background px-1 py-0.5 text-[10px] text-muted-foreground outline-none",value:h,onChange:f=>{g(f.target.value),i.includes(".")||p("")},children:[e.jsx("option",{value:"",className:"bg-popover text-popover-foreground",children:"*"}),k.map(f=>e.jsx("option",{value:f,className:"bg-popover text-popover-foreground",children:f},f))]}),e.jsx("input",{className:"flex-1 bg-transparent text-xs outline-none placeholder:text-muted-foreground/60",value:i,onChange:f=>p(f.target.value),placeholder:c("common.search"),autoFocus:!0})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto p-1",children:N.length===0&&!i.trim()&&d.length===0?e.jsx("div",{className:"px-2 py-3 text-center text-xs text-muted-foreground",children:c("dialogue.noI18nKeys")}):N.length===0?e.jsx("div",{className:"px-2 py-3 text-center text-xs text-muted-foreground",children:c("common.noResults")}):N.map(f=>e.jsxs("button",{className:"flex w-full items-center justify-between rounded px-2 py-1 text-xs hover:bg-accent",onClick:()=>L(f.key,f.value),children:[e.jsx("span",{className:"truncate font-mono",children:f.key}),f.value&&e.jsx("span",{className:"ml-2 max-w-28 truncate text-muted-foreground",children:f.value})]},f.key))}),y&&!oe&&e.jsx("div",{className:"border-t px-2 py-1.5",children:e.jsxs("button",{className:"flex w-full items-center gap-1.5 rounded px-1 py-1 text-xs hover:bg-accent",onClick:re,children:[e.jsx(ee,{className:"size-3 shrink-0"}),e.jsxs("span",{children:[c("dialogue.createKey")," ",e.jsx("span",{className:"font-mono",children:T})]})]})})]})]})}function Es({action:t,onChange:a}){switch(t.type){case"set_variable":return e.jsxs("div",{className:"space-y-1",children:[e.jsx(Q,{mode:"select",value:t.variable,onChange:s=>a({variable:s})}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(C,{className:"flex-1 text-xs font-mono",value:t.expression,onChange:s=>a({expression:s.target.value}),placeholder:"expression"}),e.jsx(Q,{mode:"insert",onInsert:s=>a({expression:`${t.expression}${t.expression?" ":""}${s}`})})]})]});case"add_item":case"remove_item":return e.jsxs("div",{className:"flex gap-1",children:[e.jsx(C,{className:"flex-1 text-xs",value:t.itemId,onChange:s=>a({itemId:s.target.value}),placeholder:"itemId"}),e.jsx(C,{className:"w-16 text-xs",type:"number",value:t.quantity,onChange:s=>a({quantity:Number(s.target.value)||1}),placeholder:"qty"})]});case"start_quest":case"complete_quest":return e.jsx(C,{className:"text-xs",value:t.questId,onChange:s=>a({questId:s.target.value}),placeholder:"questId"});case"play_sound":return e.jsx(C,{className:"text-xs",value:t.assetId,onChange:s=>a({assetId:s.target.value}),placeholder:"assetId"});case"play_animation":return e.jsxs("div",{className:"flex gap-1",children:[e.jsx(C,{className:"text-xs",value:t.target,onChange:s=>a({target:s.target.value}),placeholder:"target"}),e.jsx(C,{className:"text-xs",value:t.animation,onChange:s=>a({animation:s.target.value}),placeholder:"animation"})]});case"change_scene":return e.jsx(C,{className:"text-xs",value:t.sceneId,onChange:s=>a({sceneId:s.target.value}),placeholder:"sceneId"});case"custom":return e.jsxs("div",{className:"space-y-1",children:[e.jsx(C,{className:"text-xs",value:t.key,onChange:s=>a({key:s.target.value}),placeholder:"key"}),e.jsx("textarea",{className:"w-full rounded border bg-muted/30 px-2 py-1 text-xs font-mono outline-none placeholder:text-muted-foreground/50",rows:2,value:JSON.stringify(t.params,null,2),onChange:s=>{try{a({params:JSON.parse(s.target.value)})}catch{}},placeholder:'{ "key": "value" }'})]})}}function H({title:t,onClose:a,children:s}){return e.jsxs("div",{className:"shrink-0 border-b bg-background",children:[e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2",children:[e.jsx("span",{className:"text-sm font-semibold",children:t}),e.jsx("div",{className:"flex-1"}),e.jsx("button",{className:"text-muted-foreground hover:text-foreground",onClick:a,children:e.jsx(J,{className:"size-4"})})]}),e.jsx("div",{className:"max-h-56 overflow-y-auto px-4 pb-3",children:e.jsx("div",{className:"grid grid-cols-1 gap-x-4 gap-y-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:s})})]})}function O({label:t,children:a}){return e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-xs font-medium text-muted-foreground",children:t}),a]})}function $s({onClose:t}){const a=A(),{id:s}=Ke(),c=Z(g=>g.currentProject?.characters??[]),{addCharacter:o,removeCharacter:n,updateCharacter:l}=Z(),[i,p]=x.useState(""),[d,r]=x.useState([]);x.useEffect(()=>{if(!s)return;let g=!1;return(async()=>{const N=(await q.listDocuments(s)).find(K=>K.type==="asset-registry");if(!N||g)return;const y=await q.loadDocument(N.id);y&&!g&&r(y.assets??[])})(),()=>{g=!0}},[s]);const u=x.useCallback(()=>{const g=i.trim();g&&(o(g),p(""))},[i,o]),m=x.useCallback(g=>{n(g.id);const{nodes:k}=w.getState(),N=k.filter(y=>y.data.character===g.name);for(const y of N)w.getState().updateNodeData(y.id,{character:""})},[n]),j=x.useCallback((g,k)=>{const N=c.find(y=>y.id===g);!N||N.assetIds.includes(k)||l(g,{assetIds:[...N.assetIds,k]})},[c,l]),b=x.useCallback((g,k)=>{const N=c.find(y=>y.id===g);N&&l(g,{assetIds:N.assetIds.filter(y=>y!==k)})},[c,l]),h=d.reduce((g,k)=>((g[k.category]??=[]).push(k),g),{});return e.jsxs("div",{className:"shrink-0 border-b bg-background",children:[e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2",children:[e.jsx(Ae,{className:"size-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-semibold",children:a("dialogue.characterMgmt")}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[c.length," ",a("dialogue.characterCount")]}),e.jsx("div",{className:"flex-1"}),e.jsx("button",{className:"text-muted-foreground hover:text-foreground",onClick:t,children:e.jsx(J,{className:"size-4"})})]}),e.jsxs("div",{className:"flex items-center gap-1 px-4 pb-2",children:[e.jsx(C,{className:"h-7 flex-1 text-xs",value:i,onChange:g=>p(g.target.value),onKeyDown:g=>{g.key==="Enter"&&u()},placeholder:a("dialogue.addCharacter")}),e.jsx(_,{variant:"ghost",size:"icon",className:"size-7 shrink-0",onClick:u,disabled:!i.trim(),children:e.jsx(ee,{className:"size-3.5"})})]}),e.jsx("div",{className:"max-h-64 overflow-y-auto px-4 pb-3",children:e.jsx("div",{className:"grid grid-cols-1 gap-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:c.map(g=>e.jsx(Is,{char:g,assets:d,assetsByCategory:h,onUpdate:l,onDelete:()=>m(g),onLinkAsset:k=>j(g.id,k),onUnlinkAsset:k=>b(g.id,k),t:a},g.id))})})]})}function Is({char:t,assets:a,assetsByCategory:s,onUpdate:c,onDelete:o,onLinkAsset:n,onUnlinkAsset:l,t:i}){const[p,d]=x.useState(!1),[r,u]=x.useState(t.name),m=t.assetIds.map(b=>a.find(h=>h.id===b)).filter(Boolean);function j(){const b=r.trim();if(b&&b!==t.name){const{nodes:h}=w.getState();for(const g of h)g.data.character===t.name&&w.getState().updateNodeData(g.id,{character:b});c(t.id,{name:b})}d(!1)}return e.jsxs("div",{className:"rounded-lg border p-2.5 text-sm",children:[e.jsx("div",{className:"mb-1.5 flex items-center gap-1",children:p?e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"h-6 flex-1 text-xs",value:r,onChange:b=>u(b.target.value),onKeyDown:b=>{b.key==="Enter"&&j(),b.key==="Escape"&&d(!1)},autoFocus:!0}),e.jsx("button",{className:"text-muted-foreground hover:text-foreground",onClick:j,children:e.jsx(Oe,{className:"size-3"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"flex-1 truncate font-medium",children:t.name}),e.jsx("button",{className:"text-muted-foreground hover:text-foreground",onClick:()=>{u(t.name),d(!0)},children:e.jsx(Xe,{className:"size-3"})}),e.jsx("button",{className:"text-muted-foreground hover:text-destructive",onClick:o,children:e.jsx(J,{className:"size-3"})})]})}),e.jsx("textarea",{className:"mb-1.5 w-full resize-none rounded border bg-muted/30 px-2 py-1 text-xs outline-none placeholder:text-muted-foreground/50",rows:2,value:t.notes??"",onChange:b=>c(t.id,{notes:b.target.value}),placeholder:i("dialogue.notes")}),m.length>0&&e.jsx("div",{className:"mb-1.5 flex flex-wrap gap-1",children:m.map(b=>e.jsxs("span",{className:"inline-flex items-center gap-0.5 rounded bg-accent px-1.5 py-0.5 text-[10px]",children:[e.jsx("span",{className:"truncate max-w-24",children:b.name}),e.jsx("button",{className:"text-muted-foreground hover:text-destructive",onClick:()=>l(b.id),children:e.jsx(Fe,{className:"size-2.5"})})]},b.id))}),e.jsx(Ts,{char:t,assets:a,assetsByCategory:s,onLinkAsset:n,t:i})]})}function Ts({char:t,assets:a,assetsByCategory:s,onLinkAsset:c,t:o}){const[n,l]=x.useState(""),[i,p]=x.useState(!1),d=x.useMemo(()=>{if(!n.trim())return s;const r=n.trim().toLowerCase(),u={};for(const[m,j]of Object.entries(s)){const b=j.filter(h=>h.name.toLowerCase().includes(r)||m.toLowerCase().includes(r));b.length>0&&(u[m]=b)}return u},[n,s]);return e.jsxs(X,{open:i,onOpenChange:r=>{p(r),r||l("")},children:[e.jsx(Y,{asChild:!0,children:e.jsxs(_,{variant:"ghost",size:"sm",className:"h-6 px-1.5 text-[10px]",children:[e.jsx(Jt,{className:"mr-1 size-3"}),o("dialogue.linkAsset")]})}),e.jsxs(ne,{side:"bottom",align:"start",className:"w-56 p-0",children:[e.jsxs("div",{className:"flex items-center gap-1 border-b px-2 py-1.5",children:[e.jsx(ae,{className:"size-3 shrink-0 text-muted-foreground"}),e.jsx("input",{className:"flex-1 bg-transparent text-xs outline-none placeholder:text-muted-foreground/60",value:n,onChange:r=>l(r.target.value),placeholder:o("common.search"),autoFocus:!0})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto p-1",children:a.length===0?e.jsx("div",{className:"px-2 py-3 text-center text-xs text-muted-foreground",children:o("dialogue.noAssets")}):Object.keys(d).length===0?e.jsx("div",{className:"px-2 py-3 text-center text-xs text-muted-foreground",children:o("common.noResults")}):Object.entries(d).map(([r,u])=>e.jsxs("div",{children:[e.jsx("div",{className:"px-2 py-1 text-[10px] font-semibold text-muted-foreground",children:r}),u.map(m=>{const j=t.assetIds.includes(m.id);return e.jsxs("button",{disabled:j,className:"flex w-full items-center rounded px-2 py-1 text-xs hover:bg-accent disabled:opacity-50",onClick:()=>{c(m.id),p(!1),l("")},children:[e.jsx("span",{className:j?"text-muted-foreground":"",children:m.name}),j&&e.jsx("span",{className:"ml-auto text-[10px] text-muted-foreground",children:"âœ“"})]},m.id)})]},r))})]})]})}function Ps({onChange:t}){const a=A(),s=Z(h=>h.currentProject?.id),[c,o]=x.useState(!1),[n,l]=x.useState(""),[i,p]=x.useState([]),[d,r]=x.useState(null);x.useEffect(()=>{if(!c||!s)return;let h=!1;return(async()=>{const g=await q.listDocuments(s);h||p(g.filter(k=>k.type==="datatable"))})(),()=>{h=!0}},[c,s]);const u=async h=>{const g=await q.loadDocument(h.id);g&&r({doc:g,meta:h})},m=(h,g)=>{d&&(t(`${d.doc.id}.${h}`,`${d.meta.title}.${g}`),o(!1),j())},j=()=>{l(""),r(null)},b=x.useMemo(()=>{const h=n.trim().toLowerCase();return h?d?d.doc.schema.columns.filter(g=>g.name.toLowerCase().includes(h)):i.filter(g=>g.title.toLowerCase().includes(h)):d?d.doc.schema.columns:i},[n,d,i]);return e.jsxs(X,{open:c,onOpenChange:h=>{o(h),h||j()},children:[e.jsx(Y,{asChild:!0,children:e.jsx("button",{className:"w-full truncate rounded-md border bg-background px-2 py-1.5 text-left text-xs outline-none hover:bg-accent",children:e.jsx("span",{className:"text-muted-foreground",children:a("dialogue.tableRefSelect")})})}),e.jsxs(ne,{side:"bottom",align:"start",className:"w-72 p-0",children:[e.jsxs("div",{className:"flex items-center gap-1 border-b px-2 py-1.5",children:[d&&e.jsx("button",{className:"shrink-0 rounded p-0.5 hover:bg-accent",onClick:()=>{r(null),l("")},children:e.jsx(Zt,{className:"size-3.5"})}),e.jsx(ae,{className:"size-3 shrink-0 text-muted-foreground"}),e.jsx("input",{className:"flex-1 bg-transparent text-xs outline-none placeholder:text-muted-foreground/60",value:n,onChange:h=>l(h.target.value),placeholder:d?d.meta.title:a("dialogue.selectTable"),autoFocus:!0})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto p-1",children:d?b.length===0?e.jsx("div",{className:"px-2 py-3 text-center text-xs text-muted-foreground",children:a("common.noResults")}):b.map(h=>e.jsxs("button",{className:"flex w-full items-center justify-between rounded px-2 py-1.5 text-xs hover:bg-accent",onClick:()=>m(h.id,h.name),children:[e.jsx("span",{className:"truncate",children:h.name}),e.jsx("span",{className:"ml-2 shrink-0 rounded bg-muted px-1.5 py-0.5 text-[10px] text-muted-foreground",children:h.type})]},h.id)):b.length===0?e.jsx("div",{className:"px-2 py-3 text-center text-xs text-muted-foreground",children:a("dialogue.noTables")}):b.map(h=>e.jsxs("button",{className:"flex w-full items-center gap-2 rounded px-2 py-1.5 text-xs hover:bg-accent",onClick:()=>u(h),children:[e.jsx(Ye,{className:"size-3 shrink-0 text-muted-foreground"}),e.jsx("span",{className:"flex-1 truncate text-left",children:h.title})]},h.id))})]})]})}const Pe="h-6 flex-1 rounded border bg-background text-foreground px-1.5 text-[11px] outline-none focus:ring-1 focus:ring-ring",W="bg-popover text-popover-foreground";function Os({onClose:t}){const a=A(),s=Le(),c=w(u=>u.variables),{addVariable:o,updateVariable:n,removeVariable:l}=w(),[i,p]=x.useState(""),d=x.useCallback(()=>{const u=i.trim();if(!u)return;const m={id:V(),name:u,type:"number",defaultValue:0,scope:"local"};o(m),p("")},[i,o]),r=x.useCallback(async u=>{await s({title:a("dialogue.deleteVariable"),variant:"destructive"})&&l(u)},[s,l,a]);return e.jsxs("div",{className:"shrink-0 border-b bg-background",children:[e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2",children:[e.jsx(pe,{className:"size-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-semibold",children:a("dialogue.variables")}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[c.length," ",a("dialogue.variableCount")]}),e.jsx("div",{className:"flex-1"}),e.jsx("button",{className:"text-muted-foreground hover:text-foreground",onClick:t,children:e.jsx(J,{className:"size-4"})})]}),e.jsxs("div",{className:"flex items-center gap-1 px-4 pb-2",children:[e.jsx(C,{className:"h-7 flex-1 text-xs",value:i,onChange:u=>p(u.target.value),onKeyDown:u=>{u.key==="Enter"&&d()},placeholder:a("dialogue.addVariable")}),e.jsx(_,{variant:"ghost",size:"icon",className:"size-7 shrink-0",onClick:d,disabled:!i.trim(),children:e.jsx(ee,{className:"size-3.5"})})]}),e.jsx("div",{className:"max-h-64 overflow-y-auto px-4 pb-3",children:c.length===0?e.jsx("div",{className:"py-4 text-center text-xs text-muted-foreground",children:a("dialogue.noVariables")}):e.jsx("div",{className:"grid grid-cols-1 gap-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:c.map(u=>e.jsx(Ks,{variable:u,onUpdate:n,onDelete:()=>r(u.id),t:a},u.id))})})]})}function Ks({variable:t,onUpdate:a,onDelete:s,t:c}){function o(n){const l={number:0,string:"",boolean:!1};a(t.id,{type:n,defaultValue:l[n]})}return e.jsxs("div",{className:"rounded-lg border p-2.5 text-sm",children:[e.jsxs("div",{className:"mb-1.5 flex items-center gap-1",children:[e.jsx(C,{className:"h-6 flex-1 text-xs font-medium",value:t.name,onChange:n=>a(t.id,{name:n.target.value}),placeholder:c("dialogue.variableName")}),e.jsx("button",{className:"shrink-0 text-muted-foreground hover:text-destructive",onClick:s,children:e.jsx(me,{className:"size-3"})})]}),e.jsx("div",{className:"mb-1.5",children:e.jsxs("select",{className:`${Pe} w-full`,value:t.type,onChange:n=>o(n.target.value),children:[e.jsx("option",{value:"number",className:W,children:"number"}),e.jsx("option",{value:"string",className:W,children:"string"}),e.jsx("option",{value:"boolean",className:W,children:"boolean"})]})}),e.jsx("div",{className:"mb-1.5",children:t.tableRef?e.jsxs("div",{className:"flex items-center gap-1 rounded-md border bg-muted/50 px-2 py-1.5 text-xs",children:[e.jsx("span",{className:"flex-1 truncate font-mono",children:t.tableRefDisplay??t.tableRef}),e.jsx("button",{className:"shrink-0 text-muted-foreground hover:text-destructive",onClick:()=>a(t.id,{tableRef:void 0,tableRefDisplay:void 0}),children:e.jsx(Fe,{className:"size-3"})})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ps,{onChange:(n,l)=>a(t.id,{tableRef:n,tableRefDisplay:l})}),e.jsx("div",{className:"mt-1",children:t.type==="boolean"?e.jsxs("select",{className:`${Pe} w-full`,value:String(t.defaultValue),onChange:n=>a(t.id,{defaultValue:n.target.value==="true"}),children:[e.jsx("option",{value:"false",className:W,children:"false"}),e.jsx("option",{value:"true",className:W,children:"true"})]}):e.jsx(C,{className:"h-6 text-xs",type:t.type==="number"?"number":"text",value:String(t.defaultValue),onChange:n=>a(t.id,{defaultValue:t.type==="number"?Number(n.target.value):n.target.value}),placeholder:c("dialogue.variableDefault")})})]})}),e.jsx(C,{className:"h-6 text-[11px] text-muted-foreground",value:t.description??"",onChange:n=>a(t.id,{description:n.target.value||void 0}),placeholder:c("dialogue.variableDescription")})]})}const Ls=x.lazy(()=>gt(()=>import("./SimulatorOverlay-BJ108Cti.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19])).then(t=>({default:t.SimulatorOverlay}))),As=[{type:"entry",icon:Re,labelKey:"dialogue.entry",color:"#22c55e"},{type:"exit",icon:Kt,labelKey:"dialogue.exit",color:"#ef4444"}],qs=[{type:"text",icon:Ve,labelKey:"dialogue.text",color:"#3b82f6"},{type:"choice",icon:ss,labelKey:"dialogue.choice",color:"#f59e0b"}],Vs=[{type:"condition",icon:Ht,labelKey:"dialogue.condition",color:"#a855f7"},{type:"action",icon:qe,labelKey:"dialogue.action",color:"#f97316"},{type:"random",icon:es,labelKey:"dialogue.random",color:"#ec4899"}],Rs=[{labelKey:"dialogue.cat.flow",icon:Re,nodes:As},{labelKey:"dialogue.cat.content",icon:Ve,nodes:qs},{labelKey:"dialogue.cat.logic",icon:qe,nodes:Vs}];function Fs(){const{docId:t}=Ke(),a=A(),{currentDocument:s}=Qe(),{nodes:c,edges:o,viewport:n,variables:l,characters:i,loadDialogue:p,addNode:d,undo:r,redo:u,_past:m,_future:j}=w();kt(r,u);const b=Le(),[h,g]=x.useState(!1),[k,N]=x.useState(!1),[y,K]=x.useState(!1),[T,oe]=x.useState(!1);x.useEffect(()=>{if(s?.type==="dialogue"){const v=s;p(v.nodes,v.edges,v.viewport,v.variables,v.metadata.characters??[])}},[s?.id]);const L=x.useMemo(()=>!s||s.type!=="dialogue"?null:{...s,nodes:c,edges:o,viewport:n,variables:l,metadata:{...s.metadata,characters:i},updatedAt:Date.now()},[s,c,o,n,l,i]),re=wt(L),f=_t(t,re),E=x.useCallback(v=>{const D=200+Math.random()*100,M=100+Math.random()*100;d(v,{x:D,y:M})},[d]),P=x.useCallback(()=>{const{nodes:v,edges:D}=w.getState(),M=et(v,D,{nodesep:100,ranksep:140,padding:20,skipHandleRecompute:!0,getHandleOrder:(Je,le)=>{const ie=Je.data;if(ie.dialogueType==="choice"){const te=(ie.options??[]).map(U=>U.id);return[...le].sort((U,Ue)=>{const ze=te.indexOf(U.sourceHandle??""),_e=te.indexOf(Ue.sourceHandle??"");return(ze===-1?1/0:ze)-(_e===-1?1/0:_e)})}if(ie.dialogueType==="condition"){const ce={true:0,false:1};return[...le].sort((te,U)=>(ce[te.sourceHandle??""]??2)-(ce[U.sourceHandle??""]??2))}return le}});w.setState({nodes:M.nodes,edges:M.edges})},[]),z=x.useMemo(()=>!s||s.type!=="dialogue"?"":tt(L),[s,L]),S=s?.title||"dialogue",ge=x.useCallback(async v=>{if(!await b({title:a("ie.importConfirm"),variant:"destructive"}))return;const M=rs(v);p(M.nodes,M.edges,{x:0,y:0,zoom:1},[],[])},[b,a,p]),he=x.useCallback(async v=>{if(await b({title:a("ie.importConfirm"),variant:"destructive"}))try{const M=JSON.parse(v);if(M.type!=="dialogue")return;p(M.nodes,M.edges,M.viewport,M.variables,M.metadata.characters??[])}catch{}},[b,a,p]),fe=x.useCallback(()=>{De(`${S}.mermaid`,z)},[S,z]),be=x.useCallback(async()=>{if(!z)return;const v=await Me(z);st(`${S}.svg`,v)},[S,z]),je=x.useCallback(async()=>{if(!z)return;const v=await Me(z);await at(`${S}.png`,v)},[S,z]),ve=x.useCallback(()=>{if(!L)return;const v=nt(L);De(`${S}.md`,v)},[S,L]),ye=x.useCallback(()=>{if(!L)return;const v=ot(L);Ee(`${S}.dialogue.json`,v)},[S,L]),Ne=x.useCallback(()=>{s&&Ee(`${S}.json`,s)},[s,S]),ke=x.useMemo(()=>[{key:"ie.importMermaid",icon:$e,accept:".mermaid,.mmd,.txt",onImport:ge},{key:"ie.importJson",icon:Ie,accept:".json",onImport:he}],[ge,he]),Ce=x.useMemo(()=>[{key:"export.currentMermaid",icon:$e,onClick:fe},{key:"export.currentSvg",icon:rt,onClick:be},{key:"export.currentPng",icon:lt,onClick:je},{key:"export.currentMd",icon:it,onClick:ve},{key:"export.dialogueJson",icon:ct,onClick:ye},{key:"export.currentJson",icon:Ie,onClick:Ne}],[fe,be,je,ve,ye,Ne]),we=x.useMemo(()=>[{key:"ie.mermaidPreview",icon:Ut,active:T,onClick:()=>oe(v=>!v)}],[T]);dt(t?e.jsxs(e.Fragment,{children:[e.jsxs(R,{children:[e.jsx(F,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"icon",className:"size-9",onClick:r,disabled:m.length===0,children:e.jsx(Dt,{className:"size-4"})})}),e.jsx(B,{side:"top",children:"Undo"})]}),e.jsxs(R,{children:[e.jsx(F,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"icon",className:"size-9",onClick:u,disabled:j.length===0,children:e.jsx(Mt,{className:"size-4"})})}),e.jsx(B,{side:"top",children:"Redo"})]}),e.jsx(de,{orientation:"vertical",className:"mx-0.5 h-6"}),Rs.map(v=>e.jsxs(ut,{children:[e.jsxs(R,{children:[e.jsx(F,{asChild:!0,children:e.jsx(xt,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"icon",className:"size-9",children:e.jsx(v.icon,{className:"size-4"})})})}),e.jsx(B,{side:"top",children:a(v.labelKey)})]}),e.jsx(mt,{align:"start",children:v.nodes.map(D=>e.jsxs(pt,{onClick:()=>E(D.type),children:[e.jsx(D.icon,{className:"size-4 mr-2 shrink-0",style:{color:D.color}}),a(D.labelKey)]},D.type))})]},v.labelKey)),e.jsx(de,{orientation:"vertical",className:"mx-0.5 h-6"}),e.jsxs(R,{children:[e.jsx(F,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"icon",className:"size-9",onClick:P,children:e.jsx(Rt,{className:"size-4"})})}),e.jsx(B,{side:"top",children:"Auto Layout"})]}),e.jsxs(R,{children:[e.jsx(F,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"icon",className:"size-9",onClick:()=>K(!0),children:e.jsx(Yt,{className:"size-4 text-green-500"})})}),e.jsx(B,{side:"top",children:a("sim.play")})]}),e.jsx(de,{orientation:"vertical",className:"mx-0.5 h-6"}),e.jsxs(R,{children:[e.jsx(F,{asChild:!0,children:e.jsx(_,{variant:h?"secondary":"ghost",size:"icon",className:"size-9",onClick:()=>g(v=>!v),children:e.jsx(Ae,{className:"size-4"})})}),e.jsx(B,{side:"top",children:a("dialogue.characterMgmt")})]}),e.jsxs(R,{children:[e.jsx(F,{asChild:!0,children:e.jsx(_,{variant:k?"secondary":"ghost",size:"icon",className:"size-9",onClick:()=>N(v=>!v),children:e.jsx(pe,{className:"size-4"})})}),e.jsx(B,{side:"top",children:a("dialogue.variables")})]}),e.jsx(St,{imports:ke,exports:Ce,toggles:we}),e.jsx(zt,{section:"å°è©±æ¨¹"})]}):null,[t,E,P,h,k,y,T,ke,Ce,we,r,u,m,j,a]);const Se=c.find(v=>v.selected)??null,Ge=x.useCallback(()=>{const{nodes:v}=w.getState();w.setState({nodes:v.map(D=>D.selected?{...D,selected:!1}:D)})},[]);return t?e.jsx(Ct,{children:e.jsxs("div",{className:"relative flex h-full flex-col",children:[h&&e.jsx($s,{onClose:()=>g(!1)}),k&&e.jsx(Os,{onClose:()=>N(!1)}),Se&&e.jsx(_s,{node:Se,onClose:Ge}),e.jsx("div",{className:"relative flex-1 min-h-0",children:e.jsx(Ns,{})}),T&&e.jsx(Bt,{code:z}),f!=="idle"&&e.jsx($t,{status:f}),y&&e.jsx(x.Suspense,{fallback:null,children:e.jsx(Ls,{onClose:()=>K(!1)})})]})}):e.jsx(Et,{docTypes:["dialogue"],routePath:"dialogue",defaultDocType:"dialogue"})}const na=Object.freeze(Object.defineProperty({__proto__:null,default:Fs},Symbol.toStringTag,{value:"Module"}));export{na as D,Re as P,w as u};
