import{c as P,r as l,j as e,b2 as be,aB as I,bN as ie,b3 as xe,X as fe,B as T,cZ as he,a_ as te,aI as ye,aJ as Ne,bS as we,bT as je,a$ as B,b0 as F,b1 as $,aF as ve,bL as ke,aH as Ce,cF as ze,c4 as Ee,c_ as se,c$ as De,d0 as Se,bV as Me,d1 as oe,bW as ne,c1 as Te,c8 as Ke,bX as Le,bQ as ae,b6 as Re,b7 as Be,b8 as Fe,ba as $e,d2 as Pe,d3 as Oe}from"./index-BO31ZqPg.js";import{H as r,P as c,N as _e,M as le,i as re,B as ce,d as de,f as Ie,u as Ae,c as Ve,b as Ge,a as We,R as ue,e as He}from"./useUndoRedoKeys-CBEPday8.js";import{u as Je,I as Ue,T as Ze}from"./useAutoSave-CfhZAdWB.js";import{u as Ye,U as Xe,R as qe,D as Qe,S as et}from"./useDocumentSwitch-B2mv6tdu.js";import{u as k,M as tt}from"./MermaidPreview-D18Aw_Pg.js";import{T as pe}from"./tag-D7WN3Vb4.js";import{W as st,S as ot,C as nt,L as at}from"./waypoints-Bd-eVwOl.js";import{M as it}from"./minus-Dwx08JAk.js";import{A as lt}from"./arrow-left-right-CMvaBUNi.js";import{S as A,Z as rt,M as ct,a as dt}from"./createHistorySlice-BPQGD6VD.js";import{R as W}from"./rectangle-horizontal-C4_MwUlU.js";import{L as me}from"./layers-DmA3btjA.js";import{S as H}from"./sticky-note-b93n8WRu.js";import{C as ut}from"./code-CKSfqU-M.js";import"./value-kwUSg1GE.js";import"./useReadmeHelp-Dp5zdwnQ.js";import"./copy-Nwklh3jE.js";const pt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["rect",{x:"9",y:"9",width:"6",height:"6",rx:"1",key:"1ssd4o"}]],J=P("circle-stop",pt);const mt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],V=P("circle",mt);const gt=[["path",{d:"M2.7 10.3a2.41 2.41 0 0 0 0 3.41l7.59 7.59a2.41 2.41 0 0 0 3.41 0l7.59-7.59a2.41 2.41 0 0 0 0-3.41l-7.59-7.59a2.41 2.41 0 0 0-3.41 0Z",key:"1f1r0c"}]],U=P("diamond",gt);const bt=[["path",{d:"M3 7V5c0-1.1.9-2 2-2h2",key:"adw53z"}],["path",{d:"M17 3h2c1.1 0 2 .9 2 2v2",key:"an4l38"}],["path",{d:"M21 17v2c0 1.1-.9 2-2 2h-2",key:"144t0e"}],["path",{d:"M7 21H5c-1.1 0-2-.9-2-2v-2",key:"rtnfgi"}],["rect",{width:"7",height:"5",x:"7",y:"7",rx:"1",key:"1eyiv7"}],["rect",{width:"7",height:"5",x:"10",y:"12",rx:"1",key:"1qlmkx"}]],xt=P("group",bt);const ft=[["rect",{width:"8",height:"6",x:"5",y:"4",rx:"1",key:"nzclkv"}],["rect",{width:"8",height:"6",x:"11",y:"14",rx:"1",key:"4tytwb"}]],ht=P("ungroup",ft);function yt(o){const s=o.split(/\r?\n/).map(a=>a.trim()).filter(Boolean),n=new Map,i=[];let u=0;function d(a,t,N){const g=n.get(a);if(g)return t&&!g.label&&(g.label=t),N&&g.type==="process"&&(g.type=N),g;const y={id:a,label:t||a,type:N||"process"};return n.set(a,y),y}function b(a){let t=a.match(/^(\w+)\(\[(.+?)\]\)$/);if(t){const N=t[2],g=N.toLowerCase(),y=g.includes("end")||g.includes("結束")?"end":"start";return{id:t[1],label:N,type:y}}return t=a.match(/^(\w+)\(\((.+?)\)\)$/),t?{id:t[1],label:t[2],type:"start"}:(t=a.match(/^(\w+)\{+(.+?)\}+$/),t?{id:t[1],label:t[2],type:"decision"}:(t=a.match(/^(\w+)\[(.+?)\]$/),t?{id:t[1],label:t[2],type:"process"}:(t=a.match(/^(\w+)>(.+?)\]$/),t?{id:t[1],label:t[2],type:"state"}:{id:a,label:a,type:"process"})))}for(const a of s){if(/^(graph|flowchart)\s/i.test(a)||/^(subgraph|end|style|classDef|class|click|linkStyle)\b/i.test(a)||a.startsWith("%%"))continue;const t=a.match(/^(.+?)\s*(--+>|==+>|--+\||-.+-\>)\s*(?:\|(.+?)\|\s*)?(.+)$/)||a.match(/^(.+?)\s*--\s*(.+?)\s*--+>\s*(.+)$/);if(t){let g,y,f;t.length===4&&!t[0].includes("|")?(g=t[1].trim(),f=t[2].trim(),y=t[3].trim()):(g=t[1].trim(),f=t[3]?.trim(),y=t[4]?.trim()??t[3]?.trim());const p=b(g),v=b(y);d(p.id,p.label,p.type),d(v.id,v.label,v.type),i.push({id:`e-${u++}`,source:p.id,target:v.id,label:f});continue}const N=b(a.replace(/;$/,"").trim());N.id&&d(N.id,N.label,N.type)}const m=[];let x=0;for(const a of n.values())m.push({id:a.id,type:a.type,position:{x:200,y:80+x*120},data:{label:a.label}}),x++;return{nodes:m,edges:i}}function K(o,s){const[n,i]=l.useState(!1),[u,d]=l.useState(s),b=l.useRef(null),m=l.useRef(null),x=k(g=>g.updateNodeData),a=l.useCallback(()=>{d(s),i(!0),setTimeout(()=>{b.current?.focus(),m.current?.focus()},0)},[s]),t=l.useCallback(()=>{i(!1);const g=u.trim();g&&g!==s&&x(o,{label:g})},[u,s,o,x]),N=l.useCallback(g=>{g.key==="Enter"&&t(),g.key==="Escape"&&(d(s),i(!1))},[t,s]);return{editing:n,inputRef:b,textareaRef:m,label:u,setLabel:d,startEdit:a,commitEdit:t,handleKeyDown:N}}function Nt({id:o,data:s,selected:n}){const{editing:i,inputRef:u,label:d,setLabel:b,startEdit:m,commitEdit:x,handleKeyDown:a}=K(o,s.label);return e.jsxs("div",{className:`flex size-20 items-center justify-center rounded-full border-2 bg-green-500/20 text-green-700 dark:bg-green-500/30 dark:text-green-300 ${n?"border-green-400 ring-2 ring-green-400/50":"border-green-500/50"}`,children:[i?e.jsx("input",{ref:u,className:"w-14 bg-transparent text-center text-xs outline-none",value:d,onChange:t=>b(t.target.value),onBlur:x,onKeyDown:a}):e.jsx("span",{className:"cursor-text text-xs font-medium",onDoubleClick:m,children:s.label||"Start"}),e.jsx(r,{type:"target",id:"top",position:c.Top,className:"!size-2 !bg-green-500"}),e.jsx(r,{type:"source",id:"top-src",position:c.Top,className:"!size-2 !bg-green-500"}),e.jsx(r,{type:"target",id:"right",position:c.Right,className:"!size-2 !bg-green-500"}),e.jsx(r,{type:"source",id:"right-src",position:c.Right,className:"!size-2 !bg-green-500"}),e.jsx(r,{type:"target",id:"bottom",position:c.Bottom,className:"!size-2 !bg-green-500"}),e.jsx(r,{type:"source",id:"bottom-src",position:c.Bottom,className:"!size-2 !bg-green-500"}),e.jsx(r,{type:"target",id:"left",position:c.Left,className:"!size-2 !bg-green-500"}),e.jsx(r,{type:"source",id:"left-src",position:c.Left,className:"!size-2 !bg-green-500"})]})}function wt({id:o,data:s,selected:n}){const{editing:i,inputRef:u,label:d,setLabel:b,startEdit:m,commitEdit:x,handleKeyDown:a}=K(o,s.label);return e.jsxs("div",{className:`flex size-20 items-center justify-center rounded-full border-2 bg-red-500/20 text-red-700 dark:bg-red-500/30 dark:text-red-300 ${n?"border-red-400 ring-2 ring-red-400/50":"border-red-500/50"}`,children:[e.jsx(r,{type:"target",id:"top",position:c.Top,className:"!size-2 !bg-red-500"}),e.jsx(r,{type:"source",id:"top-src",position:c.Top,className:"!size-2 !bg-red-500"}),e.jsx(r,{type:"target",id:"right",position:c.Right,className:"!size-2 !bg-red-500"}),e.jsx(r,{type:"source",id:"right-src",position:c.Right,className:"!size-2 !bg-red-500"}),e.jsx(r,{type:"target",id:"bottom",position:c.Bottom,className:"!size-2 !bg-red-500"}),e.jsx(r,{type:"source",id:"bottom-src",position:c.Bottom,className:"!size-2 !bg-red-500"}),e.jsx(r,{type:"target",id:"left",position:c.Left,className:"!size-2 !bg-red-500"}),e.jsx(r,{type:"source",id:"left-src",position:c.Left,className:"!size-2 !bg-red-500"}),i?e.jsx("input",{ref:u,className:"w-14 bg-transparent text-center text-xs outline-none",value:d,onChange:t=>b(t.target.value),onBlur:x,onKeyDown:a}):e.jsx("span",{className:"cursor-text text-xs font-medium",onDoubleClick:m,children:s.label||"End"})]})}function jt({id:o,data:s,selected:n}){const{editing:i,inputRef:u,label:d,setLabel:b,startEdit:m,commitEdit:x,handleKeyDown:a}=K(o,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-md border-2 bg-blue-500/20 px-4 py-3 text-blue-700 dark:bg-blue-500/30 dark:text-blue-200 ${n?"border-blue-400 ring-2 ring-blue-400/50":"border-blue-500/50"}`,children:[e.jsx(r,{type:"target",id:"top",position:c.Top,className:"!size-2 !bg-blue-500"}),e.jsx(r,{type:"source",id:"top-src",position:c.Top,className:"!size-2 !bg-blue-500"}),e.jsx(r,{type:"target",id:"right",position:c.Right,className:"!size-2 !bg-blue-500"}),e.jsx(r,{type:"source",id:"right-src",position:c.Right,className:"!size-2 !bg-blue-500"}),i?e.jsx("input",{ref:u,className:"w-full bg-transparent text-center text-sm outline-none",value:d,onChange:t=>b(t.target.value),onBlur:x,onKeyDown:a}):e.jsx("span",{className:"cursor-text text-center text-sm font-medium block",onDoubleClick:m,children:s.label||"Process"}),e.jsx(r,{type:"target",id:"bottom",position:c.Bottom,className:"!size-2 !bg-blue-500"}),e.jsx(r,{type:"source",id:"bottom-src",position:c.Bottom,className:"!size-2 !bg-blue-500"}),e.jsx(r,{type:"target",id:"left",position:c.Left,className:"!size-2 !bg-blue-500"}),e.jsx(r,{type:"source",id:"left-src",position:c.Left,className:"!size-2 !bg-blue-500"})]})}function vt({id:o,data:s,selected:n}){const{editing:i,inputRef:u,label:d,setLabel:b,startEdit:m,commitEdit:x,handleKeyDown:a}=K(o,s.label);return e.jsxs("div",{className:"relative flex size-[100px] items-center justify-center",children:[e.jsx("div",{className:`absolute inset-[8px] rotate-45 rounded-sm border-2 bg-yellow-500/20 dark:bg-yellow-500/30 ${n?"border-yellow-400 ring-2 ring-yellow-400/50":"border-yellow-500/50"}`}),e.jsx("div",{className:"relative z-10 text-yellow-700 dark:text-yellow-200",children:i?e.jsx("input",{ref:u,className:"w-16 bg-transparent text-center text-xs outline-none",value:d,onChange:t=>b(t.target.value),onBlur:x,onKeyDown:a}):e.jsx("span",{className:"cursor-text text-xs font-medium",onDoubleClick:m,children:s.label||"Decision?"})}),e.jsx(r,{type:"target",id:"top",position:c.Top,className:"!size-2 !bg-yellow-500"}),e.jsx(r,{type:"source",id:"top-src",position:c.Top,className:"!size-2 !bg-yellow-500"}),e.jsx(r,{type:"target",id:"right",position:c.Right,className:"!size-2 !bg-yellow-500"}),e.jsx(r,{type:"source",id:"right-src",position:c.Right,className:"!size-2 !bg-yellow-500"}),e.jsx(r,{type:"target",id:"bottom",position:c.Bottom,className:"!size-2 !bg-yellow-500"}),e.jsx(r,{type:"source",id:"bottom-src",position:c.Bottom,className:"!size-2 !bg-yellow-500"}),e.jsx(r,{type:"target",id:"left",position:c.Left,className:"!size-2 !bg-yellow-500"}),e.jsx(r,{type:"source",id:"left-src",position:c.Left,className:"!size-2 !bg-yellow-500"})]})}function kt({id:o,data:s,selected:n}){const{editing:i,inputRef:u,label:d,setLabel:b,startEdit:m,commitEdit:x,handleKeyDown:a}=K(o,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-xl border-2 bg-purple-500/20 px-4 py-3 text-purple-700 dark:bg-purple-500/30 dark:text-purple-200 ${n?"border-purple-400 ring-2 ring-purple-400/50":"border-purple-500/50"}`,children:[e.jsx(r,{type:"target",id:"top",position:c.Top,className:"!size-2 !bg-purple-500"}),e.jsx(r,{type:"source",id:"top-src",position:c.Top,className:"!size-2 !bg-purple-500"}),e.jsx(r,{type:"target",id:"right",position:c.Right,className:"!size-2 !bg-purple-500"}),e.jsx(r,{type:"source",id:"right-src",position:c.Right,className:"!size-2 !bg-purple-500"}),i?e.jsx("input",{ref:u,className:"w-full bg-transparent text-center text-sm outline-none",value:d,onChange:t=>b(t.target.value),onBlur:x,onKeyDown:a}):e.jsx("span",{className:"cursor-text text-center text-sm font-medium block",onDoubleClick:m,children:s.label||"State"}),e.jsx(r,{type:"target",id:"bottom",position:c.Bottom,className:"!size-2 !bg-purple-500"}),e.jsx(r,{type:"source",id:"bottom-src",position:c.Bottom,className:"!size-2 !bg-purple-500"}),e.jsx(r,{type:"target",id:"left",position:c.Left,className:"!size-2 !bg-purple-500"}),e.jsx(r,{type:"source",id:"left-src",position:c.Left,className:"!size-2 !bg-purple-500"})]})}function Ct({id:o,data:s,selected:n}){const i=k(y=>y.setEditingSubFlowId),{editing:u,inputRef:d,label:b,setLabel:m,startEdit:x,commitEdit:a,handleKeyDown:t}=K(o,s.label),N=s.subNodes?.length??0,g=l.useCallback(y=>{u||(y.stopPropagation(),i(o))},[o,u,i]);return e.jsxs("div",{className:`min-w-[120px] rounded-md border-2 bg-indigo-500/20 px-4 py-3 text-indigo-700 dark:bg-indigo-500/30 dark:text-indigo-200 ${n?"border-indigo-400 ring-2 ring-indigo-400/50":"border-indigo-500/50"}`,onDoubleClick:g,children:[e.jsx("div",{className:"pointer-events-none absolute inset-[3px] rounded border border-indigo-500/30"}),e.jsx(r,{type:"target",id:"top",position:c.Top,className:"!size-2 !bg-indigo-500"}),e.jsx(r,{type:"source",id:"top-src",position:c.Top,className:"!size-2 !bg-indigo-500"}),e.jsx(r,{type:"target",id:"right",position:c.Right,className:"!size-2 !bg-indigo-500"}),e.jsx(r,{type:"source",id:"right-src",position:c.Right,className:"!size-2 !bg-indigo-500"}),e.jsx("div",{className:"flex items-center justify-center gap-1",children:u?e.jsx("input",{ref:d,className:"w-full bg-transparent text-center text-sm outline-none",value:b,onChange:y=>m(y.target.value),onBlur:a,onKeyDown:t}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-center text-sm font-medium",children:s.label||"Sub Flow"}),e.jsx("button",{className:"ml-0.5 rounded p-0.5 opacity-0 transition-opacity hover:bg-indigo-500/20 group-hover:opacity-100 [div:hover>&]:opacity-100",onClick:y=>{y.stopPropagation(),x()},children:e.jsx(be,{className:"size-2.5"})})]})}),N>0&&e.jsxs("span",{className:"mt-1 block text-center text-[10px] text-indigo-400/70",children:[N," nodes"]}),e.jsx(r,{type:"target",id:"bottom",position:c.Bottom,className:"!size-2 !bg-indigo-500"}),e.jsx(r,{type:"source",id:"bottom-src",position:c.Bottom,className:"!size-2 !bg-indigo-500"}),e.jsx(r,{type:"target",id:"left",position:c.Left,className:"!size-2 !bg-indigo-500"}),e.jsx(r,{type:"source",id:"left-src",position:c.Left,className:"!size-2 !bg-indigo-500"})]})}function zt({id:o,data:s,selected:n}){const{editing:i,textareaRef:u,label:d,setLabel:b,startEdit:m,commitEdit:x}=K(o,s.label);return e.jsx("div",{className:`min-w-[100px] max-w-[200px] rounded border bg-yellow-100 px-3 py-2 text-yellow-900 shadow-sm dark:bg-yellow-900/40 dark:text-yellow-100 ${n?"border-yellow-400 ring-2 ring-yellow-400/50":"border-yellow-300 dark:border-yellow-700"}`,children:i?e.jsx("textarea",{ref:u,className:"w-full resize-none bg-transparent text-xs outline-none",rows:3,value:d,onChange:a=>b(a.target.value),onBlur:x,onKeyDown:a=>{a.key==="Escape"&&x()}}):e.jsx("span",{className:"cursor-text whitespace-pre-wrap text-xs block",onDoubleClick:m,children:s.label||"Note..."})})}function Et({id:o,data:s,selected:n}){const{editing:i,inputRef:u,label:d,setLabel:b,startEdit:m,commitEdit:x,handleKeyDown:a}=K(o,s.label);return e.jsxs(e.Fragment,{children:[e.jsx(_e,{isVisible:!!n,minWidth:150,minHeight:100,lineClassName:"!border-dashed !border-zinc-400/60",handleClassName:"!bg-zinc-400 !size-2 !rounded-sm"}),e.jsx("div",{className:"h-full min-h-[100px] min-w-[150px] rounded-lg border-2 border-dashed border-zinc-400/50 bg-zinc-500/5 dark:bg-zinc-400/5 p-2",children:e.jsx("div",{className:"px-1",children:i?e.jsx("input",{ref:u,className:"w-full bg-transparent text-xs font-medium text-zinc-500 dark:text-zinc-400 outline-none",value:d,onChange:t=>b(t.target.value),onBlur:x,onKeyDown:a}):e.jsx("span",{className:"cursor-text text-xs font-medium text-zinc-500 dark:text-zinc-400",onDoubleClick:m,children:s.label||"Group"})})})]})}const ge={start:Nt,end:wt,process:jt,decision:vt,state:kt,subflow:Ct,note:zt,group:Et},G={type:null,id:null,position:{x:0,y:0}};function Dt({menu:o,onClose:s}){const n=l.useRef(null);return l.useEffect(()=>{if(!o.type)return;function i(d){n.current&&!n.current.contains(d.target)&&s()}function u(d){d.key==="Escape"&&s()}return document.addEventListener("mousedown",i),document.addEventListener("keydown",u),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("keydown",u)}},[o.type,s]),o.type?e.jsxs("div",{ref:n,className:"fixed z-50 min-w-[160px] rounded-md border bg-popover p-1 shadow-md animate-in fade-in-0 zoom-in-95",style:{left:o.position.x,top:o.position.y},children:[o.type==="edge"&&e.jsx(Tt,{edgeId:o.id,onClose:s}),o.type==="node"&&e.jsx(Kt,{nodeId:o.id,onClose:s})]}):null}const St=[{value:"smoothstep",labelKey:"flow.edge.smoothstep",icon:st},{value:"default",labelKey:"flow.edge.bezier",icon:ot},{value:"straight",labelKey:"flow.edge.straight",icon:it},{value:"step",labelKey:"flow.edge.step",icon:nt}],Mt=[{value:"start",labelKey:"flow.node.start",icon:V,color:"#22c55e"},{value:"end",labelKey:"flow.node.end",icon:J,color:"#ef4444"},{value:"process",labelKey:"flow.node.process",icon:A,color:"#3b82f6"},{value:"decision",labelKey:"flow.node.decision",icon:U,color:"#f59e0b"},{value:"state",labelKey:"flow.node.state",icon:W,color:"#8b5cf6"},{value:"subflow",labelKey:"flow.node.subflow",icon:me,color:"#6366f1"}];function Tt({edgeId:o,onClose:s}){const n=I(),i=k(f=>f.edges.find(p=>p.id===o)),u=k(f=>f.updateEdgeType),d=k(f=>f.updateEdgeLabel),b=k(f=>f.toggleEdgeBidirectional),m=k(f=>f.removeEdge),x=i?.type??"smoothstep",a=!!i?.markerStart,[t,N]=l.useState(String(i?.label??"")),g=l.useRef(null),y=l.useCallback(()=>{d(o,t.trim())},[o,t,d]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-2 py-1",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(pe,{className:"size-3.5 shrink-0 text-muted-foreground"}),e.jsx("input",{ref:g,className:"h-6 w-full rounded border bg-background px-1.5 text-xs outline-none focus:border-ring",placeholder:n("flow.edge.label"),value:t,onChange:f=>N(f.target.value),onBlur:y,onKeyDown:f=>{f.key==="Enter"&&(y(),s()),f.stopPropagation()},onClick:f=>f.stopPropagation()})]})}),e.jsx("div",{className:"my-1 border-t"}),e.jsx("div",{className:"px-2 py-1 text-[11px] font-medium text-muted-foreground",children:n("flow.edge.type")}),St.map(f=>e.jsx(L,{icon:f.icon,label:n(f.labelKey),active:x===f.value,onClick:()=>{u(o,f.value),s()}},f.value)),e.jsx("div",{className:"my-1 border-t"}),e.jsx(L,{icon:lt,label:n("flow.edge.bidirectional"),active:a,onClick:()=>{b(o),s()}}),e.jsx("div",{className:"my-1 border-t"}),e.jsx(L,{icon:ie,label:n("flow.edge.delete"),onClick:()=>{m(o),s()},destructive:!0})]})}function Kt({nodeId:o,onClose:s}){const n=I(),i=k(p=>p.nodes.find(v=>v.id===o)),u=k(p=>p.nodes.filter(v=>v.selected).length),d=k(p=>p.updateNodeData),b=k(p=>p.changeNodeType),m=k(p=>p.createGroup),x=k(p=>p.ungroupNodes),a=k(p=>p.removeNode),[t,N]=l.useState(i?.data.label??""),g=l.useCallback(()=>{d(o,{label:t.trim()||i?.data.label||"Node"})},[o,t,i?.data.label,d]),y=i?.type==="group",f=i?.type==="note";return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-2 py-1",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(pe,{className:"size-3.5 shrink-0 text-muted-foreground"}),e.jsx("input",{className:"h-6 w-full rounded border bg-background px-1.5 text-xs outline-none focus:border-ring",placeholder:n("flow.node.label"),value:t,onChange:p=>N(p.target.value),onBlur:g,onKeyDown:p=>{p.key==="Enter"&&(g(),s()),p.stopPropagation()},onClick:p=>p.stopPropagation()})]})}),!y&&!f&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"my-1 border-t"}),e.jsx("div",{className:"px-2 py-1 text-[11px] font-medium text-muted-foreground",children:n("flow.node.type")}),Mt.map(p=>e.jsx(L,{icon:p.icon,iconColor:p.color,label:n(p.labelKey),active:i?.type===p.value,onClick:()=>{b(o,p.value),s()}},p.value))]}),e.jsx("div",{className:"my-1 border-t"}),u>=2&&!y&&e.jsx(L,{icon:xt,label:n("flow.createGroup"),onClick:()=>{m(),s()}}),y&&e.jsx(L,{icon:ht,label:n("flow.ungroup"),onClick:()=>{x(o),s()}}),e.jsx(L,{icon:ie,label:n("flow.node.delete"),onClick:()=>{a(o),s()},destructive:!0})]})}function L({icon:o,label:s,active:n,destructive:i,iconColor:u,onClick:d}){return e.jsxs("button",{className:`flex w-full items-center gap-2 rounded-sm px-2 py-1.5 text-sm hover:bg-accent ${n?"bg-accent/50":""} ${i?"text-destructive hover:text-destructive":""}`,onClick:d,children:[e.jsx(o,{className:"size-3.5",style:u?{color:u}:void 0}),e.jsx("span",{className:"flex-1 text-left",children:s}),n&&e.jsx(xe,{className:"size-3 text-muted-foreground"})]})}function Lt(){const{nodes:o,edges:s,viewport:n,onNodesChange:i,onEdgesChange:u,onConnect:d,setViewport:b,addNode:m}=k(),x=l.useMemo(()=>s.map(w=>({...w,markerEnd:w.markerEnd??{type:le.ArrowClosed,width:24,height:24}})),[s]),[a,t]=l.useState(!1),[N,g]=l.useState(G),y=l.useCallback(w=>{w.preventDefault();const z=w.dataTransfer.getData("application/flow-node-type");if(!z)return;const E=w.currentTarget.getBoundingClientRect(),_={x:(w.clientX-E.left-n.x)/n.zoom,y:(w.clientY-E.top-n.y)/n.zoom};m(z,_)},[m,n]),f=l.useCallback(w=>{w.preventDefault(),w.dataTransfer.dropEffect="move"},[]),p=l.useCallback((w,z)=>b(z),[b]),v=l.useCallback(()=>g(G),[]),M=l.useCallback((w,z,E)=>{E.preventDefault(),g({type:w,id:z,position:{x:E.clientX,y:E.clientY}})},[]),h=l.useCallback((w,z)=>M("edge",z.id,w),[M]),C=l.useCallback((w,z)=>M("edge",z.id,w),[M]),R=l.useCallback((w,z)=>M("node",z.id,w),[M]),O=l.useCallback(()=>{g(G)},[]);return e.jsxs("div",{className:"absolute inset-0",onDrop:y,onDragOver:f,children:[e.jsxs(re,{nodes:o,edges:x,nodeTypes:ge,onNodesChange:i,onEdgesChange:u,onConnect:d,onMoveEnd:p,onEdgeContextMenu:h,onEdgeClick:C,onNodeContextMenu:R,onPaneClick:O,defaultEdgeOptions:{type:"smoothstep"},defaultViewport:n,fitView:o.length>0,deleteKeyCode:["Backspace","Delete"],proOptions:{hideAttribution:!0},className:"bg-background",children:[e.jsx(ce,{variant:de.Dots,gap:16,size:1}),a&&e.jsx(Ie,{nodeStrokeWidth:3,className:"!bg-muted !border-border"})]}),e.jsx(Rt,{}),e.jsx(Dt,{menu:N,onClose:v}),a?e.jsx("button",{className:"absolute bottom-4 right-4 z-10 flex size-5 items-center justify-center rounded-full bg-background/80 shadow backdrop-blur hover:bg-accent",onClick:()=>t(!1),children:e.jsx(fe,{className:"size-3 text-muted-foreground"})}):e.jsx("div",{className:"absolute bottom-3 right-3 z-10",children:e.jsx(T,{variant:"ghost",size:"icon",className:"size-7 border bg-background/80 shadow-md backdrop-blur",onClick:()=>t(!0),children:e.jsx(he,{className:"size-3.5"})})})]})}function Rt(){const{zoomIn:o,zoomOut:s,fitView:n}=Ae();return e.jsxs("div",{className:"absolute bottom-3 left-1/2 z-10 flex -translate-x-1/2 items-center gap-1 rounded-lg border bg-background/80 p-1 shadow-md backdrop-blur",children:[e.jsx(T,{variant:"ghost",size:"icon",className:"size-7",onClick:()=>s(),children:e.jsx(rt,{className:"size-3.5"})}),e.jsx(T,{variant:"ghost",size:"icon",className:"size-7",onClick:()=>n({padding:.2}),children:e.jsx(ct,{className:"size-3.5"})}),e.jsx(T,{variant:"ghost",size:"icon",className:"size-7",onClick:()=>o(),children:e.jsx(dt,{className:"size-3.5"})})]})}const Bt=[{type:"start",icon:V,color:"#22c55e"},{type:"end",icon:J,color:"#ef4444"},{type:"process",icon:A,color:"#3b82f6"},{type:"decision",icon:U,color:"#f59e0b"},{type:"state",icon:W,color:"#8b5cf6"},{type:"note",icon:H,color:"#a3a3a3"}],Ft={start:"Start",end:"End",process:"Process",decision:"Decision?",state:"State",note:"Note"};function $t(){const o=k(h=>h.editingSubFlowId),s=k(h=>h.setEditingSubFlowId),n=k(h=>h.nodes.find(C=>C.id===o)),i=k(h=>h.updateSubFlow),u=I(),[d,b]=l.useState([]),[m,x]=l.useState([]),[a,t]=l.useState({x:0,y:0,zoom:1}),N=l.useMemo(()=>m.map(h=>({...h,markerEnd:h.markerEnd??{type:le.ArrowClosed,width:24,height:24}})),[m]);l.useEffect(()=>{!o||!n||(b(n.data.subNodes??[]),x(n.data.subEdges??[]),t(n.data.subViewport??{x:0,y:0,zoom:1}))},[o]);const g=l.useCallback(()=>{o&&i(o,d,m,a),s(null)},[o,d,m,a,i,s]),y=l.useCallback(h=>{b(C=>Ve(h,C))},[]),f=l.useCallback(h=>{x(C=>Ge(h,C))},[]),p=l.useCallback(h=>{x(C=>We({...h,id:te()},C))},[]),v=l.useCallback((h,C)=>{t(C)},[]),M=l.useCallback(h=>{const C={id:te(),type:h,position:{x:200+Math.random()*200,y:150+Math.random()*200},data:{label:Ft[h]??h}};b(R=>[...R,C])},[]);return o?e.jsx(ye,{open:!0,onOpenChange:h=>{h||g()},children:e.jsxs(Ne,{className:"sm:max-w-[90vw] h-[80vh] flex flex-col p-0 gap-0",children:[e.jsx(we,{className:"px-6 pt-5 pb-0",children:e.jsxs(je,{className:"text-base",children:[u("flow.subflow.title"),": ",n?.data.label??"Sub Flow"]})}),e.jsx("div",{className:"relative flex-1 min-h-0",children:e.jsx(ue,{children:e.jsxs("div",{className:"absolute inset-0 flex flex-col",children:[e.jsx("div",{className:"flex items-center gap-0.5 border-b bg-muted/30 px-3 py-1",children:Bt.map(h=>e.jsxs(B,{children:[e.jsx(F,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"icon",className:"size-7",onClick:()=>M(h.type),children:e.jsx(h.icon,{className:"size-3.5",style:{color:h.color}})})}),e.jsx($,{side:"bottom",children:h.type})]},h.type))}),e.jsx("div",{className:"relative flex-1 min-h-0",children:e.jsx(re,{nodes:d,edges:N,nodeTypes:ge,onNodesChange:y,onEdgesChange:f,onConnect:p,onMoveEnd:v,defaultEdgeOptions:{type:"smoothstep"},defaultViewport:a,fitView:d.length>0,deleteKeyCode:["Backspace","Delete"],proOptions:{hideAttribution:!0},className:"bg-background",children:e.jsx(ce,{variant:de.Dots,gap:16,size:1})})})]})})})]})}):null}const Pt=[{type:"start",icon:V,labelKey:"flow.node.start",color:"#22c55e"},{type:"end",icon:J,labelKey:"flow.node.end",color:"#ef4444"}],Ot=[{type:"process",icon:A,labelKey:"flow.node.process",color:"#3b82f6"},{type:"decision",icon:U,labelKey:"flow.node.decision",color:"#f59e0b"},{type:"state",icon:W,labelKey:"flow.node.state",color:"#8b5cf6"},{type:"subflow",icon:me,labelKey:"flow.node.subflow",color:"#6366f1"}],_t=[{type:"note",icon:H,labelKey:"flow.node.note",color:"#a3a3a3"}],It=[{labelKey:"flow.cat.endpoint",icon:V,nodes:Pt},{labelKey:"flow.cat.logic",icon:A,nodes:Ot},{labelKey:"flow.cat.annotation",icon:H,nodes:_t}];function as(){const{docId:o}=ve(),s=I(),n=ke(),{currentDocument:i}=Ce(),{nodes:u,edges:d,viewport:b,loadFlow:m,addNode:x,undo:a,redo:t,_past:N,_future:g}=k(),[y,f]=l.useState(!1);He(a,t);const p=i?.type==="statemachine"?"statemachine":"flowchart",v=l.useMemo(()=>(p==="statemachine"?Pe:Oe)(u,d),[u,d,p]);l.useEffect(()=>{if(i?.type==="flowchart"||i?.type==="statemachine"){const j=i;m(j.nodes,j.edges,j.viewport)}},[i?.id]);const M=l.useMemo(()=>!i||i.type!=="flowchart"&&i.type!=="statemachine"?null:{...i,nodes:u,edges:d,viewport:b,updatedAt:Date.now()},[i,u,d,b]),h=Je(M),C=Ye(o,h),R=l.useCallback(()=>{const{nodes:j,edges:S}=k.getState(),D=ze(j,S);k.setState({nodes:D.nodes,edges:D.edges})},[]),O=l.useCallback(j=>{const S=200+Math.random()*200,D=150+Math.random()*200;x(j,{x:S,y:D})},[x]),w=l.useCallback(async j=>{if(!await n({title:s("ie.importConfirm"),variant:"destructive"}))return;const D=yt(j);m(D.nodes,D.edges,{x:0,y:0,zoom:1})},[n,s,m]),z=l.useCallback(async j=>{if(await n({title:s("ie.importConfirm"),variant:"destructive"}))try{const D=JSON.parse(j);if(D.type!=="flowchart"&&D.type!=="statemachine")return;m(D.nodes,D.edges,D.viewport)}catch{}},[n,s,m]),E=i?.title||"flow",_=l.useCallback(()=>{Ee(`${E}.mermaid`,v)},[E,v]),Z=l.useCallback(async()=>{if(!v)return;const j=await se(v);De(`${E}.svg`,j)},[E,v]),Y=l.useCallback(async()=>{if(!v)return;const j=await se(v);await Se(`${E}.png`,j)},[E,v]),X=l.useCallback(()=>{i&&Me(`${E}.json`,i)},[i,E]),q=l.useMemo(()=>[{key:"ie.importMermaid",icon:oe,accept:".mermaid,.mmd,.txt",onImport:w},{key:"ie.importJson",icon:ne,accept:".json",onImport:z}],[w,z]),Q=l.useMemo(()=>[{key:"export.currentMermaid",icon:oe,onClick:_},{key:"export.currentSvg",icon:Te,onClick:Z},{key:"export.currentPng",icon:Ke,onClick:Y},{key:"export.currentJson",icon:ne,onClick:X}],[_,Z,Y,X]),ee=l.useMemo(()=>[{key:"ie.mermaidPreview",icon:ut,active:y,onClick:()=>f(j=>!j)}],[y]);return Le(o?e.jsxs(e.Fragment,{children:[e.jsxs(B,{children:[e.jsx(F,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"icon",className:"size-9",onClick:a,disabled:N.length===0,children:e.jsx(Xe,{className:"size-4"})})}),e.jsx($,{side:"top",children:"Undo"})]}),e.jsxs(B,{children:[e.jsx(F,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"icon",className:"size-9",onClick:t,disabled:g.length===0,children:e.jsx(qe,{className:"size-4"})})}),e.jsx($,{side:"top",children:"Redo"})]}),e.jsx(ae,{orientation:"vertical",className:"mx-0.5 h-6"}),It.map(j=>e.jsxs(Re,{children:[e.jsxs(B,{children:[e.jsx(F,{asChild:!0,children:e.jsx(Be,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"icon",className:"size-9",children:e.jsx(j.icon,{className:"size-4"})})})}),e.jsx($,{side:"top",children:s(j.labelKey)})]}),e.jsx(Fe,{align:"start",children:j.nodes.map(S=>e.jsxs($e,{onClick:()=>O(S.type),children:[e.jsx(S.icon,{className:"size-4 mr-2 shrink-0",style:{color:S.color}}),s(S.labelKey)]},S.type))})]},j.labelKey)),e.jsx(ae,{orientation:"vertical",className:"mx-0.5 h-6"}),e.jsxs(B,{children:[e.jsx(F,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"icon",className:"size-9",onClick:R,children:e.jsx(at,{className:"size-4"})})}),e.jsx($,{side:"top",children:"Auto Layout"})]}),e.jsx(Ue,{imports:q,exports:Q,toggles:ee}),e.jsx(Ze,{section:"流程圖 / 狀態機"})]}):null,[o,O,R,q,Q,ee,a,t,N,g,s]),o?e.jsxs(ue,{children:[e.jsxs("div",{className:"relative flex size-full flex-col",children:[e.jsx("div",{className:"relative min-h-0 flex-1",children:e.jsx(Lt,{})}),y&&e.jsx(tt,{code:v}),C!=="idle"&&e.jsx(et,{status:C})]}),e.jsx($t,{})]}):e.jsx(Qe,{docTypes:["flowchart","statemachine"],routePath:"flow",defaultDocType:"flowchart"})}export{as as default};
