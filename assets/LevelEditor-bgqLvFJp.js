import{c as F,aZ as qe,a_ as pe,r as h,j as e,dC as Ee,aB as ce,bN as he,b3 as Qe,X as fe,B,cZ as et,a$ as G,b0 as Z,b1 as J,bL as Ye,aN as me,I as V,bU as tt,bP as st,ar as be,b2 as at,aF as ot,aH as rt,bV as lt,dD as it,bW as Ae,cF as nt,bQ as we,b6 as ct,b7 as dt,b8 as pt,ba as ut,bX as mt}from"./index-BO31ZqPg.js";import{M as Oe,a as gt,b as xt,c as ht,H as d,P as p,i as bt,B as yt,d as ft,f as vt,u as jt,e as Nt,R as kt}from"./useUndoRedoKeys-CBEPday8.js";import{u as zt,I as wt,T as Ce}from"./useAutoSave-CfhZAdWB.js";import{u as Ct,U as St,R as Mt,D as Et,S as Se}from"./useDocumentSwitch-B2mv6tdu.js";import{c as Tt,Z as Ue,M as $e,a as Xe,S as Ve}from"./createHistorySlice-BPQGD6VD.js";import{H as ve}from"./house-D4_r5Lde.js";import{E as je,W as Lt,S as Dt,C as Rt,L as Kt}from"./waypoints-Bd-eVwOl.js";import{S as Ne}from"./sticky-note-b93n8WRu.js";import{U as Te}from"./user-BWss316X.js";import{Z as Le,U as Pt}from"./zap-CBg9d_PT.js";import{T as He}from"./tag-D7WN3Vb4.js";import{M as It}from"./minus-Dwx08JAk.js";import{A as Bt}from"./arrow-left-right-CMvaBUNi.js";import{U as _t}from"./upload-Cw5zcpJ-.js";import{L as At}from"./layers-DmA3btjA.js";import"./value-kwUSg1GE.js";import"./useReadmeHelp-Dp5zdwnQ.js";const Yt=[["path",{d:"M21 21H8a2 2 0 0 1-1.42-.587l-3.994-3.999a2 2 0 0 1 0-2.828l10-10a2 2 0 0 1 2.829 0l5.999 6a2 2 0 0 1 0 2.828L12.834 21",key:"g5wo59"}],["path",{d:"m5.082 11.09 8.828 8.828",key:"1wx5vj"}]],We=F("eraser",Yt);const Ot=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],Ut=F("eye-off",Ot);const $t=[["path",{d:"M4 22V4a1 1 0 0 1 .4-.8A6 6 0 0 1 8 2c3 0 5 2 7.333 2q2 0 3.067-.8A1 1 0 0 1 20 4v10a1 1 0 0 1-.4.8A6 6 0 0 1 16 16c-3 0-5-2-8-2a6 6 0 0 0-4 1.528",key:"1jaruq"}]],De=F("flag",$t);const Xt=[["path",{d:"M10.5 3 8 9l4 13 4-13-2.5-6",key:"b3dvk1"}],["path",{d:"M17 3a2 2 0 0 1 1.6.8l3 4a2 2 0 0 1 .013 2.382l-7.99 10.986a2 2 0 0 1-3.247 0l-7.99-10.986A2 2 0 0 1 2.4 7.8l2.998-3.997A2 2 0 0 1 7 3z",key:"7w4byz"}],["path",{d:"M2 9h20",key:"16fsjt"}]],Re=F("gem",Xt);const Vt=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]],Ht=F("grid-3x3",Vt);const Wt=[["path",{d:"M16 5h6",key:"1vod17"}],["path",{d:"M19 2v6",key:"4bpg5p"}],["path",{d:"M21 11.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7.5",key:"1ue2ih"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}]],Ft=F("image-plus",Wt);const Gt=[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]],ye=F("map-pin",Gt);const Zt=[["rect",{x:"16",y:"16",width:"6",height:"6",rx:"1",key:"4q2zg0"}],["rect",{x:"2",y:"16",width:"6",height:"6",rx:"1",key:"8cvhb9"}],["rect",{x:"9",y:"2",width:"6",height:"6",rx:"1",key:"1egb70"}],["path",{d:"M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3",key:"1jsf9p"}],["path",{d:"M12 12V8",key:"2874zd"}]],Jt=F("network",Zt);const qt=[["path",{d:"M11 7 6 2",key:"1jwth8"}],["path",{d:"M18.992 12H2.041",key:"xw1gg"}],["path",{d:"M21.145 18.38A3.34 3.34 0 0 1 20 16.5a3.3 3.3 0 0 1-1.145 1.88c-.575.46-.855 1.02-.855 1.595A2 2 0 0 0 20 22a2 2 0 0 0 2-2.025c0-.58-.285-1.13-.855-1.595",key:"1nkol4"}],["path",{d:"m8.5 4.5 2.148-2.148a1.205 1.205 0 0 1 1.704 0l7.296 7.296a1.205 1.205 0 0 1 0 1.704l-7.592 7.592a3.615 3.615 0 0 1-5.112 0l-3.888-3.888a3.615 3.615 0 0 1 0-5.112L5.67 7.33",key:"1nk1rd"}]],Fe=F("paint-bucket",qt);const Qt=[["path",{d:"m14.622 17.897-10.68-2.913",key:"vj2p1u"}],["path",{d:"M18.376 2.622a1 1 0 1 1 3.002 3.002L17.36 9.643a.5.5 0 0 0 0 .707l.944.944a2.41 2.41 0 0 1 0 3.408l-.944.944a.5.5 0 0 1-.707 0L8.354 7.348a.5.5 0 0 1 0-.707l.944-.944a2.41 2.41 0 0 1 3.408 0l.944.944a.5.5 0 0 0 .707 0z",key:"18tc5c"}],["path",{d:"M9 8c-1.804 2.71-3.97 3.46-6.583 3.948a.507.507 0 0 0-.302.819l7.32 8.883a1 1 0 0 0 1.185.204C12.735 20.405 16 16.792 16 15",key:"ytzfxy"}]],Ge=F("paintbrush",Qt);const es=[["path",{d:"M16 10a4 4 0 0 1-8 0",key:"1ltviw"}],["path",{d:"M3.103 6.034h17.794",key:"awc11p"}],["path",{d:"M3.4 5.467a2 2 0 0 0-.4 1.2V20a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6.667a2 2 0 0 0-.4-1.2l-2-2.667A2 2 0 0 0 17 2H7a2 2 0 0 0-1.6.8z",key:"o988cm"}]],Ke=F("shopping-bag",es);const ts=[["path",{d:"m12.5 17-.5-1-.5 1h1z",key:"3me087"}],["path",{d:"M15 22a1 1 0 0 0 1-1v-1a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20v1a1 1 0 0 0 1 1z",key:"1o5pge"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}]],Pe=F("skull",ts);const ss=[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]],Ze=F("star",ss);const as=[["path",{d:"m11 19-6-6",key:"s7kpr"}],["path",{d:"m5 21-2-2",key:"1kw20b"}],["path",{d:"m8 16-4 4",key:"1oqv8h"}],["path",{d:"M9.5 17.5 21 6V3h-3L6.5 14.5",key:"pkxemp"}]],ke=F("sword",as);function os(l){return l.map(({measured:s,...i})=>i)}const rs={room:"Room",spawn:"Spawn",boss:"Boss",shop:"Shop",secret:"Secret",exit:"Exit",note:"Note",enemy:"Enemy",item:"Item",npc:"NPC",trigger:"Trigger"},R=qe()((...l)=>{const[s,i]=l;return{...Tt(t=>({nodes:os(t.nodes),edges:t.edges,markers:t.markers,backgroundUrl:t.backgroundUrl,layers:t.layers,palette:t.palette,entities:t.entities,gridWidth:t.gridWidth,gridHeight:t.gridHeight,tileSize:t.tileSize}),t=>({nodes:t.nodes,edges:t.edges,markers:t.markers,backgroundUrl:t.backgroundUrl,layers:t.layers,palette:t.palette,entities:t.entities,gridWidth:t.gridWidth,gridHeight:t.gridHeight,tileSize:t.tileSize}))(...l),mode:"node-graph",nodes:[],edges:[],viewport:{x:0,y:0,zoom:1},markers:[],backgroundUrl:void 0,selectedMarkerId:null,mapViewport:{x:0,y:0,zoom:1},gridWidth:16,gridHeight:12,tileSize:32,palette:[],layers:[],activeLayerId:null,activePaletteIdx:0,gridTool:"brush",gridViewport:{x:0,y:0,zoom:1},entityType:"enemy",entities:[],selectedEntityId:null,onNodesChange(t){const a=i();for(const o of t){if(o.type==="position"&&o.dragging&&!a._isDragging){a.pushSnapshot(),s({_isDragging:!0});break}if(o.type==="position"&&!o.dragging&&a._isDragging){s({_isDragging:!1});break}}t.some(o=>o.type==="remove")&&a.pushSnapshot(),s({nodes:ht(t,a.nodes)})},onEdgesChange(t){const a=i();t.some(o=>o.type==="remove")&&a.pushSnapshot(),s({edges:xt(t,a.edges)})},onConnect(t){i().pushSnapshot(),s({edges:gt({...t,id:pe(),type:"smoothstep"},i().edges)})},setViewport(t){s({viewport:t})},addNode(t,a,o){i().pushSnapshot();const r={id:pe(),type:t,position:a,data:{label:o??rs[t],nodeType:t}};s(n=>({nodes:[...n.nodes,r]}))},updateNodeData(t,a){i().pushSnapshot(),s(o=>({nodes:o.nodes.map(r=>r.id===t?{...r,data:{...r.data,...a}}:r)}))},removeNode(t){i().pushSnapshot(),s(a=>({nodes:a.nodes.filter(o=>o.id!==t),edges:a.edges.filter(o=>o.source!==t&&o.target!==t)}))},removeSelected(){i().pushSnapshot(),s(t=>{const a=new Set(t.nodes.filter(o=>o.selected).map(o=>o.id));return{nodes:t.nodes.filter(o=>!o.selected),edges:t.edges.filter(o=>!o.selected&&!a.has(o.source)&&!a.has(o.target))}})},updateEdgeType(t,a){i().pushSnapshot(),s(o=>({edges:o.edges.map(r=>r.id===t?{...r,type:a}:r)}))},updateEdgeLabel(t,a){i().pushSnapshot(),s(o=>({edges:o.edges.map(r=>r.id===t?{...r,label:a||void 0}:r)}))},toggleEdgeBidirectional(t){i().pushSnapshot(),s(a=>({edges:a.edges.map(o=>{if(o.id!==t)return o;const r=!!o.markerStart;return{...o,markerStart:r?void 0:{type:Oe.ArrowClosed,width:24,height:24}}})}))},removeEdge(t){i().pushSnapshot(),s(a=>({edges:a.edges.filter(o=>o.id!==t)}))},setMode(t){s({mode:t})},setBackgroundUrl(t){i().pushSnapshot(),s({backgroundUrl:t})},setMapViewport(t){s({mapViewport:t})},selectMarker(t){s({selectedMarkerId:t})},addMarker(t,a,o){i().pushSnapshot();const r={id:pe(),type:t,x:a,y:o,label:t==="poi"?"POI":"Area",color:t==="poi"?"#3b82f6":"#3b82f620",width:t==="area"?200:void 0,height:t==="area"?150:void 0};s(n=>({markers:[...n.markers,r],selectedMarkerId:r.id}))},updateMarker(t,a){i().pushSnapshot(),s(o=>({markers:o.markers.map(r=>r.id===t?{...r,...a}:r)}))},removeMarker(t){i().pushSnapshot(),s(a=>({markers:a.markers.filter(o=>o.id!==t),selectedMarkerId:a.selectedMarkerId===t?null:a.selectedMarkerId}))},addEntity(t,a,o){i().pushSnapshot();const r={enemy:"#f43f5e",item:"#d97706",npc:"#10b981",trigger:"#06b6d4"},n={enemy:"Enemy",item:"Item",npc:"NPC",trigger:"Trigger"},u={id:pe(),type:t,row:a,col:o,label:n[t],color:r[t]};s(v=>({entities:[...v.entities,u],selectedEntityId:u.id}))},updateEntity(t,a){i().pushSnapshot(),s(o=>({entities:o.entities.map(r=>r.id===t?{...r,...a}:r)}))},removeEntity(t){i().pushSnapshot(),s(a=>({entities:a.entities.filter(o=>o.id!==t),selectedEntityId:a.selectedEntityId===t?null:a.selectedEntityId}))},selectEntity(t){s({selectedEntityId:t})},setEntityType(t){s({entityType:t})},setGridViewport(t){s({gridViewport:t})},setGridSize(t,a){i().pushSnapshot(),s(o=>{const r=o.layers.map(n=>{const u=[];for(let v=0;v<a;v++){const g=[];for(let M=0;M<t;M++)g.push(n.data[v]?.[M]??-1);u.push(g)}return{...n,data:u}});return{gridWidth:t,gridHeight:a,layers:r}})},setTileSize(t){i().pushSnapshot(),s({tileSize:t})},addPalette(t,a){i().pushSnapshot();const o={id:pe(),name:t,color:a};s(r=>({palette:[...r.palette,o]}))},updatePalette(t,a){i().pushSnapshot(),s(o=>({palette:o.palette.map(r=>r.id===t?{...r,...a}:r)}))},removePalette(t){i().pushSnapshot(),s(a=>{const o=a.palette.findIndex(n=>n.id===t);if(o<0)return a;const r=a.layers.map(n=>({...n,data:n.data.map(u=>u.map(v=>v===o?-1:v>o?v-1:v))}));return{palette:a.palette.filter(n=>n.id!==t),layers:r,activePaletteIdx:Math.min(a.activePaletteIdx,a.palette.length-2)}})},setActivePaletteIdx(t){s({activePaletteIdx:t})},setGridTool(t){s({gridTool:t})},addLayer(t){i().pushSnapshot();const{gridWidth:a,gridHeight:o}=i(),r=Array.from({length:o},()=>Array.from({length:a},()=>-1)),n={id:pe(),name:t,visible:!0,data:r};s(u=>({layers:[...u.layers,n],activeLayerId:n.id}))},removeLayer(t){i().pushSnapshot(),s(a=>({layers:a.layers.filter(o=>o.id!==t),activeLayerId:a.activeLayerId===t?a.layers[0]?.id??null:a.activeLayerId}))},toggleLayerVisibility(t){s(a=>({layers:a.layers.map(o=>o.id===t?{...o,visible:!o.visible}:o)}))},setActiveLayer(t){s({activeLayerId:t})},renameLayer(t,a){s(o=>({layers:o.layers.map(r=>r.id===t?{...r,name:a}:r)}))},paintCell(t,a,o,r){const n=i();n._strokeActive||(n.pushSnapshot(),s({_strokeActive:!0})),s(u=>({layers:u.layers.map(v=>{if(v.id!==t)return v;const g=v.data.map((M,j)=>j===a?M.map((U,N)=>N===o?r:U):M);return{...v,data:g}})}))},fillArea(t,a,o,r){i().pushSnapshot(),s(n=>{const u=n.layers.find(N=>N.id===t);if(!u)return n;const v=u.data[a]?.[o];if(v===void 0||v===r)return n;const g=u.data.map(N=>[...N]),M=[[a,o]],j=g.length,U=g[0]?.length??0;for(;M.length>0;){const[N,A]=M.pop();N<0||N>=j||A<0||A>=U||g[N][A]===v&&(g[N][A]=r,M.push([N-1,A],[N+1,A],[N,A-1],[N,A+1]))}return{layers:n.layers.map(N=>N.id===t?{...N,data:g}:N)}})},loadLevel(t,a,o){s({nodes:t.map(r=>r.selected?{...r,selected:!1}:r),edges:a.map(r=>r.selected?{...r,selected:!1}:r),viewport:o})},loadMapMarker(t,a){s({markers:t,backgroundUrl:a,selectedMarkerId:null})},loadGrid(t,a,o,r,n,u){s({gridWidth:t,gridHeight:a,tileSize:o,palette:r,layers:n,entities:u??[],activeLayerId:n[0]?.id??null,activePaletteIdx:0,selectedEntityId:null}),i().clearHistory()},reset(){s({nodes:[],edges:[],viewport:{x:0,y:0,zoom:1},markers:[],backgroundUrl:void 0,selectedMarkerId:null,mapViewport:{x:0,y:0,zoom:1},gridWidth:16,gridHeight:12,tileSize:32,palette:[],layers:[],activeLayerId:null,activePaletteIdx:0,gridTool:"brush",gridViewport:{x:0,y:0,zoom:1},entities:[],selectedEntityId:null}),i().clearHistory()}}});function se(l,s){const[i,y]=h.useState(!1),[t,a]=h.useState(s),o=h.useRef(null),r=R(g=>g.updateNodeData),n=h.useCallback(()=>{a(s),y(!0),setTimeout(()=>o.current?.focus(),0)},[s]),u=h.useCallback(()=>{y(!1);const g=t.trim();g&&g!==s&&r(l,{label:g})},[t,s,l,r]),v=h.useCallback(g=>{g.key==="Enter"&&u(),g.key==="Escape"&&(a(s),y(!1))},[u,s]);return{editing:i,inputRef:o,label:t,setLabel:a,startEdit:n,commitEdit:u,handleKeyDown:v}}function Ie({difficulty:l}){if(!l||l<=0)return null;const s=Math.min(l,5);return e.jsx("div",{className:"mt-1 flex gap-0.5",children:Array.from({length:s},(i,y)=>e.jsx(Ze,{className:"size-2.5 fill-amber-400 text-amber-400"},y))})}function ls({id:l,data:s,selected:i}){const{editing:y,inputRef:t,label:a,setLabel:o,startEdit:r,commitEdit:n,handleKeyDown:u}=se(l,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-lg border-2 bg-sky-500/20 px-4 py-3 dark:bg-sky-500/30 ${i?"border-sky-400 ring-2 ring-sky-400/50":"border-sky-500/50"}`,style:s.color?{borderColor:s.color}:void 0,children:[e.jsx(d,{type:"target",id:"top",position:p.Top,className:"!size-2 !bg-sky-500"}),e.jsx(d,{type:"source",id:"top-src",position:p.Top,className:"!size-2 !bg-sky-500"}),e.jsx(d,{type:"target",id:"right",position:p.Right,className:"!size-2 !bg-sky-500"}),e.jsx(d,{type:"source",id:"right-src",position:p.Right,className:"!size-2 !bg-sky-500"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ve,{className:"size-3.5 shrink-0 text-sky-600 dark:text-sky-300"}),y?e.jsx("input",{ref:t,className:"w-full bg-transparent text-sm outline-none",value:a,onChange:v=>o(v.target.value),onBlur:n,onKeyDown:u}):e.jsx("span",{className:"cursor-text text-sm font-medium text-sky-700 dark:text-sky-200",onDoubleClick:r,children:s.label||"Room"})]}),e.jsx(Ie,{difficulty:s.difficulty}),e.jsx(d,{type:"target",id:"bottom",position:p.Bottom,className:"!size-2 !bg-sky-500"}),e.jsx(d,{type:"source",id:"bottom-src",position:p.Bottom,className:"!size-2 !bg-sky-500"}),e.jsx(d,{type:"target",id:"left",position:p.Left,className:"!size-2 !bg-sky-500"}),e.jsx(d,{type:"source",id:"left-src",position:p.Left,className:"!size-2 !bg-sky-500"})]})}function is({id:l,data:s,selected:i}){const{editing:y,inputRef:t,label:a,setLabel:o,startEdit:r,commitEdit:n,handleKeyDown:u}=se(l,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-lg border-2 bg-green-500/20 px-4 py-3 dark:bg-green-500/30 ${i?"border-green-400 ring-2 ring-green-400/50":"border-green-500/50"}`,children:[e.jsx(d,{type:"target",id:"top",position:p.Top,className:"!size-2 !bg-green-500"}),e.jsx(d,{type:"source",id:"top-src",position:p.Top,className:"!size-2 !bg-green-500"}),e.jsx(d,{type:"target",id:"right",position:p.Right,className:"!size-2 !bg-green-500"}),e.jsx(d,{type:"source",id:"right-src",position:p.Right,className:"!size-2 !bg-green-500"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(De,{className:"size-3.5 shrink-0 text-green-600 dark:text-green-300"}),y?e.jsx("input",{ref:t,className:"w-full bg-transparent text-sm outline-none",value:a,onChange:v=>o(v.target.value),onBlur:n,onKeyDown:u}):e.jsx("span",{className:"cursor-text text-sm font-medium text-green-700 dark:text-green-200",onDoubleClick:r,children:s.label||"Spawn"})]}),e.jsx(d,{type:"target",id:"bottom",position:p.Bottom,className:"!size-2 !bg-green-500"}),e.jsx(d,{type:"source",id:"bottom-src",position:p.Bottom,className:"!size-2 !bg-green-500"}),e.jsx(d,{type:"target",id:"left",position:p.Left,className:"!size-2 !bg-green-500"}),e.jsx(d,{type:"source",id:"left-src",position:p.Left,className:"!size-2 !bg-green-500"})]})}function ns({id:l,data:s,selected:i}){const{editing:y,inputRef:t,label:a,setLabel:o,startEdit:r,commitEdit:n,handleKeyDown:u}=se(l,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-lg border-2 bg-red-500/20 px-4 py-3 dark:bg-red-500/30 ${i?"border-red-400 ring-2 ring-red-400/50":"border-red-500/50"}`,children:[e.jsx(d,{type:"target",id:"top",position:p.Top,className:"!size-2 !bg-red-500"}),e.jsx(d,{type:"source",id:"top-src",position:p.Top,className:"!size-2 !bg-red-500"}),e.jsx(d,{type:"target",id:"right",position:p.Right,className:"!size-2 !bg-red-500"}),e.jsx(d,{type:"source",id:"right-src",position:p.Right,className:"!size-2 !bg-red-500"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Pe,{className:"size-3.5 shrink-0 text-red-600 dark:text-red-300"}),y?e.jsx("input",{ref:t,className:"w-full bg-transparent text-sm outline-none",value:a,onChange:v=>o(v.target.value),onBlur:n,onKeyDown:u}):e.jsx("span",{className:"cursor-text text-sm font-medium text-red-700 dark:text-red-200",onDoubleClick:r,children:s.label||"Boss"})]}),e.jsx(Ie,{difficulty:s.difficulty}),e.jsx(d,{type:"target",id:"bottom",position:p.Bottom,className:"!size-2 !bg-red-500"}),e.jsx(d,{type:"source",id:"bottom-src",position:p.Bottom,className:"!size-2 !bg-red-500"}),e.jsx(d,{type:"target",id:"left",position:p.Left,className:"!size-2 !bg-red-500"}),e.jsx(d,{type:"source",id:"left-src",position:p.Left,className:"!size-2 !bg-red-500"})]})}function cs({id:l,data:s,selected:i}){const{editing:y,inputRef:t,label:a,setLabel:o,startEdit:r,commitEdit:n,handleKeyDown:u}=se(l,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-lg border-2 bg-amber-500/20 px-4 py-3 dark:bg-amber-500/30 ${i?"border-amber-400 ring-2 ring-amber-400/50":"border-amber-500/50"}`,children:[e.jsx(d,{type:"target",id:"top",position:p.Top,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"source",id:"top-src",position:p.Top,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"target",id:"right",position:p.Right,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"source",id:"right-src",position:p.Right,className:"!size-2 !bg-amber-500"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ke,{className:"size-3.5 shrink-0 text-amber-600 dark:text-amber-300"}),y?e.jsx("input",{ref:t,className:"w-full bg-transparent text-sm outline-none",value:a,onChange:v=>o(v.target.value),onBlur:n,onKeyDown:u}):e.jsx("span",{className:"cursor-text text-sm font-medium text-amber-700 dark:text-amber-200",onDoubleClick:r,children:s.label||"Shop"})]}),e.jsx(d,{type:"target",id:"bottom",position:p.Bottom,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"source",id:"bottom-src",position:p.Bottom,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"target",id:"left",position:p.Left,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"source",id:"left-src",position:p.Left,className:"!size-2 !bg-amber-500"})]})}function ds({id:l,data:s,selected:i}){const{editing:y,inputRef:t,label:a,setLabel:o,startEdit:r,commitEdit:n,handleKeyDown:u}=se(l,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-lg border-2 border-dashed bg-purple-500/20 px-4 py-3 dark:bg-purple-500/30 ${i?"border-purple-400 ring-2 ring-purple-400/50":"border-purple-500/50"}`,children:[e.jsx(d,{type:"target",id:"top",position:p.Top,className:"!size-2 !bg-purple-500"}),e.jsx(d,{type:"source",id:"top-src",position:p.Top,className:"!size-2 !bg-purple-500"}),e.jsx(d,{type:"target",id:"right",position:p.Right,className:"!size-2 !bg-purple-500"}),e.jsx(d,{type:"source",id:"right-src",position:p.Right,className:"!size-2 !bg-purple-500"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(je,{className:"size-3.5 shrink-0 text-purple-600 dark:text-purple-300"}),y?e.jsx("input",{ref:t,className:"w-full bg-transparent text-sm outline-none",value:a,onChange:v=>o(v.target.value),onBlur:n,onKeyDown:u}):e.jsx("span",{className:"cursor-text text-sm font-medium text-purple-700 dark:text-purple-200",onDoubleClick:r,children:s.label||"Secret"})]}),e.jsx(d,{type:"target",id:"bottom",position:p.Bottom,className:"!size-2 !bg-purple-500"}),e.jsx(d,{type:"source",id:"bottom-src",position:p.Bottom,className:"!size-2 !bg-purple-500"}),e.jsx(d,{type:"target",id:"left",position:p.Left,className:"!size-2 !bg-purple-500"}),e.jsx(d,{type:"source",id:"left-src",position:p.Left,className:"!size-2 !bg-purple-500"})]})}function ps({id:l,data:s,selected:i}){const{editing:y,inputRef:t,label:a,setLabel:o,startEdit:r,commitEdit:n,handleKeyDown:u}=se(l,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-lg border-2 bg-orange-500/20 px-4 py-3 dark:bg-orange-500/30 ${i?"border-orange-400 ring-2 ring-orange-400/50":"border-orange-500/50"}`,children:[e.jsx(d,{type:"target",id:"top",position:p.Top,className:"!size-2 !bg-orange-500"}),e.jsx(d,{type:"source",id:"top-src",position:p.Top,className:"!size-2 !bg-orange-500"}),e.jsx(d,{type:"target",id:"right",position:p.Right,className:"!size-2 !bg-orange-500"}),e.jsx(d,{type:"source",id:"right-src",position:p.Right,className:"!size-2 !bg-orange-500"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ee,{className:"size-3.5 shrink-0 text-orange-600 dark:text-orange-300"}),y?e.jsx("input",{ref:t,className:"w-full bg-transparent text-sm outline-none",value:a,onChange:v=>o(v.target.value),onBlur:n,onKeyDown:u}):e.jsx("span",{className:"cursor-text text-sm font-medium text-orange-700 dark:text-orange-200",onDoubleClick:r,children:s.label||"Exit"})]}),e.jsx(d,{type:"target",id:"bottom",position:p.Bottom,className:"!size-2 !bg-orange-500"}),e.jsx(d,{type:"source",id:"bottom-src",position:p.Bottom,className:"!size-2 !bg-orange-500"}),e.jsx(d,{type:"target",id:"left",position:p.Left,className:"!size-2 !bg-orange-500"}),e.jsx(d,{type:"source",id:"left-src",position:p.Left,className:"!size-2 !bg-orange-500"})]})}function us({id:l,data:s,selected:i}){const{editing:y,inputRef:t,label:a,setLabel:o,startEdit:r,commitEdit:n,handleKeyDown:u}=se(l,s.label);return e.jsxs("div",{className:`min-w-[100px] rounded border-2 bg-neutral-500/10 px-3 py-2 dark:bg-neutral-500/20 ${i?"border-neutral-400 ring-2 ring-neutral-400/50":"border-neutral-400/40"}`,children:[e.jsx(d,{type:"target",id:"top",position:p.Top,className:"!size-2 !bg-neutral-400"}),e.jsx(d,{type:"source",id:"top-src",position:p.Top,className:"!size-2 !bg-neutral-400"}),e.jsx(d,{type:"target",id:"right",position:p.Right,className:"!size-2 !bg-neutral-400"}),e.jsx(d,{type:"source",id:"right-src",position:p.Right,className:"!size-2 !bg-neutral-400"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ne,{className:"size-3 shrink-0 text-neutral-500"}),y?e.jsx("input",{ref:t,className:"w-full bg-transparent text-xs outline-none",value:a,onChange:v=>o(v.target.value),onBlur:n,onKeyDown:u}):e.jsx("span",{className:"cursor-text text-xs text-muted-foreground",onDoubleClick:r,children:s.label||"Note"})]}),e.jsx(d,{type:"target",id:"bottom",position:p.Bottom,className:"!size-2 !bg-neutral-400"}),e.jsx(d,{type:"source",id:"bottom-src",position:p.Bottom,className:"!size-2 !bg-neutral-400"}),e.jsx(d,{type:"target",id:"left",position:p.Left,className:"!size-2 !bg-neutral-400"}),e.jsx(d,{type:"source",id:"left-src",position:p.Left,className:"!size-2 !bg-neutral-400"})]})}function ms({id:l,data:s,selected:i}){const{editing:y,inputRef:t,label:a,setLabel:o,startEdit:r,commitEdit:n,handleKeyDown:u}=se(l,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-lg border-2 bg-rose-500/20 px-4 py-3 dark:bg-rose-500/30 ${i?"border-rose-400 ring-2 ring-rose-400/50":"border-rose-500/50"}`,style:s.color?{borderColor:s.color}:void 0,children:[e.jsx(d,{type:"target",id:"top",position:p.Top,className:"!size-2 !bg-rose-500"}),e.jsx(d,{type:"source",id:"top-src",position:p.Top,className:"!size-2 !bg-rose-500"}),e.jsx(d,{type:"target",id:"right",position:p.Right,className:"!size-2 !bg-rose-500"}),e.jsx(d,{type:"source",id:"right-src",position:p.Right,className:"!size-2 !bg-rose-500"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ke,{className:"size-3.5 shrink-0 text-rose-600 dark:text-rose-300"}),y?e.jsx("input",{ref:t,className:"w-full bg-transparent text-sm outline-none",value:a,onChange:v=>o(v.target.value),onBlur:n,onKeyDown:u}):e.jsx("span",{className:"cursor-text text-sm font-medium text-rose-700 dark:text-rose-200",onDoubleClick:r,children:s.label||"Enemy"})]}),e.jsx(Ie,{difficulty:s.difficulty}),e.jsx(d,{type:"target",id:"bottom",position:p.Bottom,className:"!size-2 !bg-rose-500"}),e.jsx(d,{type:"source",id:"bottom-src",position:p.Bottom,className:"!size-2 !bg-rose-500"}),e.jsx(d,{type:"target",id:"left",position:p.Left,className:"!size-2 !bg-rose-500"}),e.jsx(d,{type:"source",id:"left-src",position:p.Left,className:"!size-2 !bg-rose-500"})]})}function gs({id:l,data:s,selected:i}){const{editing:y,inputRef:t,label:a,setLabel:o,startEdit:r,commitEdit:n,handleKeyDown:u}=se(l,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-lg border-2 bg-amber-500/20 px-4 py-3 dark:bg-amber-500/30 ${i?"border-amber-400 ring-2 ring-amber-400/50":"border-amber-500/50"}`,style:s.color?{borderColor:s.color}:void 0,children:[e.jsx(d,{type:"target",id:"top",position:p.Top,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"source",id:"top-src",position:p.Top,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"target",id:"right",position:p.Right,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"source",id:"right-src",position:p.Right,className:"!size-2 !bg-amber-500"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Re,{className:"size-3.5 shrink-0 text-amber-600 dark:text-amber-300"}),y?e.jsx("input",{ref:t,className:"w-full bg-transparent text-sm outline-none",value:a,onChange:v=>o(v.target.value),onBlur:n,onKeyDown:u}):e.jsx("span",{className:"cursor-text text-sm font-medium text-amber-700 dark:text-amber-200",onDoubleClick:r,children:s.label||"Item"})]}),e.jsx(d,{type:"target",id:"bottom",position:p.Bottom,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"source",id:"bottom-src",position:p.Bottom,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"target",id:"left",position:p.Left,className:"!size-2 !bg-amber-500"}),e.jsx(d,{type:"source",id:"left-src",position:p.Left,className:"!size-2 !bg-amber-500"})]})}function xs({id:l,data:s,selected:i}){const{editing:y,inputRef:t,label:a,setLabel:o,startEdit:r,commitEdit:n,handleKeyDown:u}=se(l,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-lg border-2 bg-emerald-500/20 px-4 py-3 dark:bg-emerald-500/30 ${i?"border-emerald-400 ring-2 ring-emerald-400/50":"border-emerald-500/50"}`,style:s.color?{borderColor:s.color}:void 0,children:[e.jsx(d,{type:"target",id:"top",position:p.Top,className:"!size-2 !bg-emerald-500"}),e.jsx(d,{type:"source",id:"top-src",position:p.Top,className:"!size-2 !bg-emerald-500"}),e.jsx(d,{type:"target",id:"right",position:p.Right,className:"!size-2 !bg-emerald-500"}),e.jsx(d,{type:"source",id:"right-src",position:p.Right,className:"!size-2 !bg-emerald-500"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Te,{className:"size-3.5 shrink-0 text-emerald-600 dark:text-emerald-300"}),y?e.jsx("input",{ref:t,className:"w-full bg-transparent text-sm outline-none",value:a,onChange:v=>o(v.target.value),onBlur:n,onKeyDown:u}):e.jsx("span",{className:"cursor-text text-sm font-medium text-emerald-700 dark:text-emerald-200",onDoubleClick:r,children:s.label||"NPC"})]}),e.jsx(d,{type:"target",id:"bottom",position:p.Bottom,className:"!size-2 !bg-emerald-500"}),e.jsx(d,{type:"source",id:"bottom-src",position:p.Bottom,className:"!size-2 !bg-emerald-500"}),e.jsx(d,{type:"target",id:"left",position:p.Left,className:"!size-2 !bg-emerald-500"}),e.jsx(d,{type:"source",id:"left-src",position:p.Left,className:"!size-2 !bg-emerald-500"})]})}function hs({id:l,data:s,selected:i}){const{editing:y,inputRef:t,label:a,setLabel:o,startEdit:r,commitEdit:n,handleKeyDown:u}=se(l,s.label);return e.jsxs("div",{className:`min-w-[120px] rounded-lg border-2 bg-cyan-500/20 px-4 py-3 dark:bg-cyan-500/30 ${i?"border-cyan-400 ring-2 ring-cyan-400/50":"border-cyan-500/50"}`,style:s.color?{borderColor:s.color}:void 0,children:[e.jsx(d,{type:"target",id:"top",position:p.Top,className:"!size-2 !bg-cyan-500"}),e.jsx(d,{type:"source",id:"top-src",position:p.Top,className:"!size-2 !bg-cyan-500"}),e.jsx(d,{type:"target",id:"right",position:p.Right,className:"!size-2 !bg-cyan-500"}),e.jsx(d,{type:"source",id:"right-src",position:p.Right,className:"!size-2 !bg-cyan-500"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Le,{className:"size-3.5 shrink-0 text-cyan-600 dark:text-cyan-300"}),y?e.jsx("input",{ref:t,className:"w-full bg-transparent text-sm outline-none",value:a,onChange:v=>o(v.target.value),onBlur:n,onKeyDown:u}):e.jsx("span",{className:"cursor-text text-sm font-medium text-cyan-700 dark:text-cyan-200",onDoubleClick:r,children:s.label||"Trigger"})]}),e.jsx(d,{type:"target",id:"bottom",position:p.Bottom,className:"!size-2 !bg-cyan-500"}),e.jsx(d,{type:"source",id:"bottom-src",position:p.Bottom,className:"!size-2 !bg-cyan-500"}),e.jsx(d,{type:"target",id:"left",position:p.Left,className:"!size-2 !bg-cyan-500"}),e.jsx(d,{type:"source",id:"left-src",position:p.Left,className:"!size-2 !bg-cyan-500"})]})}const bs={room:ls,spawn:is,boss:ns,shop:cs,secret:ds,exit:ps,note:us,enemy:ms,item:gs,npc:xs,trigger:hs},Me={type:null,id:null,position:{x:0,y:0}},ys=[{value:"room",labelKey:"level.room",icon:ve,color:"#0ea5e9"},{value:"spawn",labelKey:"level.spawn",icon:De,color:"#22c55e"},{value:"boss",labelKey:"level.boss",icon:Pe,color:"#ef4444"},{value:"shop",labelKey:"level.shop",icon:Ke,color:"#f59e0b"},{value:"secret",labelKey:"level.secret",icon:je,color:"#a855f7"},{value:"exit",labelKey:"level.exit",icon:Ee,color:"#f97316"},{value:"note",labelKey:"level.note",icon:Ne,color:"#a3a3a3"}];function fs({menu:l,onClose:s}){const i=h.useRef(null);return h.useEffect(()=>{if(!l.type)return;function y(a){i.current&&!i.current.contains(a.target)&&s()}function t(a){a.key==="Escape"&&s()}return document.addEventListener("mousedown",y),document.addEventListener("keydown",t),()=>{document.removeEventListener("mousedown",y),document.removeEventListener("keydown",t)}},[l.type,s]),l.type?e.jsxs("div",{ref:i,className:"fixed z-50 min-w-[160px] rounded-md border bg-popover p-1 shadow-md animate-in fade-in-0 zoom-in-95",style:{left:l.position.x,top:l.position.y},children:[l.type==="edge"&&e.jsx(js,{edgeId:l.id,onClose:s}),l.type==="node"&&e.jsx(Ns,{nodeId:l.id,onClose:s})]}):null}const vs=[{value:"smoothstep",labelKey:"flow.edge.smoothstep",icon:Lt},{value:"default",labelKey:"flow.edge.bezier",icon:Dt},{value:"straight",labelKey:"flow.edge.straight",icon:It},{value:"step",labelKey:"flow.edge.step",icon:Rt}];function js({edgeId:l,onClose:s}){const i=ce(),y=R(j=>j.edges.find(U=>U.id===l)),t=R(j=>j.updateEdgeType),a=R(j=>j.updateEdgeLabel),o=R(j=>j.toggleEdgeBidirectional),r=R(j=>j.removeEdge),n=y?.type??"smoothstep",u=!!y?.markerStart,[v,g]=h.useState(String(y?.label??"")),M=h.useCallback(()=>{a(l,v.trim())},[l,v,a]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-2 py-1",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(He,{className:"size-3.5 shrink-0 text-muted-foreground"}),e.jsx("input",{className:"h-6 w-full rounded border bg-background px-1.5 text-xs outline-none focus:border-ring",placeholder:i("level.edgeLabel"),value:v,onChange:j=>g(j.target.value),onBlur:M,onKeyDown:j=>{j.key==="Enter"&&(M(),s()),j.stopPropagation()},onClick:j=>j.stopPropagation()})]})}),e.jsx("div",{className:"my-1 border-t"}),e.jsx("div",{className:"px-2 py-1 text-[11px] font-medium text-muted-foreground",children:i("flow.edge.type")}),vs.map(j=>e.jsx(xe,{icon:j.icon,label:i(j.labelKey),active:n===j.value,onClick:()=>{t(l,j.value),s()}},j.value)),e.jsx("div",{className:"my-1 border-t"}),e.jsx(xe,{icon:Bt,label:i("flow.edge.bidirectional"),active:u,onClick:()=>{o(l),s()}}),e.jsx("div",{className:"my-1 border-t"}),e.jsx(xe,{icon:he,label:i("flow.edge.delete"),onClick:()=>{r(l),s()},destructive:!0})]})}function Ns({nodeId:l,onClose:s}){const i=ce(),y=R(u=>u.nodes.find(v=>v.id===l)),t=R(u=>u.updateNodeData),a=R(u=>u.removeNode),[o,r]=h.useState(y?.data.label??""),n=h.useCallback(()=>{t(l,{label:o.trim()||y?.data.label||"Node"})},[l,o,y?.data.label,t]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-2 py-1",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(He,{className:"size-3.5 shrink-0 text-muted-foreground"}),e.jsx("input",{className:"h-6 w-full rounded border bg-background px-1.5 text-xs outline-none focus:border-ring",placeholder:i("flow.node.label"),value:o,onChange:u=>r(u.target.value),onBlur:n,onKeyDown:u=>{u.key==="Enter"&&(n(),s()),u.stopPropagation()},onClick:u=>u.stopPropagation()})]})}),e.jsx("div",{className:"my-1 border-t"}),e.jsx("div",{className:"px-2 py-1 text-[11px] font-medium text-muted-foreground",children:i("flow.node.type")}),ys.map(u=>e.jsx(xe,{icon:u.icon,iconColor:u.color,label:i(u.labelKey),active:y?.type===u.value,onClick:()=>{R.setState(v=>({nodes:v.nodes.map(g=>g.id===l?{...g,type:u.value,data:{...g.data,nodeType:u.value}}:g)})),s()}},u.value)),e.jsx("div",{className:"my-1 border-t"}),e.jsx(xe,{icon:he,label:i("flow.node.delete"),onClick:()=>{a(l),s()},destructive:!0})]})}function xe({icon:l,label:s,active:i,destructive:y,iconColor:t,onClick:a}){return e.jsxs("button",{className:`flex w-full items-center gap-2 rounded-sm px-2 py-1.5 text-sm hover:bg-accent ${i?"bg-accent/50":""} ${y?"text-destructive hover:text-destructive":""}`,onClick:a,children:[e.jsx(l,{className:"size-3.5",style:t?{color:t}:void 0}),e.jsx("span",{className:"flex-1 text-left",children:s}),i&&e.jsx(Qe,{className:"size-3 text-muted-foreground"})]})}function ks(){const{nodes:l,edges:s,viewport:i,onNodesChange:y,onEdgesChange:t,onConnect:a,setViewport:o,addNode:r}=R(),n=h.useMemo(()=>s.map(C=>({...C,markerEnd:C.markerEnd??{type:Oe.ArrowClosed,width:24,height:24}})),[s]),[u,v]=h.useState(!1),[g,M]=h.useState(Me),j=h.useCallback(C=>{C.preventDefault();const I=C.dataTransfer.getData("application/level-node-type");if(!I)return;const O=C.currentTarget.getBoundingClientRect(),X={x:(C.clientX-O.left-i.x)/i.zoom,y:(C.clientY-O.top-i.y)/i.zoom};r(I,X)},[r,i]),U=h.useCallback(C=>{C.preventDefault(),C.dataTransfer.dropEffect="move"},[]),N=h.useCallback((C,I)=>o(I),[o]),A=h.useCallback(()=>M(Me),[]),K=h.useCallback((C,I,O)=>{O.preventDefault(),M({type:C,id:I,position:{x:O.clientX,y:O.clientY}})},[]),H=h.useCallback((C,I)=>K("edge",I.id,C),[K]),Y=h.useCallback((C,I)=>K("edge",I.id,C),[K]),_=h.useCallback((C,I)=>K("node",I.id,C),[K]),D=h.useCallback(()=>{M(Me)},[]);return e.jsxs("div",{className:"absolute inset-0",onDrop:j,onDragOver:U,children:[e.jsxs(bt,{nodes:l,edges:n,nodeTypes:bs,onNodesChange:y,onEdgesChange:t,onConnect:a,onMoveEnd:N,onEdgeContextMenu:H,onEdgeClick:Y,onNodeContextMenu:_,onPaneClick:D,defaultEdgeOptions:{type:"smoothstep"},defaultViewport:i,fitView:l.length>0,deleteKeyCode:["Backspace","Delete"],proOptions:{hideAttribution:!0},className:"bg-background",children:[e.jsx(yt,{variant:ft.Dots,gap:16,size:1}),u&&e.jsx(vt,{nodeStrokeWidth:3,className:"!bg-muted !border-border"})]}),e.jsx(zs,{}),e.jsx(fs,{menu:g,onClose:A}),u?e.jsx("button",{className:"absolute bottom-4 right-4 z-10 flex size-5 items-center justify-center rounded-full bg-background/80 shadow backdrop-blur hover:bg-accent",onClick:()=>v(!1),children:e.jsx(fe,{className:"size-3 text-muted-foreground"})}):e.jsx("div",{className:"absolute bottom-3 right-3 z-10",children:e.jsx(B,{variant:"ghost",size:"icon",className:"size-7 border bg-background/80 shadow-md backdrop-blur",onClick:()=>v(!0),children:e.jsx(et,{className:"size-3.5"})})})]})}function zs(){const{zoomIn:l,zoomOut:s,fitView:i}=jt();return e.jsxs("div",{className:"absolute bottom-3 left-1/2 z-10 flex -translate-x-1/2 items-center gap-1 rounded-lg border bg-background/80 p-1 shadow-md backdrop-blur",children:[e.jsx(B,{variant:"ghost",size:"icon",className:"size-7",onClick:()=>s(),children:e.jsx(Ue,{className:"size-3.5"})}),e.jsx(B,{variant:"ghost",size:"icon",className:"size-7",onClick:()=>i({padding:.2}),children:e.jsx($e,{className:"size-3.5"})}),e.jsx(B,{variant:"ghost",size:"icon",className:"size-7",onClick:()=>l(),children:e.jsx(Xe,{className:"size-3.5"})})]})}function ws(){const l=ce(),s=h.useRef(null),{markers:i,backgroundUrl:y,selectedMarkerId:t,mapViewport:a,setMapViewport:o,selectMarker:r,addMarker:n,updateMarker:u,setBackgroundUrl:v}=R(),[g,M]=h.useState(null),[j,U]=h.useState(null),[N,A]=h.useState(null),[K,H]=h.useState("select"),{x:Y,y:_,zoom:D}=a,C=h.useCallback((c,f)=>{const S=s.current?.getBoundingClientRect();return S?{x:(c-S.left-Y)/D,y:(f-S.top-_)/D}:{x:0,y:0}},[Y,_,D]),I=h.useCallback(c=>{if(c.button===1||c.button===0&&c.altKey){c.preventDefault(),U({startX:c.clientX,startY:c.clientY,vpX:Y,vpY:_});return}if(c.button===0){if(K==="poi"){const f=C(c.clientX,c.clientY);n("poi",f.x,f.y),H("select");return}if(K==="area"){const f=C(c.clientX,c.clientY);A({startX:f.x,startY:f.y,curX:f.x,curY:f.y});return}r(null)}},[K,Y,_,C,n,r]),O=h.useCallback(c=>{if(j){o({x:j.vpX+(c.clientX-j.startX),y:j.vpY+(c.clientY-j.startY),zoom:D});return}if(g){const f=C(c.clientX,c.clientY);u(g.id,{x:f.x-g.offsetX,y:f.y-g.offsetY});return}if(N){const f=C(c.clientX,c.clientY);A({...N,curX:f.x,curY:f.y})}},[j,g,N,D,C,o,u]),X=h.useCallback(()=>{if(j){U(null);return}if(g){M(null);return}if(N){const c=Math.min(N.startX,N.curX),f=Math.min(N.startY,N.curY),S=Math.abs(N.curX-N.startX),E=Math.abs(N.curY-N.startY);if(S>10&&E>10){n("area",c,f);const L=R.getState().markers,k=L[L.length-1];k&&u(k.id,{width:S,height:E})}A(null),H("select")}},[j,g,N,n,u]),te=h.useCallback(c=>{c.preventDefault();const f=s.current?.getBoundingClientRect();if(!f)return;const S=c.deltaY>0?.9:1.1,E=Math.max(.1,Math.min(5,D*S)),L=c.clientX-f.left,k=c.clientY-f.top;o({x:L-(L-Y)*(E/D),y:k-(k-_)*(E/D),zoom:E})},[D,Y,_,o]),$=h.useCallback((c,f)=>{if(c.stopPropagation(),K!=="select")return;r(f.id);const S=C(c.clientX,c.clientY);M({id:f.id,offsetX:S.x-f.x,offsetY:S.y-f.y})},[K,r,C]),re=h.useRef(null),W=h.useCallback(()=>{re.current?.click()},[]),ae=h.useCallback(c=>{const f=c.target.files?.[0];if(!f)return;const S=new FileReader;S.onload=()=>{v(S.result)},S.readAsDataURL(f),c.target.value=""},[v]),oe=h.useCallback(()=>{o({x:0,y:0,zoom:1})},[o]),z=h.useCallback(()=>{const c=s.current?.getBoundingClientRect();if(!c)return;const f=Math.min(5,D*1.2),S=c.width/2,E=c.height/2;o({x:S-(S-Y)*(f/D),y:E-(E-_)*(f/D),zoom:f})},[D,Y,_,o]),m=h.useCallback(()=>{const c=s.current?.getBoundingClientRect();if(!c)return;const f=Math.max(.1,D/1.2),S=c.width/2,E=c.height/2;o({x:S-(S-Y)*(f/D),y:E-(E-_)*(f/D),zoom:f})},[D,Y,_,o]);return e.jsxs("div",{className:"absolute inset-0 overflow-hidden bg-muted/30",children:[e.jsxs("div",{className:"absolute left-3 top-3 z-20 flex items-center gap-1 rounded-lg border bg-background/90 p-1 shadow-md backdrop-blur",children:[e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(B,{variant:K==="poi"?"secondary":"ghost",size:"icon",className:"size-7",onClick:()=>H(K==="poi"?"select":"poi"),children:e.jsx(ye,{className:"size-3.5"})})}),e.jsx(J,{side:"bottom",children:l("level.marker.addPoi")})]}),e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(B,{variant:K==="area"?"secondary":"ghost",size:"icon",className:"size-7",onClick:()=>H(K==="area"?"select":"area"),children:e.jsx(Ve,{className:"size-3.5"})})}),e.jsx(J,{side:"bottom",children:l("level.marker.addArea")})]}),e.jsx("div",{className:"mx-0.5 h-5 w-px bg-border"}),e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(B,{variant:"ghost",size:"icon",className:"size-7",onClick:W,children:e.jsx(_t,{className:"size-3.5"})})}),e.jsx(J,{side:"bottom",children:l("level.marker.uploadBg")})]}),y&&e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(B,{variant:"ghost",size:"icon",className:"size-7",onClick:()=>v(void 0),children:e.jsx(fe,{className:"size-3.5"})})}),e.jsx(J,{side:"bottom",children:l("level.marker.removeBg")})]})]}),e.jsx("input",{ref:re,type:"file",accept:"image/*",className:"hidden",onChange:ae}),e.jsx("div",{ref:s,className:"absolute inset-0 select-none",style:{cursor:K==="poi"||K==="area"?"crosshair":j?"grabbing":"default"},onMouseDown:I,onMouseMove:O,onMouseUp:X,onMouseLeave:X,onWheel:te,children:e.jsxs("div",{style:{transform:`translate(${Y}px, ${_}px) scale(${D})`,transformOrigin:"0 0",position:"absolute",inset:0},children:[y&&e.jsx("img",{src:y,alt:"",className:"pointer-events-none select-none",draggable:!1,style:{position:"absolute",top:0,left:0}}),!y&&e.jsxs("svg",{className:"pointer-events-none absolute inset-0",width:"100%",height:"100%",children:[e.jsx("defs",{children:e.jsx("pattern",{id:"map-grid",width:"50",height:"50",patternUnits:"userSpaceOnUse",children:e.jsx("circle",{cx:"25",cy:"25",r:"1",className:"fill-muted-foreground/20"})})}),e.jsx("rect",{width:"4000",height:"4000",x:"-2000",y:"-2000",fill:"url(#map-grid)"})]}),i.filter(c=>c.type==="area").map(c=>e.jsx("div",{className:`absolute rounded border-2 border-dashed ${c.id===t?"ring-2 ring-primary":""}`,style:{left:c.x,top:c.y,width:c.width??200,height:c.height??150,backgroundColor:c.color||"#3b82f620",borderColor:(c.color||"#3b82f6").replace(/20$/,"")||"#3b82f6"},onMouseDown:f=>$(f,c),children:e.jsx("span",{className:"absolute -top-5 left-0 whitespace-nowrap text-xs font-medium text-foreground",children:c.label})},c.id)),i.filter(c=>c.type==="poi").map(c=>e.jsxs("div",{className:`absolute flex -translate-x-1/2 -translate-y-full flex-col items-center ${c.id===t?"z-10":""}`,style:{left:c.x,top:c.y},onMouseDown:f=>$(f,c),children:[e.jsx("span",{className:`mb-0.5 whitespace-nowrap rounded px-1 py-0.5 text-[10px] font-medium leading-none text-white ${c.id===t?"ring-2 ring-primary ring-offset-1":""}`,style:{backgroundColor:c.color||"#3b82f6"},children:c.label}),e.jsx(ye,{className:"size-5 drop-shadow",style:{color:c.color||"#3b82f6"},fill:c.color||"#3b82f6"})]},c.id)),N&&e.jsx("div",{className:"absolute rounded border-2 border-dashed border-primary bg-primary/10",style:{left:Math.min(N.startX,N.curX),top:Math.min(N.startY,N.curY),width:Math.abs(N.curX-N.startX),height:Math.abs(N.curY-N.startY)}})]})}),e.jsxs("div",{className:"absolute bottom-3 left-1/2 z-10 flex -translate-x-1/2 items-center gap-1 rounded-lg border bg-background/80 p-1 shadow-md backdrop-blur",children:[e.jsx(B,{variant:"ghost",size:"icon",className:"size-7",onClick:m,children:e.jsx(Ue,{className:"size-3.5"})}),e.jsx(B,{variant:"ghost",size:"icon",className:"size-7",onClick:oe,children:e.jsx($e,{className:"size-3.5"})}),e.jsx(B,{variant:"ghost",size:"icon",className:"size-7",onClick:z,children:e.jsx(Xe,{className:"size-3.5"})}),e.jsxs("span",{className:"px-1 text-[10px] text-muted-foreground",children:[Math.round(D*100),"%"]})]})]})}const Cs=["#3b82f6","#ef4444","#22c55e","#f59e0b","#a855f7","#f97316","#ec4899","#6366f1"];function Ss(){const l=ce(),s=Ye(),{markers:i,selectedMarkerId:y,selectMarker:t,updateMarker:a,removeMarker:o}=R(),r=i.find(n=>n.id===y);return i.length===0&&!r?null:e.jsxs("div",{className:"shrink-0 border-t bg-background",children:[e.jsxs("div",{className:"flex items-center gap-1 overflow-x-auto px-4 py-1.5",children:[e.jsxs("span",{className:"text-xs font-semibold shrink-0",children:[l("level.marker.list")," (",i.length,")"]}),e.jsx("div",{className:"flex gap-1 ml-2",children:i.map(n=>e.jsxs("button",{className:me("inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-[11px] shrink-0 border transition-colors",n.id===y?"bg-accent border-primary/50":"border-transparent hover:bg-muted"),onClick:()=>t(n.id),children:[n.type==="poi"?e.jsx(ye,{className:"size-3 shrink-0",style:{color:n.color}}):e.jsx(Ve,{className:"size-3 shrink-0",style:{color:n.color?.replace(/20$/,"")||n.color}}),e.jsx("span",{className:"truncate max-w-20",children:n.label})]},n.id))})]}),r&&e.jsx("div",{className:"max-h-48 overflow-y-auto px-4 pb-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-x-4 gap-y-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:[e.jsx(ie,{label:l("level.marker.name"),children:e.jsx(V,{className:"h-7 text-xs",value:r.label,onChange:n=>a(r.id,{label:n.target.value})})}),e.jsx(ie,{label:l("level.marker.description"),children:e.jsx("textarea",{className:"w-full rounded-md border bg-background px-2 py-1 text-xs outline-none focus:border-ring resize-none h-14",value:r.description??"",onChange:n=>a(r.id,{description:n.target.value||void 0})})}),e.jsx(ie,{label:l("level.marker.color"),children:e.jsx("div",{className:"flex flex-wrap gap-1.5 pt-0.5",children:Cs.map(n=>{const v=(r.type==="area"&&r.color?.replace(/20$/,"")||r.color)===n;return e.jsx("button",{className:me("size-5 rounded-full border-2",v?"border-foreground":"border-transparent"),style:{backgroundColor:n},onClick:()=>a(r.id,{color:r.type==="area"?n+"20":n})},n)})})}),r.type==="area"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ie,{label:l("level.marker.width"),children:e.jsx(V,{type:"number",className:"h-7 text-xs",value:r.width??200,onChange:n=>a(r.id,{width:Number(n.target.value)||200})})}),e.jsx(ie,{label:l("level.marker.height"),children:e.jsx(V,{type:"number",className:"h-7 text-xs",value:r.height??150,onChange:n=>a(r.id,{height:Number(n.target.value)||150})})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ie,{label:"X",children:e.jsx(V,{type:"number",className:"h-7 text-xs",value:Math.round(r.x),onChange:n=>a(r.id,{x:Number(n.target.value)||0})})}),e.jsx(ie,{label:"Y",children:e.jsx(V,{type:"number",className:"h-7 text-xs",value:Math.round(r.y),onChange:n=>a(r.id,{y:Number(n.target.value)||0})})})]}),e.jsx(ie,{label:"",children:e.jsxs(B,{variant:"destructive",size:"sm",className:"w-full h-7",onClick:async()=>{await s({title:l("doc.deleteConfirm"),variant:"destructive"})&&o(r.id)},children:[e.jsx(he,{className:"mr-1 size-3.5"}),l("flow.edge.delete")]})})]})})]})}function ie({label:l,children:s}){return e.jsxs("div",{children:[l&&e.jsx("label",{className:"mb-1 block text-[11px] font-medium text-muted-foreground",children:l}),s]})}const Ms="rgba(128,128,128,0.25)",Es="rgba(128,128,128,0.5)",Ts={enemy:"⚔",item:"♦",npc:"☺",trigger:"⚡"};function Ls(){const l=h.useRef(null),s=h.useRef(null),{gridWidth:i,gridHeight:y,tileSize:t,palette:a,layers:o,activeLayerId:r,gridTool:n,gridViewport:u,entities:v,selectedEntityId:g,setGridViewport:M,paintCell:j,fillArea:U,addEntity:N,selectEntity:A,endStroke:K}=R(),[H,Y]=h.useState(!1),[_,D]=h.useState(!1),C=h.useRef({x:0,y:0,vpX:0,vpY:0}),I=h.useRef(new Map),O=h.useMemo(()=>a.filter(z=>z.imageUrl).map(z=>z.imageUrl),[a]);h.useEffect(()=>{let z=!1;for(const c of O){if(I.current.has(c))continue;const f=new Image;f.src=c,f.onload=()=>{I.current.set(c,f),X()},z=!0}const m=new Set(O);for(const c of I.current.keys())m.has(c)||I.current.delete(c);z&&X()},[O]);const X=h.useCallback(()=>{const z=l.current;if(!z)return;const m=z.getContext("2d");if(!m)return;const{width:c,height:f}=z,{x:S,y:E,zoom:L}=u,k=t*L;m.clearRect(0,0,c,f),m.save(),m.translate(S,E);for(const x of o)if(x.visible)for(let w=0;w<x.data.length;w++){const T=x.data[w];for(let ee=0;ee<T.length;ee++){const le=T[ee];if(le<0||le>=a.length)continue;const de=a[le];if(de.imageUrl){const ge=I.current.get(de.imageUrl);ge?m.drawImage(ge,ee*k,w*k,k,k):(m.fillStyle=de.color,m.fillRect(ee*k,w*k,k,k))}else m.fillStyle=de.color,m.fillRect(ee*k,w*k,k,k)}}const q=i*k,Q=y*k;m.strokeStyle=Ms,m.lineWidth=1,m.beginPath();for(let x=0;x<=i;x++){const w=x*k;m.moveTo(w,0),m.lineTo(w,Q)}for(let x=0;x<=y;x++){const w=x*k;m.moveTo(0,w),m.lineTo(q,w)}m.stroke(),m.strokeStyle=Es,m.beginPath();for(let x=0;x<=i;x+=4){const w=x*k;m.moveTo(w,0),m.lineTo(w,Q)}for(let x=0;x<=y;x+=4){const w=x*k;m.moveTo(0,w),m.lineTo(q,w)}if(m.stroke(),m.strokeStyle="rgba(128,128,128,0.8)",m.lineWidth=2,m.strokeRect(0,0,q,Q),r){const x=o.find(w=>w.id===r);if(x){m.strokeStyle="rgba(59,130,246,0.5)",m.lineWidth=1;for(let w=0;w<x.data.length;w++)for(let T=0;T<x.data[w].length;T++)x.data[w][T]>=0&&m.strokeRect(T*k+1,w*k+1,k-2,k-2)}}for(const x of v){const w=x.col*k,T=x.row*k,ee=x.color??"#888";m.fillStyle=ee+"40",m.fillRect(w+2,T+2,k-4,k-4);const le=Math.max(10,k*.45);m.font=`${le}px sans-serif`,m.textAlign="center",m.textBaseline="middle",m.fillStyle=ee,m.fillText(Ts[x.type]??"?",w+k/2,T+k/2),x.id===g&&(m.strokeStyle="#3b82f6",m.lineWidth=2,m.strokeRect(w+1,T+1,k-2,k-2))}m.restore()},[i,y,t,a,o,r,u,v,g]);h.useEffect(()=>{X()},[X]),h.useEffect(()=>{const z=s.current,m=l.current;if(!z||!m)return;const c=new ResizeObserver(()=>{const{width:f,height:S}=z.getBoundingClientRect(),E=window.devicePixelRatio||1;m.width=f*E,m.height=S*E,m.style.width=`${f}px`,m.style.height=`${S}px`,m.getContext("2d")?.scale(E,E),X()});return c.observe(z),()=>c.disconnect()},[X]);const te=h.useCallback((z,m)=>{const c=l.current;if(!c)return null;const f=c.getBoundingClientRect(),{x:S,y:E,zoom:L}=R.getState().gridViewport,k=t*L,q=z-f.left-S,Q=m-f.top-E,x=Math.floor(q/k),w=Math.floor(Q/k);return x<0||x>=i||w<0||w>=y?null:{row:w,col:x}},[t,i,y]),$=h.useCallback((z,m)=>{if(!r)return;const{gridTool:c,activePaletteIdx:f}=R.getState();c==="brush"?j(r,z,m,f):c==="eraser"?j(r,z,m,-1):c==="fill"&&U(r,z,m,c==="fill"?f:-1)},[r,j,U]),re=h.useCallback(z=>{if(z.altKey||z.button===1){D(!0);const c=R.getState().gridViewport;C.current={x:z.clientX,y:z.clientY,vpX:c.x,vpY:c.y},z.currentTarget.setPointerCapture(z.pointerId);return}if(z.button!==0)return;const m=te(z.clientX,z.clientY);if(m){if(n==="entity"){const{entities:c,entityType:f}=R.getState(),S=c.find(E=>E.row===m.row&&E.col===m.col);S?A(S.id):N(f,m.row,m.col);return}if(n==="fill"){$(m.row,m.col);return}Y(!0),$(m.row,m.col),z.currentTarget.setPointerCapture(z.pointerId)}},[te,n,$,N,A]),W=h.useCallback(z=>{if(_){const c=z.clientX-C.current.x,f=z.clientY-C.current.y;M({...R.getState().gridViewport,x:C.current.vpX+c,y:C.current.vpY+f});return}if(!H)return;const m=te(z.clientX,z.clientY);m&&$(m.row,m.col)},[_,H,te,$,M]),ae=h.useCallback(()=>{Y(!1),D(!1),K()},[K]),oe=h.useCallback(z=>{z.preventDefault();const m=R.getState().gridViewport,c=z.deltaY>0?.9:1.1,f=Math.max(.2,Math.min(5,m.zoom*c)),S=l.current;if(!S)return;const E=S.getBoundingClientRect(),L=z.clientX-E.left,k=z.clientY-E.top,q=L-(L-m.x)*(f/m.zoom),Q=k-(k-m.y)*(f/m.zoom);M({x:q,y:Q,zoom:f})},[M]);return e.jsx("div",{ref:s,className:"size-full bg-muted/30",children:e.jsx("canvas",{ref:l,className:"size-full touch-none",onPointerDown:re,onPointerMove:W,onPointerUp:ae,onPointerLeave:ae,onWheel:oe})})}const Ds=[{tool:"brush",icon:Ge,labelKey:"level.grid.brush"},{tool:"eraser",icon:We,labelKey:"level.grid.eraser"},{tool:"fill",icon:Fe,labelKey:"level.grid.fill"},{tool:"entity",icon:Pt,labelKey:"level.grid.entityTool"}],Rs=[{type:"enemy",icon:ke,labelKey:"level.enemy",color:"#f43f5e"},{type:"item",icon:Re,labelKey:"level.item",color:"#d97706"},{type:"npc",icon:Te,labelKey:"level.npc",color:"#10b981"},{type:"trigger",icon:Le,labelKey:"level.trigger",color:"#06b6d4"}];function Ks(){const l=ce(),{gridWidth:s,gridHeight:i,tileSize:y,palette:t,layers:a,activeLayerId:o,activePaletteIdx:r,gridTool:n,entities:u,selectedEntityId:v,entityType:g,setGridSize:M,setTileSize:j,setGridTool:U,addPalette:N,updatePalette:A,removePalette:K,setActivePaletteIdx:H,addLayer:Y,removeLayer:_,toggleLayerVisibility:D,setActiveLayer:C,renameLayer:I,updateEntity:O,removeEntity:X,setEntityType:te}=R(),[$,re]=h.useState(!1),[W,ae]=h.useState(""),[oe,z]=h.useState("#3b82f6"),[m,c]=h.useState(null),[f,S]=h.useState(""),E=h.useRef(null),L=u.find(b=>b.id===v),[k,q]=h.useState(""),[Q,x]=h.useState(""),w=()=>{W.trim()&&(N(W.trim(),oe),ae(""))},T=()=>{const b=`${l("level.grid.layer")} ${a.length+1}`;Y(b)},ee=(b,P)=>{c(b),S(P)},le=()=>{m&&f.trim()&&I(m,f.trim()),c(null)},de=b=>{const P=b.target.files?.[0];if(!P)return;const ne=new FileReader;ne.onload=()=>{const ze=ne.result;N(P.name.replace(/\.[^.]+$/,""),"#888888");const Be=R.getState().palette,_e=Be[Be.length-1];_e&&A(_e.id,{imageUrl:ze})},ne.readAsDataURL(P),b.target.value=""},ge=()=>{if(!L||!k.trim())return;const b={...L.properties??{},[k.trim()]:Q};O(L.id,{properties:b}),q(""),x("")},Je=b=>{if(!L)return;const P={...L.properties??{}};delete P[b],O(L.id,{properties:P})};return e.jsxs("div",{className:"shrink-0 border-t bg-background",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-x-auto px-4 py-1.5",children:[e.jsx("div",{className:"flex gap-0.5 shrink-0",children:Ds.map(b=>e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(B,{variant:n===b.tool?"secondary":"ghost",size:"icon",className:"size-7",onClick:()=>U(b.tool),children:e.jsx(b.icon,{className:"size-3.5"})})}),e.jsx(J,{side:"top",children:l(b.labelKey)})]},b.tool))}),e.jsx("div",{className:"h-5 w-px bg-border shrink-0"}),n==="entity"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex gap-0.5 shrink-0",children:Rs.map(b=>e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(B,{variant:g===b.type?"secondary":"ghost",size:"icon",className:"size-7",onClick:()=>te(b.type),children:e.jsx(b.icon,{className:"size-3.5",style:{color:b.color}})})}),e.jsx(J,{side:"top",children:l(b.labelKey)})]},b.type))}),e.jsx("div",{className:"h-5 w-px bg-border shrink-0"})]}),e.jsx("div",{className:"flex gap-0.5 shrink-0",children:t.map((b,P)=>e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx("button",{className:me("size-6 rounded border-2 overflow-hidden shrink-0",P===r?"border-primary ring-1 ring-primary/30":"border-transparent hover:border-muted-foreground/30"),style:b.imageUrl?void 0:{backgroundColor:b.color},onClick:()=>H(P),onContextMenu:ne=>{ne.preventDefault(),K(b.id)},children:b.imageUrl&&e.jsx("img",{src:b.imageUrl,alt:b.name,className:"size-full object-cover"})})}),e.jsx(J,{side:"top",children:b.name})]},b.id))}),e.jsxs("button",{className:"ml-auto flex items-center gap-0.5 text-[11px] text-muted-foreground hover:text-foreground shrink-0",onClick:()=>re(!$),children:[$?e.jsx(tt,{className:"size-3"}):e.jsx(st,{className:"size-3"}),l("level.grid.settings")]})]}),e.jsx("div",{className:"max-h-52 overflow-y-auto px-4 pb-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-x-4 gap-y-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-[11px] font-medium text-muted-foreground mb-1.5",children:l("level.grid.palette")}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"color",value:oe,onChange:b=>z(b.target.value),className:"size-6 shrink-0 cursor-pointer rounded border p-0.5"}),e.jsx(V,{value:W,onChange:b=>ae(b.target.value),placeholder:l("level.grid.tileName"),className:"h-6 text-xs",onKeyDown:b=>b.key==="Enter"&&w()}),e.jsx(B,{variant:"ghost",size:"icon",className:"size-6 shrink-0",onClick:w,disabled:!W.trim(),children:e.jsx(be,{className:"size-3"})})]}),e.jsx("input",{ref:E,type:"file",accept:"image/*",className:"hidden",onChange:de}),e.jsxs(B,{variant:"outline",size:"sm",className:"w-full mt-1 h-6 text-[11px]",onClick:()=>E.current?.click(),children:[e.jsx(Ft,{className:"mr-1 size-3"}),l("level.grid.uploadTile")]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsxs("h4",{className:"text-[11px] font-medium text-muted-foreground flex items-center gap-1",children:[e.jsx(At,{className:"size-3"}),l("level.grid.layers")]}),e.jsx(B,{variant:"ghost",size:"icon",className:"size-5",onClick:T,children:e.jsx(be,{className:"size-3"})})]}),a.length===0?e.jsx("p",{className:"text-[11px] text-muted-foreground",children:l("level.grid.layerEmpty")}):e.jsx("div",{className:"space-y-0.5 max-h-24 overflow-y-auto",children:[...a].reverse().map(b=>e.jsxs("div",{className:me("flex items-center gap-1 rounded px-1.5 py-0.5 text-[11px] cursor-pointer",b.id===o?"bg-accent text-accent-foreground":"hover:bg-muted"),onClick:()=>C(b.id),children:[e.jsx("button",{className:"shrink-0",onClick:P=>{P.stopPropagation(),D(b.id)},children:b.visible?e.jsx(je,{className:"size-3"}):e.jsx(Ut,{className:"size-3 text-muted-foreground"})}),m===b.id?e.jsx(V,{value:f,onChange:P=>S(P.target.value),onBlur:le,onKeyDown:P=>P.key==="Enter"&&le(),className:"h-4 flex-1 text-[11px] px-1",autoFocus:!0,onClick:P=>P.stopPropagation()}):e.jsx("span",{className:"flex-1 truncate",onDoubleClick:P=>{P.stopPropagation(),ee(b.id,b.name)},children:b.name}),e.jsx("button",{className:"shrink-0",onClick:P=>{P.stopPropagation(),ee(b.id,b.name)},children:e.jsx(at,{className:"size-2.5"})}),e.jsx("button",{className:"shrink-0 text-destructive",onClick:P=>{P.stopPropagation(),_(b.id)},children:e.jsx(he,{className:"size-2.5"})})]},b.id))})]}),n==="entity"&&L&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-[11px] font-medium text-muted-foreground mb-1.5",children:l("level.grid.entityProps")}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-6 text-xs flex-1",value:L.label,onChange:b=>O(L.id,{label:b.target.value})}),e.jsx("input",{type:"color",value:L.color??"#888888",onChange:b=>O(L.id,{color:b.target.value}),className:"size-6 cursor-pointer rounded border p-0.5 shrink-0"})]}),Object.entries(L.properties??{}).map(([b,P])=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] w-10 truncate shrink-0",children:b}),e.jsx(V,{className:"h-5 text-[10px] flex-1",value:P,onChange:ne=>{const ze={...L.properties??{},[b]:ne.target.value};O(L.id,{properties:ze})}}),e.jsx("button",{className:"text-destructive",onClick:()=>Je(b),children:e.jsx(fe,{className:"size-2.5"})})]},b)),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-5 text-[10px] w-10 shrink-0",placeholder:"key",value:k,onChange:b=>q(b.target.value)}),e.jsx(V,{className:"h-5 text-[10px] flex-1",placeholder:"value",value:Q,onChange:b=>x(b.target.value),onKeyDown:b=>b.key==="Enter"&&ge()}),e.jsx(B,{variant:"ghost",size:"icon",className:"size-5 shrink-0",onClick:ge,disabled:!k.trim(),children:e.jsx(be,{className:"size-2.5"})})]}),e.jsxs(B,{variant:"destructive",size:"sm",className:"w-full h-6 text-[11px]",onClick:()=>X(L.id),children:[e.jsx(he,{className:"mr-1 size-3"}),l("flow.edge.delete")]})]})]}),$&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-[11px] font-medium text-muted-foreground mb-1.5",children:l("level.grid.settings")}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[11px] w-6 shrink-0",children:"W"}),e.jsx(V,{type:"number",value:s,onChange:b=>M(Number(b.target.value)||1,i),min:1,max:256,className:"h-6 text-xs"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[11px] w-6 shrink-0",children:"H"}),e.jsx(V,{type:"number",value:i,onChange:b=>M(s,Number(b.target.value)||1),min:1,max:256,className:"h-6 text-xs"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[11px] w-6 shrink-0",children:l("level.grid.tileSizeShort")}),e.jsx(V,{type:"number",value:y,onChange:b=>j(Number(b.target.value)||8),min:8,max:256,step:8,className:"h-6 text-xs"})]})]})]})]})})]})}const Ps=["#3b82f6","#ef4444","#22c55e","#f59e0b","#a855f7","#f97316","#ec4899","#06b6d4"],Is=[{value:"room",labelKey:"level.room"},{value:"spawn",labelKey:"level.spawn"},{value:"boss",labelKey:"level.boss"},{value:"shop",labelKey:"level.shop"},{value:"secret",labelKey:"level.secret"},{value:"exit",labelKey:"level.exit"},{value:"note",labelKey:"level.note"},{value:"enemy",labelKey:"level.enemy"},{value:"item",labelKey:"level.item"},{value:"npc",labelKey:"level.npc"},{value:"trigger",labelKey:"level.trigger"}],Bs=new Set(["room","boss","enemy"]);function _s(){const l=ce(),{nodes:s,updateNodeData:i}=R(),[y,t]=h.useState(""),a=s.find(g=>g.selected);if(!a)return null;const o=a.data,r=Bs.has(o.nodeType),n=()=>{const g=y.trim();if(!g)return;const M=o.tags??[];M.includes(g)||(i(a.id,{tags:[...M,g]}),t(""))},u=g=>{i(a.id,{tags:(o.tags??[]).filter(M=>M!==g)})},v=g=>{R.setState(M=>({nodes:M.nodes.map(j=>j.id===a.id?{...j,type:g,data:{...j.data,nodeType:g}}:j)}))};return e.jsxs("div",{className:"shrink-0 border-t bg-background",children:[e.jsxs("div",{className:"flex items-center gap-2 px-4 py-1.5",children:[e.jsx("span",{className:"text-xs font-semibold",children:l("level.prop.title")}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:o.label})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto px-4 pb-3",children:e.jsxs("div",{className:"grid grid-cols-1 gap-x-4 gap-y-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",children:[e.jsx(ue,{label:l("level.marker.name"),children:e.jsx(V,{className:"h-7 text-xs",value:o.label,onChange:g=>i(a.id,{label:g.target.value})})}),e.jsx(ue,{label:l("level.prop.type"),children:e.jsx("select",{className:"w-full rounded-md border bg-background px-2 py-1 text-xs outline-none focus:border-ring h-7",value:o.nodeType,onChange:g=>v(g.target.value),children:Is.map(g=>e.jsx("option",{value:g.value,children:l(g.labelKey)},g.value))})}),e.jsx(ue,{label:l("level.marker.description"),children:e.jsx("textarea",{className:"w-full rounded-md border bg-background px-2 py-1 text-xs outline-none focus:border-ring resize-none h-14",value:o.description??"",onChange:g=>i(a.id,{description:g.target.value||void 0})})}),r&&e.jsx(ue,{label:l("level.prop.difficulty"),children:e.jsx("div",{className:"flex gap-0.5 pt-1",children:[1,2,3,4,5].map(g=>e.jsx("button",{className:"p-0.5",onClick:()=>i(a.id,{difficulty:o.difficulty===g?0:g}),children:e.jsx(Ze,{className:me("size-4",g<=(o.difficulty??0)?"fill-yellow-400 text-yellow-400":"text-muted-foreground/40")})},g))})}),e.jsx(ue,{label:l("level.marker.color"),children:e.jsx("div",{className:"flex flex-wrap gap-1.5 pt-0.5",children:Ps.map(g=>e.jsx("button",{className:me("size-5 rounded-full border-2",o.color===g?"border-foreground":"border-transparent"),style:{backgroundColor:g},onClick:()=>i(a.id,{color:o.color===g?void 0:g})},g))})}),e.jsxs(ue,{label:l("level.prop.tags"),children:[(o.tags??[]).length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mb-1",children:(o.tags??[]).map(g=>e.jsxs("span",{className:"inline-flex items-center gap-0.5 rounded-full bg-accent px-2 py-0.5 text-[10px]",children:[g,e.jsx("button",{onClick:()=>u(g),className:"hover:text-destructive",children:e.jsx(fe,{className:"size-2.5"})})]},g))}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-6 text-[11px] flex-1",value:y,onChange:g=>t(g.target.value),placeholder:l("level.prop.addTag"),onKeyDown:g=>g.key==="Enter"&&n()}),e.jsx(B,{variant:"ghost",size:"icon",className:"size-6 shrink-0",onClick:n,disabled:!y.trim(),children:e.jsx(be,{className:"size-3"})})]})]})]})})]})}function ue({label:l,children:s}){return e.jsxs("div",{children:[e.jsx("label",{className:"mb-1 block text-[11px] font-medium text-muted-foreground",children:l}),s]})}const As=[{type:"spawn",icon:De,labelKey:"level.spawn",color:"#22c55e"},{type:"room",icon:ve,labelKey:"level.room",color:"#0ea5e9"},{type:"boss",icon:Pe,labelKey:"level.boss",color:"#ef4444"},{type:"shop",icon:Ke,labelKey:"level.shop",color:"#f59e0b"},{type:"secret",icon:je,labelKey:"level.secret",color:"#a855f7"},{type:"exit",icon:Ee,labelKey:"level.exit",color:"#f97316"}],Ys=[{type:"enemy",icon:ke,labelKey:"level.enemy",color:"#f43f5e"},{type:"item",icon:Re,labelKey:"level.item",color:"#d97706"},{type:"npc",icon:Te,labelKey:"level.npc",color:"#10b981"},{type:"trigger",icon:Le,labelKey:"level.trigger",color:"#06b6d4"}],Os=[{type:"note",icon:Ne,labelKey:"level.note",color:"#a3a3a3"}],Us=[{labelKey:"level.cat.structure",icon:ve,nodes:As},{labelKey:"level.cat.object",icon:ke,nodes:Ys},{labelKey:"level.cat.annotation",icon:Ne,nodes:Os}],$s=[{value:"node-graph",icon:Jt,labelKey:"level.mode.nodeGraph"},{value:"map-marker",icon:ye,labelKey:"level.mode.mapMarker"},{value:"grid",icon:Ht,labelKey:"level.mode.grid"}],Xs=[{tool:"brush",icon:Ge,labelKey:"level.grid.brush"},{tool:"eraser",icon:We,labelKey:"level.grid.eraser"},{tool:"fill",icon:Fe,labelKey:"level.grid.fill"}];function na(){const{docId:l}=ot(),s=ce(),i=Ye(),{currentDocument:y}=rt(),{mode:t,nodes:a,edges:o,viewport:r,markers:n,backgroundUrl:u,gridWidth:v,gridHeight:g,tileSize:M,palette:j,layers:U,gridTool:N,entities:A,loadLevel:K,loadMapMarker:H,loadGrid:Y,setMode:_,addNode:D,setGridTool:C,undo:I,redo:O,_past:X,_future:te}=R();Nt(I,O),h.useEffect(()=>{if(y?.type==="level"){const x=y;_(x.mode||"node-graph"),K(x.nodes,x.edges,x.viewport),H(x.markers??[],x.backgroundUrl),Y(x.gridWidth||16,x.gridHeight||12,x.tileSize||32,x.palette??[],x.layers??[],x.entities??[])}},[y?.id]);const $=h.useMemo(()=>!y||y.type!=="level"?null:{...y,mode:t,nodes:a,edges:o,viewport:r,markers:n,backgroundUrl:u,gridWidth:v,gridHeight:g,tileSize:M,palette:j,layers:U,entities:A,updatedAt:Date.now()},[y,t,a,o,r,n,u,v,g,M,j,U,A]),re=zt($),W=Ct(l,re),ae=h.useCallback(()=>{if(!$)return;const x=`${$.title||"level"}.json`;lt(x,it($))},[$]),oe=h.useCallback(async x=>{if(await i({title:s("ie.importConfirm"),variant:"destructive"}))try{const T=JSON.parse(x);if(T.type!=="level")return;_(T.mode||"node-graph"),K(T.nodes??[],T.edges??[],T.viewport),H(T.markers??[],T.backgroundUrl),Y(T.gridWidth||16,T.gridHeight||12,T.tileSize||32,T.palette??[],T.layers??[],T.entities??[])}catch{}},[i,s,_,K,H,Y]),z=h.useMemo(()=>[{key:"ie.importJson",icon:Ae,accept:".json",onImport:oe}],[oe]),m=h.useMemo(()=>[{key:"export.currentJson",icon:Ae,onClick:ae}],[ae]),c=h.useCallback(()=>{const{nodes:x,edges:w}=R.getState(),T=nt(x,w);R.setState({nodes:T.nodes,edges:T.edges})},[]),f=h.useCallback(x=>{const w=200+Math.random()*200,T=150+Math.random()*200;D(x,{x:w,y:T})},[D]),S=h.useCallback(x=>{_(x)},[_]),E=e.jsxs(e.Fragment,{children:[e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(B,{variant:"ghost",size:"icon",className:"size-9",onClick:I,disabled:X.length===0,children:e.jsx(St,{className:"size-4"})})}),e.jsx(J,{side:"top",children:"Undo"})]}),e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(B,{variant:"ghost",size:"icon",className:"size-9",onClick:O,disabled:te.length===0,children:e.jsx(Mt,{className:"size-4"})})}),e.jsx(J,{side:"top",children:"Redo"})]}),e.jsx(we,{orientation:"vertical",className:"mx-0.5 h-6"}),$s.map(x=>e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(B,{variant:t===x.value?"secondary":"ghost",size:"icon",className:"size-9",onClick:()=>S(x.value),children:e.jsx(x.icon,{className:"size-4"})})}),e.jsx(J,{side:"top",children:s(x.labelKey)})]},x.value)),e.jsx(we,{orientation:"vertical",className:"mx-0.5 h-6"})]}),L=t==="node-graph"?e.jsxs(e.Fragment,{children:[Us.map(x=>e.jsxs(ct,{children:[e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(dt,{asChild:!0,children:e.jsx(B,{variant:"ghost",size:"icon",className:"size-9",children:e.jsx(x.icon,{className:"size-4"})})})}),e.jsx(J,{side:"top",children:s(x.labelKey)})]}),e.jsx(pt,{align:"start",children:x.nodes.map(w=>e.jsxs(ut,{onClick:()=>f(w.type),children:[e.jsx(w.icon,{className:"size-4 mr-2 shrink-0",style:{color:w.color}}),s(w.labelKey)]},w.type))})]},x.labelKey)),e.jsx(we,{orientation:"vertical",className:"mx-0.5 h-6"}),e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(B,{variant:"ghost",size:"icon",className:"size-9",onClick:c,children:e.jsx(Kt,{className:"size-4"})})}),e.jsx(J,{side:"top",children:"Auto Layout"})]})]}):null,k=t==="grid"?e.jsx(e.Fragment,{children:Xs.map(x=>e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(B,{variant:N===x.tool?"secondary":"ghost",size:"icon",className:"size-9",onClick:()=>C(x.tool),children:e.jsx(x.icon,{className:"size-4"})})}),e.jsx(J,{side:"top",children:s(x.labelKey)})]},x.tool))}):null,q=e.jsx(wt,{imports:z,exports:m}),Q=t==="node-graph"?e.jsx(Ce,{section:"關卡佈局",subsection:"節點圖模式"}):t==="map-marker"?e.jsx(Ce,{section:"關卡佈局",subsection:"地圖標記模式"}):e.jsx(Ce,{section:"關卡佈局",subsection:"網格地圖模式"});return mt(l?e.jsxs(e.Fragment,{children:[E,L,k,q,Q]}):null,[l,t,f,c,S,z,m,N,C,I,O,X,te,s]),l?t==="map-marker"?e.jsxs("div",{className:"relative flex flex-col size-full",children:[e.jsx("div",{className:"relative min-h-0 flex-1",children:e.jsx(ws,{})}),e.jsx(Ss,{}),W!=="idle"&&e.jsx(Se,{status:W})]}):t==="grid"?e.jsxs("div",{className:"relative flex flex-col size-full",children:[e.jsx("div",{className:"relative min-h-0 flex-1",children:e.jsx(Ls,{})}),e.jsx(Ks,{}),W!=="idle"&&e.jsx(Se,{status:W})]}):e.jsx(kt,{children:e.jsxs("div",{className:"relative flex flex-col size-full",children:[e.jsx("div",{className:"relative min-h-0 flex-1",children:e.jsx(ks,{})}),e.jsx(_s,{}),W!=="idle"&&e.jsx(Se,{status:W})]})}):e.jsx(Et,{docTypes:["level"],routePath:"level",defaultDocType:"level"})}export{na as default};
