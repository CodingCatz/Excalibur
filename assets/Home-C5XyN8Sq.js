import{c as se,ca as Ge,cb as ot,aE as A,a_ as we,cc as ye,cd as ze,aB as Pe,bL as Ze,ce as Ye,r as h,cf as rt,cg as it,ch as Ee,ci as Te,j as e,aI as Qe,aJ as Xe,bS as et,bT as tt,B as T,bO as ct,a$ as G,b0 as Z,b1 as Y,cj as lt,aK as Ce,aD as ke,b3 as dt,b$ as mt,bN as st,ck as at,cl as ut,cm as Ae,cn as xt,co as Le,cp as pt,cq as nt,cr as ht,bw as ft,cs as gt,ct as jt,cu as vt,aG as wt,aC as yt,cv as Nt,cw as kt,cx as bt,bQ as _e,cy as Me,b6 as ie,b7 as ce,cz as ge,b8 as le,ba as M,aN as je,cA as Fe,cB as Oe,I as Se,ar as $e,aM as Re,cC as Ct,cD as U,bc as W,cE as St,cF as It,cG as Pt,cH as Dt,cI as zt,cJ as Et,cK as Tt,S as At,b2 as Lt,cL as _t,cM as Mt,bb as Ft,X as Ot}from"./index-BO31ZqPg.js";import{u as $t,P as Rt,a as Bt,C as Kt,b as Ht}from"./useReadmeHelp-Dp5zdwnQ.js";import{U as Be}from"./upload-Cw5zcpJ-.js";const Vt=[["path",{d:"M12 13v8l-4-4",key:"1f5nwf"}],["path",{d:"m12 21 4-4",key:"1lfcce"}],["path",{d:"M4.393 15.269A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.436 8.284",key:"ui1hmy"}]],Ie=se("cloud-download",Vt);const Jt=[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]],qt=se("ellipsis-vertical",Jt);const Ut=[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]],Wt=se("folder-open",Ut);const Gt=[["path",{d:"M2 7.5V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-1.5",key:"1yk7aj"}],["path",{d:"M2 13h10",key:"pgb2dq"}],["path",{d:"m5 10-3 3 3 3",key:"1r8ie0"}]],Zt=se("folder-output",Gt);const Yt=[["path",{d:"M9 20H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v.5",key:"1dkoa9"}],["path",{d:"M12 10v4h4",key:"1czhmt"}],["path",{d:"m12 14 1.535-1.605a5 5 0 0 1 8 1.5",key:"lvuxfi"}],["path",{d:"M22 22v-4h-4",key:"1ewp4q"}],["path",{d:"m22 18-1.535 1.605a5 5 0 0 1-8-1.5",key:"14ync0"}]],Qt=se("folder-sync",Yt);const Xt=[["rect",{width:"18",height:"7",x:"3",y:"3",rx:"1",key:"f1a2em"}],["rect",{width:"9",height:"7",x:"3",y:"14",rx:"1",key:"jqznyg"}],["rect",{width:"5",height:"7",x:"16",y:"14",rx:"1",key:"q5h2i8"}]],Ke=se("layout-template",Xt);async function es(r){const t=await Ge.loadAsync(r);for(const m of Object.keys(t.files)){const a=m.split("/");if(a.length===1&&a[0]==="project.json"||a.length===2&&a[1]==="project.json")return JSON.parse(await t.files[m].async("text"))}throw new Error("NO_PROJECT_JSON")}async function ts(r,t){const m=typeof t=="function"?{onProgress:t}:t??{},a=m.mode??"new",u=m.onProgress,f=await Ge.loadAsync(r);let N=null,y="";for(const c of Object.keys(f.files)){const d=c.split("/");if(d.length===1&&d[0]==="project.json"){N=JSON.parse(await f.files[c].async("text")),y="";break}if(d.length===2&&d[1]==="project.json"){N=JSON.parse(await f.files[c].async("text")),y=d[0]+"/";break}}if(!N)throw new Error("NO_PROJECT_JSON");const C=N,E=[];for(const c of Object.keys(f.files)){if(f.files[c].dir||!c.startsWith(y))continue;const x=c.slice(y.length).split("/");if(x.length===1){const D=x[0];D.startsWith("doc_")&&D.endsWith(".json")&&E.push(c);continue}if(x.length!==2)continue;const k=x[1];k.endsWith(".json")&&(k.endsWith(".dialogue.json")||k.endsWith(".level.json")||E.push(c))}const v=[];for(const c of E){const d=await f.files[c].async("text");v.push(JSON.parse(d))}if(a==="overwrite"){ot(C.id),await A.projects.get(C.id)&&await A.documents.where("projectId").equals(C.id).delete();const d=ze(),x={...C,updatedAt:d};await A.projects.put(x);const k=v.length;for(let D=0;D<k;D++)await A.documents.put(v[D]),u?.((D+1)/k);return{project:x,documentCount:k}}const j=we(),S=ze(),P=new Map;P.set(C.id,j);for(const c of v)P.set(c.id,we());const B=(await A.projects.toArray()).map(c=>c.name),Q=ye(C.name,B),K={...C,id:j,name:Q,createdAt:S,updatedAt:S};await A.projects.put(K);const F=v.length;for(let c=0;c<F;c++){const d=v[c],x={...d,id:P.get(d.id)??we(),projectId:j,parentId:d.parentId?P.get(d.parentId)??null:null};await A.documents.put(x),u?.((c+1)/F)}return{project:K,documentCount:F}}const ss="AIzaSyA47mv5YA1sndWqLc8oOKdJKShhjv4UPkg",as="165461889032-4e64coe3j5clrhm0rmf4lutd1b8a2lti.apps.googleusercontent.com",ns=as?.split("-")[0]??"";let be=!1;function os(){return be?Promise.resolve():new Promise((r,t)=>{const m=window;if(m.gapi){m.gapi.load("picker",()=>{be=!0,r()});return}const a=document.createElement("script");a.src="https://apis.google.com/js/api.js",a.async=!0,a.defer=!0,a.onload=()=>{window.gapi.load("picker",()=>{be=!0,r()})},a.onerror=()=>t(new Error("Failed to load Google API script")),document.head.appendChild(a)})}async function He(r){await os();const t=window.google;return new Promise(m=>{const a=new t.picker.DocsView(t.picker.ViewId.FOLDERS);a.setIncludeFolders(!0),a.setSelectFolderEnabled(!0),a.setMimeTypes("application/vnd.google-apps.folder"),a.setParent("root"),new t.picker.PickerBuilder().setOAuthToken(r).setDeveloperKey(ss).setAppId(ns).addView(a).setCallback(f=>{if(f.action===t.picker.Action.PICKED){const N=f.docs[0];m({folderId:N.id,folderName:N.name})}else f.action===t.picker.Action.CANCEL&&m(null)}).setTitle("Select Backup Folder").build().setVisible(!0)})}function rs({open:r,onOpenChange:t,onRestored:m}){const a=Pe(),u=Ze(),{isSignedIn:f,gsiReady:N,initGsi:y,signIn:C,accessToken:E}=Ye(),[v,j]=h.useState(!1),[S,P]=h.useState([]),[B,Q]=h.useState(new Set),[K,F]=h.useState(!1),[c,d]=h.useState(null),[x,k]=h.useState(null),[D,_]=h.useState([]),[O,$]=h.useState(!1),[ae,H]=h.useState(null),[ne,V]=h.useState(null),[oe,R]=h.useState([]);h.useEffect(()=>{if(r){if(F(!1),P([]),k(null),_([]),H(null),V(null),R([]),!f){j(!1);return}j(!0),(async()=>{try{const o=await rt();let s=null;if(o?(s=o.folderId,V(o.folderName)):s=await it(),!s){F(!0),j(!1);return}H(s),Ee(s).then(l=>{R(l),!o&&l.length>0&&V(l[l.length-1])}).catch(()=>{});const i=await A.projects.toArray();Q(new Set(i.map(l=>l.id)));const p=await Te(s);P(p)}catch{}finally{j(!1)}})()}},[r,f]);async function J(){N||await y(),C()}async function de(o){k(o),await X(o)}async function X(o){$(!0);try{const s=await Ae(o.folderId);return _(s),s}catch{return _([]),[]}finally{$(!1)}}async function me(o,s){const i=B.has(o);if(await u({title:a("import.restoreConfirm"),description:i?a("import.restoreOverwrite"):void 0,variant:i?"destructive":"default"})){d({type:"restore",status:"processing",progress:0});try{const l=await ht(s,L=>{d(z=>z&&{...z,progress:L})});d({type:"restore",status:"done",progress:1,errorMessage:a("import.docCount",{n:String(l.documentCount)})})}catch(l){d({type:"restore",status:"error",errorMessage:l instanceof Error?l.message:String(l)})}}}function ue(){const o=c?.status==="done";d(null),o&&(t(!1),m())}async function xe(o,s){if(o.stopPropagation(),!!await u({title:a("versionHistory.deleteTitle"),description:new Date(s.timestamp).toLocaleString(),variant:"destructive"}))try{await Le(s.fileId),_(p=>p.filter(l=>l.fileId!==s.fileId)),x&&P(p=>p.map(l=>l.projectId===x.projectId?{...l,versionCount:l.versionCount-1}:l).filter(l=>l.versionCount>0))}catch{}}function pe(){k(null),_([])}async function he(){if(!(!E||!x))try{const o=await He(E);if(!o)return;const{folderId:s,folderName:i}=o;if(!await u({title:a("drive.moveProjectConfirm"),description:a("drive.moveProjectDesc",{project:x.projectName,folder:i}),variant:"default"}))return;d({type:"move",status:"processing",progress:0});const l=await ut(s,x.projectName+"_"+x.projectId),L=await Ae(x.folderId),z=L.length;let re=0;for(const Ne of L)await xt(Ne.fileId,l),re++,d(ee=>ee&&{...ee,progress:re/z});await Le(x.folderId),d({type:"move",status:"done",progress:1})}catch(o){d({type:"move",status:"error",errorMessage:o instanceof Error?o.message:String(o)})}}async function fe(o){j(!0);try{const s=await A.projects.toArray();Q(new Set(s.map(p=>p.id)));const i=await Te(o);P(i),F(!1)}catch{}finally{j(!1)}}async function n(){if(E)try{const o=await He(E);if(!o)return;const{folderId:s,folderName:i}=o;if(s===ae)return;await pt({folderId:s,folderName:i}),nt.setState({folderId:s}),H(s),V(i),Ee(s).then(R).catch(()=>{}),await fe(s)}catch{}}function g(){const o=c?.status==="done";d(null),o&&ae&&(k(null),_([]),fe(ae))}const w=x?x.projectName:a("import.driveRestore"),b=oe.length>0?oe.join(" > "):void 0;return e.jsxs(e.Fragment,{children:[e.jsx(Qe,{open:r&&!c,onOpenChange:t,children:e.jsxs(Xe,{className:"max-w-md max-h-[80vh] flex flex-col",children:[e.jsxs(et,{children:[e.jsx(tt,{className:"flex items-center gap-2",children:x?e.jsxs(e.Fragment,{children:[e.jsx(T,{variant:"ghost",size:"icon",className:"size-6 shrink-0",onClick:pe,children:e.jsx(ct,{className:"size-4"})}),e.jsx("span",{className:"truncate",children:w}),e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx("button",{className:"inline-flex items-center gap-1 rounded p-1 text-muted-foreground hover:text-foreground hover:bg-accent shrink-0",onClick:he,children:e.jsx(Zt,{className:"size-3.5"})})}),e.jsx(Y,{side:"bottom",children:a("drive.moveProject")})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ie,{className:"size-5 shrink-0"}),e.jsx("span",{className:"truncate",children:w}),f&&!v&&e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsxs("button",{className:"inline-flex items-center gap-1 rounded px-1.5 py-0.5 text-xs font-normal text-muted-foreground hover:text-foreground hover:bg-accent shrink-0",onClick:n,children:[e.jsx(Qt,{className:"size-3.5"}),ne&&e.jsx("span",{className:"max-w-[100px] truncate",children:ne})]})}),e.jsx(Y,{side:"bottom",children:b??a("drive.selectFolder")})]})]})}),x&&e.jsx("p",{className:"text-xs text-muted-foreground pl-8",children:a("import.selectVersion")})]}),e.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto",children:[!f&&e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 py-12",children:[e.jsx(lt,{className:"size-10 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a("drive.signInRequired")}),e.jsx(T,{onClick:J,children:a("drive.signInGoogle")})]}),f&&!x&&e.jsxs(e.Fragment,{children:[v&&e.jsxs("div",{className:"flex items-center justify-center gap-2 py-8 text-muted-foreground",children:[e.jsx(Ce,{className:"size-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:a("import.driveLoading")})]}),!v&&K&&e.jsx("p",{className:"py-8 text-center text-sm text-muted-foreground",children:a("import.driveNoFolder")}),!v&&!K&&S.length===0&&e.jsx("p",{className:"py-8 text-center text-sm text-muted-foreground",children:a("import.driveEmpty")}),!v&&S.length>0&&e.jsx("div",{className:"flex flex-col gap-1",children:S.map(o=>e.jsx("button",{className:"flex w-full items-center gap-3 rounded-lg border px-3 py-2.5 text-left text-sm transition-colors hover:bg-accent/50",onClick:()=>de(o),children:e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"truncate font-medium",children:o.projectName}),B.has(o.projectId)&&e.jsxs(ke,{variant:"secondary",className:"shrink-0 gap-1 text-[10px] px-1.5 py-0",children:[e.jsx(dt,{className:"size-3"}),a("import.localExists")]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:new Date(o.latestUpdatedAt).toLocaleString()}),e.jsx(ke,{variant:"outline",className:"text-[10px] px-1.5 py-0",children:a("import.versionCount",{n:String(o.versionCount)})})]})]})},o.projectId))})]}),x&&e.jsxs(e.Fragment,{children:[O&&e.jsxs("div",{className:"flex items-center justify-center gap-2 py-8 text-muted-foreground",children:[e.jsx(Ce,{className:"size-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:a("common.loading")})]}),!O&&D.length===0&&e.jsx("p",{className:"py-8 text-center text-sm text-muted-foreground",children:a("import.driveEmpty")}),!O&&D.length>0&&e.jsx("div",{className:"flex flex-col gap-1",children:D.map((o,s)=>e.jsxs("div",{className:"flex w-full items-center gap-3 rounded-lg border px-3 py-2.5 text-left text-sm transition-colors hover:bg-accent/50",children:[e.jsxs("button",{className:"flex min-w-0 flex-1 items-center gap-3",onClick:()=>me(x.projectId,o.fileId),children:[e.jsx(mt,{className:"size-4 shrink-0 text-muted-foreground"}),e.jsx("div",{className:"min-w-0 flex-1",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm",children:[a("import.backupTime"),":"," ",new Date(o.timestamp).toLocaleString()]}),s===0&&e.jsx(ke,{className:"shrink-0 text-[10px] px-1.5 py-0",children:a("import.latestVersion")})]})})]}),e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx("button",{className:"shrink-0 rounded p-1 text-muted-foreground hover:bg-destructive/10 hover:text-destructive",onClick:i=>xe(i,o),children:e.jsx(st,{className:"size-3.5"})})}),e.jsx(Y,{side:"left",children:a("versionHistory.delete")})]})]},o.fileId))})]})]})]})}),c&&e.jsx(at,{status:c.status,processingText:c.type==="move"?a("drive.moving"):a("import.restoring"),doneText:c.type==="move"?a("drive.moveDone"):a("import.restoreDone"),errorText:c.type==="move"?a("drive.moveError"):a("import.restoreError"),errorMessage:c.status==="done"||c.status==="error"?c.errorMessage:void 0,progress:c.progress,onClose:c.type==="move"?g:ue})]})}const Ve="excalibur_install_dismissed";function is(){const[r,t]=h.useState(null),[m,a]=h.useState(()=>{try{const y=Number(window.localStorage.getItem(Ve));return y>0&&Date.now()-y<10080*60*1e3}catch{return!1}}),u=window.matchMedia("(display-mode: standalone)").matches||navigator.standalone===!0;h.useEffect(()=>{if(u||m)return;function y(C){C.preventDefault(),t(C)}return window.addEventListener("beforeinstallprompt",y),()=>window.removeEventListener("beforeinstallprompt",y)},[u,m]),h.useEffect(()=>{function y(){t(null)}return window.addEventListener("appinstalled",y),()=>window.removeEventListener("appinstalled",y)},[]);const f=h.useCallback(async()=>{if(!r)return;await r.prompt();const{outcome:y}=await r.userChoice;y==="accepted"&&t(null)},[r]),N=h.useCallback(()=>{t(null),a(!0);try{window.localStorage.setItem(Ve,String(Date.now()))}catch{}},[]);return{canInstall:!!r&&!m&&!u,install:f,dismiss:N}}const ve=new Map;function cs(r){return ve.has(r)||ve.set(r,fetch(`/Excalibur/${r}`).then(t=>{if(!t.ok)throw new Error(`Failed to fetch ${r}: ${t.status}`);return t.text()}).catch(t=>{throw ve.delete(r),t})),ve.get(r)}function ls(r){const[t,m]=h.useState(""),[a,u]=h.useState(!0);return h.useEffect(()=>{let f=!1;return cs(r).then(N=>{f||(m(ft.parse(N)),u(!1))}).catch(()=>{f||u(!1)}),()=>{f=!0}},[r]),{html:t,loading:a}}function Je({className:r="",textClass:t="text-3xl",svgClass:m="h-32"}){const u=`ec-m-${h.useId().replace(/:/g,"")}`;return e.jsxs("div",{className:`relative ${r}`,children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 z-[45] flex items-center justify-center",children:e.jsxs("svg",{viewBox:"584 235 880 1160",xmlns:"http://www.w3.org/2000/svg",className:`${m} w-auto`,overflow:"visible","aria-hidden":"true",children:[e.jsx("defs",{children:e.jsxs("mask",{id:u,children:[e.jsx("rect",{x:"0",y:"-1000",width:"3000",height:"4000",fill:"white"}),e.jsx("path",{d:gt,fill:"black"})]})}),e.jsx("g",{mask:`url(#${u})`,children:e.jsx("g",{className:"ec-sword-pull",children:e.jsx("path",{d:jt,fill:"currentColor",fillRule:"evenodd"})})}),e.jsx("g",{className:"ec-crack-fade",children:e.jsx("path",{d:vt,fill:"currentColor",fillRule:"evenodd"})})]})}),e.jsx("div",{className:"ec-block-bg pointer-events-none fixed inset-0 z-40 bg-background"}),e.jsx("div",{className:"ec-block-left pointer-events-none fixed inset-y-0 left-0 right-1/2 z-50 bg-white mix-blend-difference"}),e.jsx("div",{className:"ec-block-right pointer-events-none fixed inset-y-0 left-1/2 right-0 z-50 bg-white mix-blend-difference"}),e.jsxs("h1",{className:`relative z-[45] grid grid-cols-[1fr_auto_1fr] items-center font-bold text-foreground ${t}`,children:[e.jsx("div",{className:"justify-self-end overflow-hidden",children:e.jsx("span",{className:"ec-text-left block",children:"Exca"})}),e.jsx("span",{className:"ec-text-center opacity-0",children:"l"}),e.jsx("div",{className:"justify-self-start overflow-hidden",children:e.jsx("span",{className:"ec-text-right block",children:"ibur"})})]})]})}function ps(){const r=wt(),t=Pe(),m=Ze(),a=yt(),{projects:u,loading:f,load:N,create:y,remove:C,update:E}=Nt(),v=nt(n=>n.syncProject),{theme:j,toggle:S}=kt(),{locale:P,setLocale:B}=bt(),{isSignedIn:Q,gsiReady:K,initGsi:F,signIn:c}=Ye(),[d,x]=h.useState(""),[k,D]=h.useState(""),_=h.useRef(null),[O,$]=h.useState(null),[ae,H]=h.useState(!1),{canInstall:ne,install:V,dismiss:oe}=is(),[R,J]=h.useState(null);h.useEffect(()=>{N()},[N]);const de=h.useMemo(()=>{if(!k.trim())return u;const n=k.trim().toLowerCase();return u.filter(g=>g.name.toLowerCase().includes(n))},[u,k]);async function X(){const n=d.trim();if(!n)return;const g=await y(ye(n,u.map(w=>w.name)));x(""),r(`/project/${g.id}/gdd`)}async function me(){const n=d.trim();if(!n)return;const g=await y(ye(n,u.map(s=>s.name)));x("");const w=t,b=[];for(const s of Ct){const i=U(g.id,"gdd",t(s.labelKey));i.content=s.create(w),await W.saveDocument(i)}for(const s of St){const i=s.id==="ai-fsm"?"statemachine":"flowchart",p=U(g.id,i,t(s.labelKey)),{nodes:l,edges:L}=s.create(w),z=It(l,L);p.nodes=z.nodes,p.edges=z.edges,p.updatedAt=Date.now(),await W.saveDocument(p)}for(const s of Pt){const i=U(g.id,"dialogue",t(s.labelKey)),{nodes:p,edges:l,characters:L}=s.create(w),z=`dialogue.${s.id.replace(/-/g,"_")}`;let re=0,Ne=0;for(const ee of p){const I=ee.data;if(I.dialogueType==="text"&&I.textPreview&&!I.textKey){const te=`${z}.text_${++re}`;I.textKey=te,b.push({key:te,value:String(I.textPreview),category:"dialogue",status:"draft",updatedAt:Date.now()})}if(I.dialogueType==="choice"){if(I.prompt&&!I.promptKey){const q=`${z}.prompt_${re+1}`;I.promptKey=q,b.push({key:q,value:String(I.prompt),category:"dialogue",status:"draft",updatedAt:Date.now()})}const te=I.options??[];for(const q of te)if(q.textPreview&&!q.textKey){const De=`${z}.opt_${++Ne}`;q.textKey=De,b.push({key:De,value:String(q.textPreview),category:"dialogue",status:"draft",updatedAt:Date.now()})}}if(I.dialogueType==="entry"&&I.description){const te=`${z}.entry_${I.entryId??ee.id}`;b.push({key:te,value:String(I.description),category:"dialogue",status:"draft",updatedAt:Date.now()})}}i.nodes=p,i.edges=l,i.metadata={...i.metadata,characters:L},i.updatedAt=Date.now(),await W.saveDocument(i)}for(const s of Dt){const i=U(g.id,"datatable",s.name),p=Array.from({length:3},()=>{const l={};for(const L of s.schema.columns)l[L.id]=L.defaultValue??null;return{id:we(),cells:l}});i.schema=s.schema,i.rows=p,i.metadata={...i.metadata,category:s.category},i.updatedAt=Date.now(),await W.saveDocument(i)}for(const s of zt){const i=U(g.id,"level",t(s.labelKey)),{nodes:p,edges:l}=s.create(w);i.nodes=p,i.edges=l,i.updatedAt=Date.now(),await W.saveDocument(i)}await W.saveDocument(U(g.id,"asset-registry",t("nav.assets")));const o=U(g.id,"i18n",t("nav.i18n"));b.length>0&&(o.entries=b,o.updatedAt=Date.now()),await W.saveDocument(o),r(`/project/${g.id}/gdd`)}async function ue(n){await m({title:t("home.deleteConfirm"),variant:"destructive"})&&await C(n)}async function xe(n){const g=await a({title:t("home.rename"),placeholder:t("home.renamePrompt"),defaultValue:n.name});if(!g||g===n.name)return;const w=await A.projects.get(n.id);if(!w)return;const b=u.filter(s=>s.id!==n.id).map(s=>s.name),o=ye(g,b);await E({...w,name:o,updatedAt:Date.now()}),N()}async function pe(n){if(!Q){K||await F(),c();return}await v(n)}async function he(n){const g=await A.projects.get(n.id);if(!g)return;const w=await A.documents.where("projectId").equals(n.id).toArray(),b=await Et(g,w),o=URL.createObjectURL(b),s=document.createElement("a");s.href=o,s.download=Tt(n.name,Date.now()),s.click(),URL.revokeObjectURL(o)}async function fe(n){const g=n.target.files?.[0];if(g){n.target.value="";try{const w=await es(g),b=u.find(p=>p.id===w.id),o=!b&&u.find(p=>p.name===w.name),s=b??o;let i="new";if(s){const p=await m({title:t("import.duplicateTitle"),description:t("import.duplicateDesc",{name:s.name}),confirmLabel:t("import.overwrite"),secondaryText:t("import.importAsNew"),variant:"destructive"});if(p===!1)return;i=p===!0?"overwrite":"new"}$({status:"processing",progress:0}),await ts(g,{mode:i,onProgress:p=>{$(l=>l&&{...l,progress:p})}}),$({status:"done",progress:1}),N()}catch(w){const b=w instanceof Error&&w.message==="NO_PROJECT_JSON"?t("import.noProjectJson"):w instanceof Error?w.message:String(w);$({status:"error",errorMessage:b})}}}return e.jsxs("div",{className:"flex h-full isolate bg-background",children:[e.jsxs("div",{className:"hidden h-full w-full md:flex",children:[e.jsxs("div",{className:"ec-sidebar-enter flex w-80 shrink-0 flex-col border-r",children:[e.jsxs("div",{className:"flex min-h-0 flex-1 flex-col p-4",children:[e.jsx("h2",{className:"mb-3 shrink-0 text-sm font-semibold text-muted-foreground",children:t("nav.projectList")}),e.jsx(qe,{search:k,onSearchChange:D,loading:f,filtered:de,totalCount:u.length,onOpen:n=>r(`/project/${n}/gdd`),onDelete:ue,onRename:xe,onBackup:pe,onDownload:he,t})]}),e.jsx(_e,{}),e.jsxs("div",{className:"flex shrink-0 items-center justify-between px-4 py-2",children:[e.jsx(Me,{}),e.jsxs("div",{className:"flex gap-0.5",children:[e.jsxs(ie,{children:[e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(ce,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"icon",className:"size-6",children:e.jsx("span",{className:"text-[10px] font-medium",children:ge.find(n=>n.value===P)?.short})})})}),e.jsx(Y,{side:"top",children:t("toolbar.language")})]}),e.jsx(le,{side:"top",align:"end",children:ge.map(n=>e.jsx(M,{onClick:()=>B(n.value),className:je(P===n.value&&"bg-accent"),children:n.label},n.value))})]}),e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"icon",className:"size-6",onClick:S,children:j==="dark"?e.jsx(Fe,{className:"size-3"}):e.jsx(Oe,{className:"size-3"})})}),e.jsx(Y,{side:"top",children:t("toolbar.theme")})]})]})]})]}),e.jsxs("div",{className:"flex flex-1 flex-col items-center px-8",children:[e.jsxs("div",{className:"flex flex-1 flex-col items-center justify-center gap-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx(Je,{textClass:"text-3xl",svgClass:"h-32"}),e.jsx("p",{className:"ec-subtitle mt-2 text-muted-foreground",children:t("home.subtitle")})]}),e.jsxs("div",{className:"ec-subtitle relative w-full max-w-xs",children:[e.jsx(Se,{className:"pr-10",placeholder:t("home.projectName"),value:d,onChange:n=>x(n.target.value),onKeyDown:n=>n.key==="Enter"&&X()}),e.jsxs(ie,{children:[e.jsx(ce,{asChild:!0,children:e.jsx("button",{className:je("absolute right-1 top-1/2 flex size-7 -translate-y-1/2 items-center justify-center rounded-md transition-colors",d.trim()?"bg-primary text-primary-foreground hover:bg-primary/90":"text-muted-foreground/40"),disabled:!d.trim(),children:e.jsx($e,{className:"size-4"})})}),e.jsxs(le,{align:"end",children:[e.jsxs(M,{onClick:X,children:[e.jsx(Re,{className:"mr-2 size-4"}),t("home.createEmpty")]}),e.jsxs(M,{onClick:me,children:[e.jsx(Ke,{className:"mr-2 size-4"}),t("home.createTemplate")]})]})]})]}),e.jsxs("div",{className:"ec-subtitle flex w-full max-w-xs items-center gap-2",children:[e.jsx("input",{ref:_,type:"file",accept:".zip",className:"hidden",onChange:fe}),e.jsxs(T,{variant:"outline",size:"sm",className:"flex-1 gap-1.5",onClick:()=>_.current?.click(),children:[e.jsx(Be,{className:"size-3.5"}),t("import.fromZip")]}),e.jsxs(T,{variant:"outline",size:"sm",className:"flex-1 gap-1.5",onClick:()=>H(!0),children:[e.jsx(Ie,{className:"size-3.5"}),t("import.fromDrive")]}),e.jsx(We,{})]}),ne&&e.jsx("div",{className:"ec-subtitle",children:e.jsx(Ue,{onInstall:V,onDismiss:oe})})]}),e.jsxs("p",{className:"shrink-0 pb-3 text-[11px] text-muted-foreground",children:[e.jsx("button",{className:"underline hover:text-foreground",onClick:()=>J("privacy"),children:t("home.privacyPolicy")})," | ",e.jsx("button",{className:"underline hover:text-foreground",onClick:()=>J("terms"),children:t("home.termsOfService")})]})]})]}),e.jsxs("div",{className:"flex h-full w-full flex-col md:hidden",children:[e.jsxs("div",{className:"shrink-0 px-4 pt-44 pb-4 text-center",children:[e.jsx(Je,{textClass:"text-2xl",svgClass:"h-24"}),e.jsx("p",{className:"ec-subtitle mt-1 text-sm text-muted-foreground",children:t("home.subtitle")}),e.jsxs("div",{className:"ec-subtitle relative mx-auto mt-4 max-w-xs",children:[e.jsx(Se,{className:"pr-10",placeholder:t("home.projectName"),value:d,onChange:n=>x(n.target.value),onKeyDown:n=>n.key==="Enter"&&X()}),e.jsxs(ie,{children:[e.jsx(ce,{asChild:!0,children:e.jsx("button",{className:je("absolute right-1 top-1/2 flex size-7 -translate-y-1/2 items-center justify-center rounded-md transition-colors",d.trim()?"bg-primary text-primary-foreground hover:bg-primary/90":"text-muted-foreground/40"),disabled:!d.trim(),children:e.jsx($e,{className:"size-4"})})}),e.jsxs(le,{align:"end",children:[e.jsxs(M,{onClick:X,children:[e.jsx(Re,{className:"mr-2 size-4"}),t("home.createEmpty")]}),e.jsxs(M,{onClick:me,children:[e.jsx(Ke,{className:"mr-2 size-4"}),t("home.createTemplate")]})]})]})]}),e.jsxs("div",{className:"ec-subtitle mx-auto mt-3 flex w-full max-w-xs items-center gap-2",children:[e.jsxs(T,{variant:"outline",size:"sm",className:"flex-1 gap-1.5",onClick:()=>_.current?.click(),children:[e.jsx(Be,{className:"size-3.5"}),t("import.fromZip")]}),e.jsxs(T,{variant:"outline",size:"sm",className:"flex-1 gap-1.5",onClick:()=>H(!0),children:[e.jsx(Ie,{className:"size-3.5"}),t("import.fromDrive")]}),e.jsx(We,{})]}),ne&&e.jsx("div",{className:"ec-subtitle",children:e.jsx(Ue,{onInstall:V,onDismiss:oe})})]}),e.jsx("div",{className:"ec-subtitle flex min-h-0 flex-1 flex-col items-center px-4 pb-2",children:e.jsx("div",{className:"flex min-h-0 w-full max-w-xs flex-1 flex-col",children:e.jsx(qe,{search:k,onSearchChange:D,loading:f,filtered:de,totalCount:u.length,onOpen:n=>r(`/project/${n}/gdd`),onDelete:ue,onRename:xe,onBackup:pe,onDownload:he,t})})}),e.jsxs("div",{className:"ec-subtitle",children:[e.jsx(_e,{}),e.jsxs("div",{className:"flex shrink-0 flex-col gap-1 px-4 py-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Me,{}),e.jsxs("div",{className:"flex gap-0.5",children:[e.jsxs(ie,{children:[e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(ce,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"icon",className:"size-6",children:e.jsx("span",{className:"text-[10px] font-medium",children:ge.find(n=>n.value===P)?.short})})})}),e.jsx(Y,{side:"top",children:t("toolbar.language")})]}),e.jsx(le,{side:"top",align:"end",children:ge.map(n=>e.jsx(M,{onClick:()=>B(n.value),className:je(P===n.value&&"bg-accent"),children:n.label},n.value))})]}),e.jsxs(G,{children:[e.jsx(Z,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"icon",className:"size-6",onClick:S,children:j==="dark"?e.jsx(Fe,{className:"size-3"}):e.jsx(Oe,{className:"size-3"})})}),e.jsx(Y,{side:"top",children:t("toolbar.theme")})]})]})]}),e.jsxs("p",{className:"text-center text-[11px] text-muted-foreground",children:[e.jsx("button",{className:"underline hover:text-foreground",onClick:()=>J("privacy"),children:t("home.privacyPolicy")})," | ",e.jsx("button",{className:"underline hover:text-foreground",onClick:()=>J("terms"),children:t("home.termsOfService")})]})]})]})]}),O&&e.jsx(at,{status:O.status,processingText:t("import.importing"),doneText:t("import.importDone"),errorText:t("import.importError"),errorMessage:O.errorMessage,progress:O.progress,onClose:()=>$(null)}),e.jsx(rs,{open:ae,onOpenChange:H,onRestored:N}),e.jsx(Qe,{open:!!R,onOpenChange:n=>{n||J(null)},children:e.jsxs(Xe,{className:"max-h-[80vh] overflow-y-auto sm:max-w-lg",children:[e.jsx(et,{children:e.jsx(tt,{children:t(R==="privacy"?"home.privacyPolicy":"home.termsOfService")})}),R&&e.jsx(ds,{file:`${R}.md`})]})})]})}function qe({search:r,onSearchChange:t,loading:m,filtered:a,totalCount:u,onOpen:f,onDelete:N,onRename:y,onBackup:C,onDownload:E,t:v}){return e.jsxs("div",{className:"flex min-h-0 flex-1 flex-col",children:[e.jsxs("div",{className:"relative mb-3 shrink-0",children:[e.jsx(At,{className:"pointer-events-none absolute left-2.5 top-1/2 size-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(Se,{className:"pl-9",placeholder:v("table.search"),value:r,onChange:j=>t(j.target.value)})]}),m?e.jsx("p",{className:"py-8 text-center text-sm text-muted-foreground",children:v("common.loading")}):a.length===0?e.jsx("p",{className:"py-8 text-center text-sm text-muted-foreground",children:v(u===0?"home.noProjects":"doc.noMatch")}):e.jsx("div",{className:"flex min-h-0 flex-1 flex-col gap-1 overflow-y-auto pb-4",children:a.map(j=>e.jsxs("button",{className:"group flex w-full shrink-0 items-center gap-2 rounded-lg border px-3 py-2.5 text-left text-sm transition-colors hover:bg-accent/50",onClick:()=>f(j.id),children:[e.jsx(Wt,{className:"size-4 shrink-0 text-muted-foreground"}),e.jsx("span",{className:"min-w-0 flex-1 truncate",children:j.name}),e.jsx("span",{className:"hidden text-xs text-muted-foreground sm:inline",children:new Date(j.updatedAt).toLocaleDateString()}),e.jsxs(ie,{children:[e.jsx(ce,{asChild:!0,children:e.jsx("div",{role:"button",tabIndex:0,className:"shrink-0 rounded p-1 text-muted-foreground opacity-100 hover:bg-accent md:opacity-0 md:group-hover:opacity-100",onClick:S=>S.stopPropagation(),onKeyDown:S=>{S.key==="Enter"&&S.stopPropagation()},children:e.jsx(qt,{className:"size-4"})})}),e.jsxs(le,{align:"end",onClick:S=>S.stopPropagation(),children:[e.jsxs(M,{onClick:()=>y(j),children:[e.jsx(Lt,{className:"mr-2 size-4"}),v("home.rename")]}),e.jsxs(M,{onClick:()=>C(j.id),children:[e.jsx(_t,{className:"mr-2 size-4"}),v("home.backupToCloud")]}),e.jsxs(M,{onClick:()=>E(j),children:[e.jsx(Mt,{className:"mr-2 size-4"}),v("home.downloadBackup")]}),e.jsx(Ft,{}),e.jsxs(M,{className:"text-destructive",onClick:()=>N(j.id),children:[e.jsx(st,{className:"mr-2 size-4"}),v("home.delete")]})]})]})]},j.id))})]})}function Ue({onInstall:r,onDismiss:t}){const m=Pe();return e.jsxs("div",{className:"mt-2 flex w-full max-w-xs items-center gap-3 rounded-lg border bg-accent/30 px-3 py-2.5",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs font-medium",children:m("pwa.installTitle")}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:m("pwa.installDesc")})]}),e.jsx(T,{size:"sm",className:"shrink-0 h-7 text-xs px-3",onClick:r,children:m("pwa.installButton")}),e.jsx("button",{className:"shrink-0 text-muted-foreground hover:text-foreground",onClick:t,children:e.jsx(Ot,{className:"size-3.5"})})]})}function We(){const{html:r,loading:t}=$t("雲端備份與還原");return e.jsxs(Rt,{children:[e.jsx(Bt,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"icon",className:"size-8 shrink-0",children:e.jsx(Kt,{className:"size-3.5 text-muted-foreground"})})}),e.jsx(Ht,{side:"top",align:"center",className:"max-h-80 w-80 max-w-[calc(100vw-2rem)] overflow-y-auto text-xs leading-relaxed",children:t?e.jsx(Ce,{className:"size-4 animate-spin mx-auto"}):e.jsx("div",{className:"prose prose-xs dark:prose-invert max-w-none",dangerouslySetInnerHTML:{__html:r}})})]})}function ds({file:r}){const{html:t,loading:m}=ls(r);return m?e.jsx("p",{className:"py-4 text-center text-sm text-muted-foreground",children:"Loading…"}):e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none",dangerouslySetInnerHTML:{__html:t}})}export{ps as default};
